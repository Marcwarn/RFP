<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elisa RFP Evaluator - Doings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1E3A5F 0%, #0891B2 100%); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .score-ring { stroke-dasharray: 283; transform: rotate(-90deg); transform-origin: 50% 50%; }
        textarea:focus { outline: none; box-shadow: 0 0 0 2px #0891B2; }
        @media print { .no-print { display: none !important; } }
        .modal-backdrop { background: rgba(0,0,0,0.5); }
        .highlight { background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%); padding: 0 4px; border-radius: 3px; }
        /* Agent Cards */
        .agent-card { background: linear-gradient(135deg, #1E3A5F 0%, #0891B2 100%); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .agent-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(8, 145, 178, 0.3); border-color: #0891B2; }
        /* Insight Cards */
        .insight-card { background: #f0fdf4; border-left: 3px solid #10B981; padding: 12px; margin-bottom: 10px; border-radius: 0 8px 8px 0; }
        .insight-card.warning { background: #fefce8; border-left-color: #F59E0B; }
        .insight-card.idea { background: #eff6ff; border-left-color: #3B82F6; }
        /* Research Grid */
        .research-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .research-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s; }
        .research-item:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .research-item.selected { border-color: #0891B2; background: #ecfeff; }
        /* Tabs */
        .intel-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
        .intel-tab { padding: 8px 16px; background: #f1f5f9; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; color: #64748b; }
        .intel-tab:hover { background: #e2e8f0; }
        .intel-tab.active { background: #0891B2; color: white; }
        /* Prompt Box */
        .prompt-box { background: #1e293b; color: #e2e8f0; border-radius: 8px; padding: 12px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 250px; overflow: auto; }
        /* Knowledge Base Items */
        .kb-skill-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .kb-skill-item:hover { background: #f1f5f9; }
        .kb-skill-item.loaded { border-color: #10B981; background: #f0fdf4; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Mammoth.js for reading Word documents -->
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <!-- PDF.js for reading PDF documents -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // RFP Sections Data (English)
        const rfpSections = [
            {
                id: "3.1",
                title: "Company Information",
                requirements: [
                    "Legal name, registration details and VAT number",
                    "Brief company profile and core expertise in leadership development",
                    "Years in business and financial stability",
                    "References from comparable international leadership development programmes"
                ],
                weight: 10,
                evaluationCriteria: "Alignment with strategic objectives"
            },
            {
                id: "3.2",
                title: "Programme Design and Approach",
                requirements: [
                    "Description of the proposed programme design, delivery, and learning methodology",
                    "Alignment with Elisa's strategic objectives (faster, profitable growth)",
                    "Alignment with Coach-Challenger-Connector model",
                    "Approach to supporting behavioural change and application of learning at work",
                    "Customisation for different leadership levels (First-line, Mid-level, VP)"
                ],
                weight: 25,
                evaluationCriteria: "Alignment with strategic objectives, Pedagogical quality"
            },
            {
                id: "3.3",
                title: "Content and Delivery",
                requirements: [
                    "Overview of modules, learning objectives and expected outcomes",
                    "Delivery format (in-person, virtual or blended) and programme duration",
                    "Learning methodologies applied within the programmes",
                    "Recommended pacing and participant time commitment",
                    "Specific content for each level (First-line, Mid-level, VP)"
                ],
                weight: 20,
                evaluationCriteria: "Pedagogical quality, Participant experience"
            },
            {
                id: "3.4",
                title: "Trainer Qualifications",
                requirements: [
                    "Profiles of key trainers/facilitators with relevant experience",
                    "Certifications (ICF, etc.)",
                    "Experience with similar target groups and organisational contexts",
                    "Language capabilities of trainers (English required, Finnish/Estonian for First-line)"
                ],
                weight: 15,
                evaluationCriteria: "Expertise and experience of trainers/facilitators"
            },
            {
                id: "3.5",
                title: "Measurement and Impact",
                requirements: [
                    "Methods for evaluating learning outcomes",
                    "Approach to measuring behavioural change",
                    "Approach to measuring organisational impact",
                    "Examples of impact measurement from previous assignments"
                ],
                weight: 10,
                evaluationCriteria: "Reporting capabilities and impact measurement"
            },
            {
                id: "3.6",
                title: "Programme Delivery, Governance and Support",
                requirements: [
                    "Language options and localisation",
                    "Technical requirements for virtual/hybrid delivery",
                    "Support materials and post-programme follow-up",
                    "Change and cancellation practices",
                    "Venue/catering responsibility (specify who handles)",
                    "Project governance and account management model",
                    "Dedicated Key Account Manager",
                    "Progress reporting and risk/issue management"
                ],
                weight: 10,
                evaluationCriteria: "Quality of Key Account Management and project governance"
            },
            {
                id: "3.7",
                title: "Pricing and Commercial Terms",
                requirements: [
                    "Clear cost breakdown and pricing model",
                    "Pricing per participant and/or per training day",
                    "Optional services priced separately",
                    "Payment terms and cancellation policy",
                    "Volume discounts (if applicable)",
                    "Contract period options (1, 2, 3, 5 years)"
                ],
                weight: 10,
                evaluationCriteria: "Total cost of ownership and cost-effectiveness"
            },
            {
                id: "3.8",
                title: "Compliance and Data Protection",
                requirements: [
                    "Compliance with GDPR and applicable data protection requirements",
                    "Intellectual property and usage rights of training materials",
                    "Data processing agreement (DPA) availability",
                    "Data storage location and security measures"
                ],
                weight: 5,
                evaluationCriteria: "Compliance and risk management"
            }
        ];

        // Initial responses (English)
        // Empty initial state - no hardcoded demo data
        const emptyResponses = {
            "3.1": "",
            "3.2": "",
            "3.3": "",
            "3.4": "",
            "3.5": "",
            "3.6": "",
            "3.7": "",
            "3.8": ""
        };

        // Load responses from localStorage or use empty
        const initialResponses = (() => {
            try {
                const stored = localStorage.getItem('doings_responses');
                return stored ? JSON.parse(stored) : emptyResponses;
            } catch (e) { return emptyResponses; }
        })();

        // Text Parser - IMPROVED: extracts information from pasted text
        function parseInputText(text) {
            const extracted = {
                companyName: null,
                registrationNumber: null,
                vatNumber: null,
                foundedYear: null,
                revenue: null,
                employees: null,
                address: null,
                facilitators: [],
                prices: {
                    firstLine: null,
                    midLevel: null,
                    vp: null,
                    coaching: null,
                    translation: null
                },
                keyAccountManager: null,
                references: [],
                certifications: [],
                metrics: [],
                raw: text
            };

            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // Helper: extract value after a label on same line or next line
            function getValueAfterLabel(text, labelPatterns, valuePattern = null) {
                for (const pattern of labelPatterns) {
                    const regex = new RegExp(pattern + '[:\\s]+(.+?)(?:\\n|$)', 'im');
                    const match = text.match(regex);
                    if (match && match[1]) {
                        let val = match[1].trim();
                        if (valuePattern) {
                            const valMatch = val.match(valuePattern);
                            if (valMatch) return valMatch[1] || valMatch[0];
                        }
                        return val;
                    }
                }
                return null;
            }

            // Helper: find price near keyword
            function findPriceNear(text, keywords) {
                for (const kw of keywords) {
                    // Look for patterns like "First-line: 2500 EUR" or "2,500‚Ç¨" or "2 500 EUR"
                    const patterns = [
                        new RegExp(kw + '[^\\d]{0,30}?(\\d[\\d\\s,\\.]*\\d?)\\s*(?:EUR|‚Ç¨|eur)', 'i'),
                        new RegExp(kw + '[^\\d]{0,30}?(\\d+)\\s*(?:EUR|‚Ç¨|eur)', 'i'),
                        new RegExp('(\\d[\\d\\s,\\.]*\\d?)\\s*(?:EUR|‚Ç¨|eur)[^\\n]{0,20}' + kw, 'i')
                    ];
                    for (const p of patterns) {
                        const m = text.match(p);
                        if (m && m[1]) {
                            return m[1].replace(/\s/g, '').replace(',', '');
                        }
                    }
                }
                return null;
            }

            // === REGISTRATION NUMBER ===
            const regPatterns = [
                'org\\.?\\s*(?:nr|nummer|no)',
                'registration\\s*(?:no|number|nr)',
                'company\\s*(?:number|no|reg)',
                'f√∂retags?\\s*(?:nummer|nr)',
                'reg\\.?\\s*(?:nr|no)',
                'corp\\.?\\s*(?:id|no)'
            ];
            extracted.registrationNumber = getValueAfterLabel(text, regPatterns, /(\d{6}[\-\s]?\d{4}|\d{9,12})/);
            // Also try standalone pattern
            if (!extracted.registrationNumber) {
                const standaloneReg = text.match(/\b(\d{6}[\-]\d{4})\b/);
                if (standaloneReg) extracted.registrationNumber = standaloneReg[1];
            }

            // === VAT NUMBER ===
            const vatPatterns = ['vat\\s*(?:nr|number|no)?', 'moms\\s*(?:nr|nummer)?', 'tax\\s*(?:id|no)'];
            extracted.vatNumber = getValueAfterLabel(text, vatPatterns);
            if (!extracted.vatNumber) {
                const vatMatch = text.match(/\b(SE\d{10,12}|FI\d{8,10}|[A-Z]{2}\d{8,12})\b/i);
                if (vatMatch) extracted.vatNumber = vatMatch[1].toUpperCase();
            }

            // === FOUNDED YEAR ===
            const foundedPatterns = ['founded', 'grundat', 'established', 'since', 'sedan', 'started', '√•r'];
            extracted.foundedYear = getValueAfterLabel(text, foundedPatterns, /(\d{4})/);
            if (!extracted.foundedYear) {
                const yearMatch = text.match(/(?:since|sedan|founded|grundat|established)\s*:?\s*(\d{4})/i);
                if (yearMatch) extracted.foundedYear = yearMatch[1];
            }

            // === REVENUE ===
            const revenuePatterns = ['revenue', 'oms√§ttning', 'turnover', 'sales', 'f√∂rs√§ljning', 'int√§kter'];
            let rev = getValueAfterLabel(text, revenuePatterns);
            if (rev) {
                extracted.revenue = rev;
            } else {
                const revMatch = text.match(/([\d,\.]+)\s*(MSEK|MEUR|million|miljoner|M‚Ç¨|M SEK)/i);
                if (revMatch) extracted.revenue = revMatch[1] + ' ' + revMatch[2];
            }

            // === EMPLOYEES ===
            const empPatterns = ['employees', 'anst√§llda', 'medarbetare', 'staff', 'team size', 'personal'];
            extracted.employees = getValueAfterLabel(text, empPatterns, /(\d+)/);

            // === PRICES ===
            extracted.prices.firstLine = findPriceNear(text, ['first[\\-\\s]?line', 'f√∂rsta[\\-\\s]?linje', 'FLM', 'niv√•\\s*1', 'level\\s*1']);
            extracted.prices.midLevel = findPriceNear(text, ['mid[\\-\\s]?level', 'mellan', 'MLM', 'niv√•\\s*2', 'level\\s*2']);
            extracted.prices.vp = findPriceNear(text, ['vp', 'executive', 'senior', 'exec', 'niv√•\\s*3', 'level\\s*3', 'ledning']);
            extracted.prices.coaching = findPriceNear(text, ['coaching', 'coach', 'extra']);
            extracted.prices.translation = findPriceNear(text, ['translat', '√∂vers√§tt', 'language', 'spr√•k']);

            // === KEY ACCOUNT MANAGER ===
            const kamPatterns = ['key\\s*account\\s*manager', 'kam', 'account\\s*manager', 'kundansvarig', 'kontakt'];
            extracted.keyAccountManager = getValueAfterLabel(text, kamPatterns);
            // Clean up - remove email/phone if captured
            if (extracted.keyAccountManager) {
                extracted.keyAccountManager = extracted.keyAccountManager.split(/[,\(\<]/)[0].trim();
            }

            // === FACILITATORS / TRAINERS ===
            const facilitatorLabels = [
                /(?:facilitator|trainer|coach|utbildare|ledare|konsult)[s]?\s*[:\-]\s*(.+)/gi,
                /(?:vp\s*(?:program|programme)|senior\s*(?:lead|facilitator))[:\-]\s*(.+)/gi,
                /(?:mid[- ]?level\s*(?:lead|facilitator))[:\-]\s*(.+)/gi,
                /(?:first[- ]?line\s*(?:lead|facilitator))[:\-]\s*(.+)/gi
            ];

            lines.forEach(line => {
                facilitatorLabels.forEach(pattern => {
                    const match = line.match(pattern);
                    if (match && match[1]) {
                        const names = match[1].split(/[,;&]/).map(n => n.trim()).filter(n => {
                            // Filter: looks like a name (2+ words, starts with capital)
                            return /^[A-Z√Ö√Ñ√ñ√ú][a-z√•√§√∂√º]+\s+[A-Z√Ö√Ñ√ñ√ú]/.test(n) && n.length < 40;
                        });
                        names.forEach(name => {
                            const cleanName = name.split(/[\(\<]/)[0].trim();
                            if (cleanName && !extracted.facilitators.includes(cleanName)) {
                                extracted.facilitators.push(cleanName);
                            }
                        });
                    }
                });
            });

            // Also look for standalone names after role keywords
            const roleLines = text.match(/(?:VP|Senior|Lead|First-line|Mid-level)[^:]*:\s*([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)/gi);
            if (roleLines) {
                roleLines.forEach(rl => {
                    const nameMatch = rl.match(/:\s*([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)/i);
                    if (nameMatch && !extracted.facilitators.includes(nameMatch[1])) {
                        extracted.facilitators.push(nameMatch[1]);
                    }
                });
            }

            // === CERTIFICATIONS ===
            const certMatches = text.match(/\b(ICF[\s\-]?(?:ACC|PCC|MCC)|PCC|MCC|ACC|CPCC|CTI|NLP|MBTI|Hogan|SHL)\b/gi);
            if (certMatches) {
                extracted.certifications = [...new Set(certMatches.map(c => c.toUpperCase().replace(/\s/g, ' ')))];
            }

            // === REFERENCES ===
            const refPatterns = [
                /(?:reference|referens|client|kund|customer|uppdragsgivare)[s]?\s*[:\-]\s*(.+)/gi,
                /(?:worked\s*(?:with|for)|samarbete\s*med)\s*[:\-]?\s*(.+)/gi
            ];

            lines.forEach(line => {
                refPatterns.forEach(pattern => {
                    const match = line.match(pattern);
                    if (match && match[1]) {
                        const refs = match[1].split(/[,;&]/).map(r => r.trim()).filter(r => {
                            return r.length > 2 && r.length < 50 && /^[A-Z√Ö√Ñ√ñ]/.test(r);
                        });
                        refs.forEach(ref => {
                            const cleanRef = ref.split(/[\(\<]/)[0].trim();
                            if (cleanRef && !extracted.references.includes(cleanRef)) {
                                extracted.references.push(cleanRef);
                            }
                        });
                    }
                });
            });

            // === METRICS (lines with percentages) ===
            lines.forEach(line => {
                if (/\d+[\.,]?\d*\s*%/.test(line) && line.length < 150) {
                    extracted.metrics.push(line);
                }
            });

            // === COMPANY NAME ===
            const companyPatterns = ['company', 'f√∂retag', 'bolag', 'legal\\s*name', 'firma'];
            extracted.companyName = getValueAfterLabel(text, companyPatterns);

            return extracted;
        }

        // Apply extracted data to responses
        function applyExtractedData(responses, extracted) {
            const newResponses = { ...responses };

            // Section 3.1 - Company Information
            if (extracted.registrationNumber || extracted.vatNumber || extracted.foundedYear || extracted.revenue) {
                let section = newResponses["3.1"];
                if (extracted.registrationNumber) {
                    section = section.replace(/Registration number: \[MISSING\]/i, `Registration number: ${extracted.registrationNumber}`);
                    section = section.replace(/\[FILL IN\]/g, extracted.registrationNumber);
                }
                if (extracted.vatNumber) {
                    section = section.replace(/VAT number: \[MISSING\]/i, `VAT number: ${extracted.vatNumber}`);
                }
                if (extracted.foundedYear) {
                    section = section.replace(/Founded year: \[MISSING\]/i, `Founded year: ${extracted.foundedYear}`);
                }
                if (extracted.revenue) {
                    section = section.replace(/Revenue\/financial info: \[MISSING\]/i, `Revenue: ${extracted.revenue}`);
                }
                if (extracted.employees) {
                    section = section.replace(/Revenue: (.+)/i, `Revenue: $1\n- Employees: ${extracted.employees}`);
                }
                if (extracted.references.length > 0) {
                    section = section.replace(/\[NEED MORE REFERENCES\]/i, extracted.references.join(', '));
                }
                newResponses["3.1"] = section;
            }

            // Section 3.4 - Trainer Qualifications
            if (extracted.facilitators.length > 0 || extracted.certifications.length > 0) {
                let section = newResponses["3.4"];
                if (extracted.facilitators.length >= 1) {
                    section = section.replace(/VP PROGRAMME:\n\[NAME MISSING\]/i, `VP PROGRAMME:\n${extracted.facilitators[0]}`);
                }
                if (extracted.facilitators.length >= 2) {
                    section = section.replace(/MID-LEVEL:\n\[NAME MISSING\]/i, `MID-LEVEL:\n${extracted.facilitators[1]}`);
                }
                if (extracted.facilitators.length >= 3) {
                    section = section.replace(/FIRST-LINE:\n\[NAME MISSING\]/i, `FIRST-LINE:\n${extracted.facilitators[2]}`);
                }
                if (extracted.certifications.length > 0) {
                    section = section.replace(/\[ICF PCC, etc\.\]/i, extracted.certifications.join(', '));
                }
                newResponses["3.4"] = section;
            }

            // Section 3.5 - Measurement
            if (extracted.metrics.length > 0) {
                let section = newResponses["3.5"];
                const metricsText = extracted.metrics.slice(0, 5).join('\n‚Ä¢ ');
                section = section.replace(/\[MISSING: Concrete examples.*?\]/i, `Previous results:\n‚Ä¢ ${metricsText}`);
                newResponses["3.5"] = section;
            }

            // Section 3.6 - Governance
            if (extracted.keyAccountManager) {
                let section = newResponses["3.6"];
                section = section.replace(/KEY ACCOUNT MANAGER: \[NAME MISSING\]/i, `KEY ACCOUNT MANAGER: ${extracted.keyAccountManager}`);
                newResponses["3.6"] = section;
            }

            // Section 3.7 - Pricing
            if (extracted.prices.firstLine || extracted.prices.midLevel || extracted.prices.vp) {
                let section = newResponses["3.7"];
                if (extracted.prices.firstLine) {
                    section = section.replace(/First-line: \[X\] EUR/i, `First-line: ${extracted.prices.firstLine} EUR`);
                }
                if (extracted.prices.midLevel) {
                    section = section.replace(/Mid-level: \[X\] EUR/i, `Mid-level: ${extracted.prices.midLevel} EUR`);
                }
                if (extracted.prices.vp) {
                    section = section.replace(/VP\/Executive: \[X\] EUR/i, `VP/Executive: ${extracted.prices.vp} EUR`);
                }
                if (extracted.prices.coaching) {
                    section = section.replace(/Extra coaching: \[X\] EUR/i, `Extra coaching: ${extracted.prices.coaching} EUR`);
                }
                if (extracted.prices.translation) {
                    section = section.replace(/Translation FI\/EE: \[X\] EUR/i, `Translation FI/EE: ${extracted.prices.translation} EUR`);
                }
                newResponses["3.7"] = section;
            }

            return newResponses;
        }

        // Semantic synonyms for better matching
        const synonymMap = {
            'profile': ['profile', 'description', 'overview', 'about', 'introduction', 'background'],
            'brief': ['brief', 'short', 'summary', 'concise', 'overview'],
            'expertise': ['expertise', 'specialization', 'specialty', 'focus', 'competence', 'capability'],
            'references': ['references', 'clients', 'customers', 'case studies', 'testimonials', 'portfolio'],
            'financial': ['financial', 'revenue', 'turnover', 'profit', 'economic', 'fiscal'],
            'stability': ['stability', 'stable', 'sustainable', 'consistent', 'reliable', 'solid'],
            'trainer': ['trainer', 'facilitator', 'coach', 'instructor', 'consultant', 'expert'],
            'measurement': ['measurement', 'metrics', 'kpi', 'roi', 'evaluation', 'assessment', 'results'],
            'governance': ['governance', 'management', 'oversight', 'steering', 'coordination'],
            'pricing': ['pricing', 'price', 'cost', 'fee', 'rate', 'investment', 'budget']
        };

        // Check if a term (or its synonyms) exists in text
        function termExistsInText(term, text) {
            // Direct match first
            if (text.includes(term)) return { found: true, matchedAs: term };

            // Check synonyms
            for (const [baseTerm, synonyms] of Object.entries(synonymMap)) {
                if (synonyms.includes(term)) {
                    for (const syn of synonyms) {
                        if (text.includes(syn)) {
                            return { found: true, matchedAs: syn };
                        }
                    }
                }
            }
            return { found: false, matchedAs: null };
        }

        // ============================================
        // CLAUDE API INTEGRATION
        // ============================================

        async function callClaudeAPI(apiKey, prompt, onStream = null) {
            if (!apiKey) {
                throw new Error('Ingen API-nyckel konfigurerad. G√• till Inst√§llningar.');
            }

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 4096,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                if (response.status === 401) {
                    throw new Error('Ogiltig API-nyckel. Kontrollera din nyckel i Inst√§llningar.');
                }
                throw new Error(error.error?.message || `API-fel: ${response.status}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // ============================================
        // PERPLEXITY API INTEGRATION (Web Search)
        // Uses sonar-pro model with built-in web search
        // ============================================

        async function callPerplexityAPI(perplexityKey, prompt, onProgress = null) {
            if (!perplexityKey) {
                throw new Error('Ingen Perplexity API-nyckel konfigurerad. G√• till Inst√§llningar.');
            }

            const response = await fetch('https://api.perplexity.ai/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${perplexityKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'sonar-pro',  // Has web search built-in
                    messages: [{
                        role: 'system',
                        content: 'You are a thorough business research analyst. Always cite your sources and provide specific, actionable intelligence. Format your response in clear sections.'
                    }, {
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 4096,
                    temperature: 0.2,
                    return_citations: true,
                    search_recency_filter: 'month'  // Focus on recent info
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                if (response.status === 401) {
                    throw new Error('Ogiltig Perplexity API-nyckel. Kontrollera din nyckel i Inst√§llningar.');
                }
                throw new Error(error.error?.message || `Perplexity API-fel: ${response.status}`);
            }

            const data = await response.json();

            // Extract citations if available
            const citations = data.citations || [];
            const content = data.choices[0].message.content;

            return {
                content,
                citations,
                model: data.model
            };
        }

        // Settings Modal Component
        function SettingsModal({ isOpen, onClose, apiKey, onSaveApiKey, perplexityKey, onSavePerplexityKey, onResetAll }) {
            const [tempKey, setTempKey] = useState(apiKey);
            const [tempPerplexityKey, setTempPerplexityKey] = useState(perplexityKey);
            const [testing, setTesting] = useState(false);
            const [testResult, setTestResult] = useState(null);
            const [testingPerplexity, setTestingPerplexity] = useState(false);
            const [perplexityTestResult, setPerplexityTestResult] = useState(null);
            const [showResetConfirm, setShowResetConfirm] = useState(false);

            const handleTest = async () => {
                setTesting(true);
                setTestResult(null);
                try {
                    await callClaudeAPI(tempKey, 'Svara bara med "OK" f√∂r att bekr√§fta att API-nyckeln fungerar.');
                    setTestResult({ success: true, message: '‚úÖ API-nyckeln fungerar!' });
                } catch (err) {
                    setTestResult({ success: false, message: `‚ùå ${err.message}` });
                }
                setTesting(false);
            };

            const handleTestPerplexity = async () => {
                setTestingPerplexity(true);
                setPerplexityTestResult(null);
                try {
                    const response = await fetch('https://api.perplexity.ai/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${tempPerplexityKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'sonar',
                            messages: [{ role: 'user', content: 'Say OK to confirm the API key works.' }],
                            max_tokens: 10
                        })
                    });
                    if (!response.ok) throw new Error('Invalid API key');
                    setPerplexityTestResult({ success: true, message: '‚úÖ Perplexity-nyckeln fungerar!' });
                } catch (err) {
                    setPerplexityTestResult({ success: false, message: `‚ùå ${err.message}` });
                }
                setTestingPerplexity(false);
            };

            const handleSave = () => {
                onSaveApiKey(tempKey);
                onSavePerplexityKey(tempPerplexityKey);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-4">
                            <div className="flex justify-between items-center">
                                <h2 className="text-xl font-bold">‚öôÔ∏è Inst√§llningar</h2>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6">
                            <div className="mb-6">
                                <h3 className="font-semibold text-gray-800 mb-2">ü§ñ Claude API-nyckel</h3>
                                <p className="text-sm text-gray-600 mb-3">
                                    Med en API-nyckel kan analysverktygen k√∂ra AI direkt utan att du beh√∂ver kopiera/klistra.
                                    <a href="https://console.anthropic.com/" target="_blank" className="text-teal-600 hover:underline ml-1">
                                        Skaffa nyckel ‚Üí
                                    </a>
                                </p>
                                <div className="flex gap-2">
                                    <input
                                        type="password"
                                        value={tempKey}
                                        onChange={(e) => setTempKey(e.target.value)}
                                        placeholder="sk-ant-api03-..."
                                        className="flex-1 p-3 border-2 border-gray-200 rounded-lg font-mono text-sm focus:border-teal-500 focus:ring-2 focus:ring-teal-200"
                                    />
                                    <button
                                        onClick={handleTest}
                                        disabled={!tempKey || testing}
                                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50"
                                    >
                                        {testing ? '‚è≥' : 'üß™ Testa'}
                                    </button>
                                </div>
                                {testResult && (
                                    <p className={`mt-2 text-sm ${testResult.success ? 'text-green-600' : 'text-red-600'}`}>
                                        {testResult.message}
                                    </p>
                                )}
                            </div>

                            {/* Perplexity API Key Section */}
                            <div className="mb-6">
                                <h3 className="font-semibold text-gray-800 mb-2">üîç Perplexity API-nyckel (Web Search)</h3>
                                <p className="text-sm text-gray-600 mb-3">
                                    Med Perplexity kan appen s√∂ka p√• webben och generera kundinsikt direkt i appen.
                                    <a href="https://www.perplexity.ai/settings/api" target="_blank" className="text-purple-600 hover:underline ml-1">
                                        Skaffa nyckel ‚Üí
                                    </a>
                                </p>
                                <div className="flex gap-2">
                                    <input
                                        type="password"
                                        value={tempPerplexityKey}
                                        onChange={(e) => setTempPerplexityKey(e.target.value)}
                                        placeholder="pplx-..."
                                        className="flex-1 p-3 border-2 border-gray-200 rounded-lg font-mono text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                                    />
                                    <button
                                        onClick={handleTestPerplexity}
                                        disabled={!tempPerplexityKey || testingPerplexity}
                                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50"
                                    >
                                        {testingPerplexity ? '‚è≥' : 'üß™ Testa'}
                                    </button>
                                </div>
                                {perplexityTestResult && (
                                    <p className={`mt-2 text-sm ${perplexityTestResult.success ? 'text-green-600' : 'text-red-600'}`}>
                                        {perplexityTestResult.message}
                                    </p>
                                )}
                            </div>

                            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 className="font-medium text-blue-800 mb-2">üí° Vad kostar det?</h4>
                                <ul className="text-sm text-blue-700 space-y-1">
                                    <li><strong>Claude (analys):</strong></li>
                                    <li>‚Ä¢ Svaghetsdetektor: ~$0.02-0.05 per analys</li>
                                    <li>‚Ä¢ Kritiska fr√•gor: ~$0.01-0.03 per analys</li>
                                    <li><strong>Perplexity (web search):</strong></li>
                                    <li>‚Ä¢ Kundinsikt-generering: ~$0.005 per s√∂kning</li>
                                </ul>
                                <p className="text-xs text-blue-600 mt-2">
                                    Nycklarna sparas endast lokalt i din webbl√§sare. Doings har aldrig √•tkomst till dem.
                                </p>
                            </div>

                            {/* RESET ALL SECTION */}
                            <div className="mt-6 p-4 bg-red-50 rounded-lg border border-red-200">
                                <h4 className="font-medium text-red-800 mb-2">üîÑ B√∂rja om fr√•n b√∂rjan</h4>
                                <p className="text-sm text-red-700 mb-3">
                                    Rensa allt inneh√•ll och b√∂rja med en ny RFP. API-nycklar beh√•lls.
                                </p>

                                {!showResetConfirm ? (
                                    <button
                                        onClick={() => setShowResetConfirm(true)}
                                        className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 border border-red-300 text-sm font-medium"
                                    >
                                        üóëÔ∏è Rensa allt inneh√•ll
                                    </button>
                                ) : (
                                    <div className="space-y-3">
                                        <div className="p-3 bg-red-100 rounded-lg border border-red-300">
                                            <p className="text-sm text-red-800 font-medium mb-2">‚ö†Ô∏è Detta kommer att radera:</p>
                                            <ul className="text-xs text-red-700 space-y-1 ml-4">
                                                <li>‚Ä¢ Uppladdad RFP-dokument</li>
                                                <li>‚Ä¢ All kundinsikt/research</li>
                                                <li>‚Ä¢ Alla genererade svar</li>
                                                <li>‚Ä¢ Alla godk√§nnanden och kommentarer</li>
                                            </ul>
                                            <p className="text-xs text-green-700 mt-2">‚úì API-nycklar beh√•lls</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setShowResetConfirm(false)}
                                                className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm"
                                            >
                                                Avbryt
                                            </button>
                                            <button
                                                onClick={() => {
                                                    onResetAll();
                                                    setShowResetConfirm(false);
                                                }}
                                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium"
                                            >
                                                ‚úì Ja, rensa allt
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="border-t p-4 bg-gray-50 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-1">
                                    <span className={`w-2 h-2 rounded-full ${apiKey ? 'bg-green-500' : 'bg-gray-300'}`}></span>
                                    <span className={`text-xs ${apiKey ? 'text-green-600' : 'text-gray-500'}`}>Claude</span>
                                </div>
                                <div className="flex items-center gap-1">
                                    <span className={`w-2 h-2 rounded-full ${perplexityKey ? 'bg-purple-500' : 'bg-gray-300'}`}></span>
                                    <span className={`text-xs ${perplexityKey ? 'text-purple-600' : 'text-gray-500'}`}>Perplexity</span>
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">Avbryt</button>
                                <button
                                    onClick={handleSave}
                                    className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700"
                                >
                                    ‚úì Spara
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // AI SUGGESTION COMPONENT (Human-in-the-Loop)
        // ============================================

        // Parse AI response into structured suggestions
        function parseAISuggestions(aiResponse) {
            const suggestions = [];

            // Try to find JSON block first
            const jsonMatch = aiResponse.match(/```json\n?([\s\S]*?)\n?```/);
            if (jsonMatch) {
                try {
                    const parsed = JSON.parse(jsonMatch[1]);
                    if (Array.isArray(parsed)) return parsed;
                    if (parsed.suggestions) return parsed.suggestions;
                } catch (e) {
                    console.log('JSON parse failed, falling back to text parsing');
                }
            }

            // Fallback: Parse structured text format
            // Look for patterns like "SEKTION 3.1:" or "**3.1**" or "### 3.1"
            const sectionPattern = /(?:SEKTION|Section|###?)\s*(3\.[1-8])[:\s\-]*([^\n]*)\n([\s\S]*?)(?=(?:SEKTION|Section|###?\s*3\.[1-8])|$)/gi;
            let match;

            while ((match = sectionPattern.exec(aiResponse)) !== null) {
                const sectionId = match[1];
                const title = match[2].trim();
                const content = match[3].trim();

                // Extract specific suggestions from the content
                const suggestionLines = content.split('\n').filter(line =>
                    line.trim().startsWith('-') ||
                    line.trim().startsWith('‚Ä¢') ||
                    line.trim().startsWith('*') ||
                    line.trim().match(/^\d+\./)
                );

                if (suggestionLines.length > 0) {
                    suggestionLines.forEach((line, idx) => {
                        const text = line.replace(/^[-‚Ä¢*\d.]+\s*/, '').trim();
                        if (text.length > 10) {
                            suggestions.push({
                                id: `${sectionId}-${idx}`,
                                sectionId: sectionId,
                                type: 'improvement',
                                severity: content.toLowerCase().includes('kritisk') ? 'critical' :
                                         content.toLowerCase().includes('viktig') ? 'high' : 'medium',
                                suggestion: text,
                                suggestedText: '',
                                status: 'pending'
                            });
                        }
                    });
                } else if (content.length > 20) {
                    suggestions.push({
                        id: `${sectionId}-0`,
                        sectionId: sectionId,
                        type: 'improvement',
                        severity: 'medium',
                        suggestion: content.slice(0, 500),
                        suggestedText: '',
                        status: 'pending'
                    });
                }
            }

            // If no section-specific suggestions found, create general ones
            if (suggestions.length === 0) {
                // Look for bullet points anywhere
                const lines = aiResponse.split('\n');
                lines.forEach((line, idx) => {
                    if ((line.trim().startsWith('-') || line.trim().startsWith('‚Ä¢') || line.trim().startsWith('*')) &&
                        line.length > 20) {
                        const text = line.replace(/^[-‚Ä¢*]+\s*/, '').trim();
                        // Try to detect section reference
                        const sectionRef = text.match(/\b(3\.[1-8])\b/);
                        suggestions.push({
                            id: `gen-${idx}`,
                            sectionId: sectionRef ? sectionRef[1] : 'general',
                            type: 'improvement',
                            severity: text.toLowerCase().includes('kritisk') ? 'critical' :
                                     text.toLowerCase().includes('m√•ste') ? 'high' : 'medium',
                            suggestion: text,
                            suggestedText: '',
                            status: 'pending'
                        });
                    }
                });
            }

            return suggestions;
        }

        // Individual Suggestion Card Component
        function SuggestionCard({ suggestion, onAccept, onReject, onEdit, sectionTitle }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editedText, setEditedText] = useState(suggestion.suggestedText || suggestion.suggestion);

            const severityColors = {
                critical: 'border-red-400 bg-red-50',
                high: 'border-orange-400 bg-orange-50',
                medium: 'border-yellow-400 bg-yellow-50',
                low: 'border-blue-400 bg-blue-50'
            };

            const severityLabels = {
                critical: 'üî¥ Kritisk',
                high: 'üü† Viktig',
                medium: 'üü° F√∂rb√§ttring',
                low: 'üîµ Nice-to-have'
            };

            if (suggestion.status === 'accepted') {
                return (
                    <div className="p-3 rounded-lg border-2 border-green-400 bg-green-50 mb-3">
                        <div className="flex items-center justify-between">
                            <span className="text-green-700 font-medium">‚úÖ Accepterad</span>
                            <span className="text-sm text-gray-500">{suggestion.sectionId}</span>
                        </div>
                        <p className="text-sm text-green-800 mt-1">{editedText}</p>
                    </div>
                );
            }

            if (suggestion.status === 'rejected') {
                return (
                    <div className="p-3 rounded-lg border border-gray-200 bg-gray-50 mb-3 opacity-50">
                        <div className="flex items-center justify-between">
                            <span className="text-gray-500 font-medium">‚ùå Avvisad</span>
                            <span className="text-sm text-gray-400">{suggestion.sectionId}</span>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`p-4 rounded-lg border-2 ${severityColors[suggestion.severity]} mb-3`}>
                    <div className="flex items-start justify-between mb-2">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-medium px-2 py-1 rounded bg-white/50">
                                {severityLabels[suggestion.severity]}
                            </span>
                            <span className="text-xs text-gray-600">
                                Sektion {suggestion.sectionId} {sectionTitle && `- ${sectionTitle}`}
                            </span>
                        </div>
                    </div>

                    {isEditing ? (
                        <div className="space-y-2">
                            <textarea
                                value={editedText}
                                onChange={(e) => setEditedText(e.target.value)}
                                className="w-full p-2 border rounded text-sm min-h-[80px]"
                                placeholder="Redigera f√∂rslaget..."
                            />
                            <div className="flex gap-2">
                                <button
                                    onClick={() => {
                                        onEdit(suggestion.id, editedText);
                                        setIsEditing(false);
                                    }}
                                    className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                                >
                                    ‚úì Spara
                                </button>
                                <button
                                    onClick={() => setIsEditing(false)}
                                    className="px-3 py-1 text-gray-600 text-sm hover:text-gray-800"
                                >
                                    Avbryt
                                </button>
                            </div>
                        </div>
                    ) : (
                        <>
                            <p className="text-sm text-gray-800 mb-3">{suggestion.suggestion}</p>

                            {suggestion.suggestedText && (
                                <div className="p-2 bg-white/70 rounded border border-current/20 mb-3">
                                    <p className="text-xs text-gray-500 mb-1">F√∂reslagen text:</p>
                                    <p className="text-sm italic">{suggestion.suggestedText}</p>
                                </div>
                            )}

                            <div className="flex gap-2">
                                <button
                                    onClick={() => onAccept(suggestion.id, editedText)}
                                    className="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 flex items-center gap-1"
                                >
                                    ‚úì Acceptera
                                </button>
                                <button
                                    onClick={() => setIsEditing(true)}
                                    className="px-3 py-1.5 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200 flex items-center gap-1"
                                >
                                    ‚úèÔ∏è Redigera
                                </button>
                                <button
                                    onClick={() => onReject(suggestion.id)}
                                    className="px-3 py-1.5 text-gray-500 text-sm hover:text-red-600 flex items-center gap-1"
                                >
                                    ‚úó Avvisa
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // Suggestions List with Apply All functionality
        function SuggestionsList({ suggestions, onSuggestionsChange, onApplyAll, rfpSections }) {
            const handleAccept = (id, text) => {
                onSuggestionsChange(suggestions.map(s =>
                    s.id === id ? { ...s, status: 'accepted', suggestedText: text || s.suggestion } : s
                ));
            };

            const handleReject = (id) => {
                onSuggestionsChange(suggestions.map(s =>
                    s.id === id ? { ...s, status: 'rejected' } : s
                ));
            };

            const handleEdit = (id, newText) => {
                onSuggestionsChange(suggestions.map(s =>
                    s.id === id ? { ...s, suggestedText: newText } : s
                ));
            };

            const acceptedCount = suggestions.filter(s => s.status === 'accepted').length;
            const pendingCount = suggestions.filter(s => s.status === 'pending').length;
            const totalCount = suggestions.length;

            const getSectionTitle = (sectionId) => {
                const section = rfpSections.find(s => s.id === sectionId);
                return section?.title || '';
            };

            return (
                <div>
                    {/* Progress Bar */}
                    <div className="mb-4 p-3 bg-gray-100 rounded-lg">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-medium text-gray-700">
                                Granskningsframsteg
                            </span>
                            <span className="text-sm text-gray-500">
                                {acceptedCount} accepterade, {pendingCount} kvar av {totalCount}
                            </span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div
                                className="bg-green-500 rounded-full h-2 transition-all"
                                style={{ width: `${((totalCount - pendingCount) / totalCount) * 100}%` }}
                            />
                        </div>
                    </div>

                    {/* Suggestions */}
                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                        {suggestions.map(suggestion => (
                            <SuggestionCard
                                key={suggestion.id}
                                suggestion={suggestion}
                                onAccept={handleAccept}
                                onReject={handleReject}
                                onEdit={handleEdit}
                                sectionTitle={getSectionTitle(suggestion.sectionId)}
                            />
                        ))}
                    </div>

                    {/* Apply Button */}
                    {acceptedCount > 0 && (
                        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="font-medium text-green-800">
                                        {acceptedCount} f√∂rslag redo att appliceras
                                    </p>
                                    <p className="text-sm text-green-600">
                                        Klicka f√∂r att uppdatera ditt f√∂rslag med de accepterade √§ndringarna
                                    </p>
                                </div>
                                <button
                                    onClick={onApplyAll}
                                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center gap-2"
                                >
                                    üöÄ Applicera {acceptedCount} √§ndringar
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Evaluation logic with transparency
        function evaluateResponse(sectionId, response, requirements) {
            const checks = [];
            let score = 0;
            const maxScore = requirements.length * 10;

            const hasMissing = response.includes('[MISSING]') || response.includes('[FILL IN]') ||
                              response.includes('[X]') || response.includes('[NAME');

            requirements.forEach((req, idx) => {
                const reqLower = req.toLowerCase();
                const respLower = response.toLowerCase();

                let found = false;
                let confidence = 0;

                // Extract key terms (words > 4 chars)
                const keyTerms = reqLower.split(' ').filter(w => w.length > 4);

                // Track which terms matched and how
                const termAnalysis = keyTerms.map(term => {
                    const result = termExistsInText(term, respLower);
                    return {
                        term,
                        found: result.found,
                        matchedAs: result.matchedAs
                    };
                });

                const matchedTerms = termAnalysis.filter(t => t.found);
                const missedTerms = termAnalysis.filter(t => !t.found);
                const matchRatio = matchedTerms.length / Math.max(keyTerms.length, 1);

                if (matchRatio > 0.5) {
                    found = true;
                    confidence = Math.min(matchRatio * 100, 100);
                }

                // Special overrides for specific requirements
                if (reqLower.includes('legal name') && (respLower.includes('missing') || !respLower.includes('registration'))) {
                    found = false; confidence = 20;
                }
                if (reqLower.includes('vat') && respLower.includes('missing')) {
                    found = false; confidence = 10;
                }
                if (reqLower.includes('coach') && respLower.includes('coach')) {
                    found = true; confidence = 90;
                }
                if (reqLower.includes('challenger') && respLower.includes('challenger')) {
                    found = true; confidence = 90;
                }
                if (reqLower.includes('connector') && respLower.includes('connector')) {
                    found = true; confidence = 90;
                }
                if (reqLower.includes('pricing') && respLower.includes('[x]')) {
                    found = false; confidence = 10;
                }
                if (reqLower.includes('trainer') && respLower.includes('name missing')) {
                    found = false; confidence = 20;
                }
                if (reqLower.includes('key account') && respLower.includes('name missing')) {
                    found = false; confidence = 30;
                }

                const itemScore = found ? Math.round(confidence / 10) : (confidence > 30 ? 3 : 1);
                score += itemScore;

                // Build detailed debug info
                const debugInfo = {
                    keyTerms: keyTerms,
                    matched: matchedTerms.map(t => t.matchedAs ? `${t.term}‚Üí${t.matchedAs}` : t.term),
                    missed: missedTerms.map(t => t.term),
                    ratio: `${matchedTerms.length}/${keyTerms.length} = ${Math.round(matchRatio * 100)}%`
                };

                checks.push({
                    requirement: req,
                    status: found ? 'complete' : (confidence > 30 ? 'partial' : 'missing'),
                    confidence: Math.round(confidence),
                    suggestion: !found ? getSuggestion(req, sectionId) : null,
                    debug: debugInfo  // NEW: detailed scoring breakdown
                });
            });

            const overallScore = Math.round((score / maxScore) * 100);
            const gaps = checks.filter(c => c.status !== 'complete');

            return {
                score: overallScore,
                checks,
                gaps,
                hasCriticalGaps: hasMissing,
                summary: generateSummary(overallScore, gaps.length, hasMissing)
            };
        }

        function getSuggestion(req, sectionId) {
            const suggestions = {
                'legal name': 'Add registration number and legal details',
                'vat': 'Add VAT number',
                'financial': 'Include revenue, employee count, growth rate',
                'references': 'Add 2-3 named reference clients with contact persons',
                'coach': 'Explicitly describe how you train the COACH role',
                'challenger': 'Explicitly describe how you train the CHALLENGER role',
                'connector': 'Explicitly describe how you train the CONNECTOR role',
                'pricing': 'Fill in concrete prices per participant',
                'trainer': 'Add named facilitators with CVs',
                'key account': 'Name the dedicated Key Account Manager',
                'language': 'Clarify approach for Finnish/Estonian delivery',
                'measurement': 'Add concrete examples from previous assignments',
                'examples': 'Include measurement results from Alleima or other reference'
            };

            for (const [key, suggestion] of Object.entries(suggestions)) {
                if (req.toLowerCase().includes(key)) return suggestion;
            }
            return 'Expand this section with more specific information';
        }

        function generateSummary(score, gapsCount, hasCritical) {
            if (hasCritical) {
                return '‚ö†Ô∏è Critical gaps: Missing fundamental information that must be filled in';
            }
            if (score >= 80) return '‚úÖ Strong response - minor refinements possible';
            if (score >= 60) return 'üî∂ Acceptable but room for improvement';
            if (score >= 40) return '‚ö° Needs more work to be competitive';
            return 'üî¥ Significant gaps - prioritise this section';
        }

        // Export function
        function exportToMarkdown(responses, evaluations) {
            let md = `# ELISA RFP - RESPONSE EXPORT\n`;
            md += `**Exported:** ${new Date().toISOString().split('T')[0]}\n`;
            md += `**Overall Score:** ${Math.round(Object.values(evaluations).reduce((s, e) => s + e.score, 0) / rfpSections.length)}%\n\n`;
            md += `---\n\n`;

            rfpSections.forEach(section => {
                const eval_ = evaluations[section.id];
                md += `## ${section.id} ${section.title}\n\n`;
                md += `**Score:** ${eval_?.score || 0}% | **Gaps:** ${eval_?.gaps?.length || 0}\n\n`;
                md += `### Response:\n\n`;
                md += `${responses[section.id] || '[No response]'}\n\n`;
                md += `### Evaluation:\n\n`;
                eval_?.checks?.forEach(c => {
                    const icon = c.status === 'complete' ? '‚úì' : c.status === 'partial' ? '‚óê' : '‚úó';
                    md += `- ${icon} **${c.requirement}** (${c.confidence}%)\n`;
                    if (c.suggestion) md += `  - üí° ${c.suggestion}\n`;
                });
                md += `\n---\n\n`;
            });

            return md;
        }

        function downloadMarkdown(content, filename) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Excel Export Function (Scanmarket-style format)
        function exportToExcel(responses, evaluations) {
            const wb = XLSX.utils.book_new();

            // Sheet 1: RFP Responses (main content)
            const responseData = [
                ['ELISA LEADERSHIP DEVELOPMENT RFP - DOINGS RESPONSE'],
                ['Exported:', new Date().toISOString().split('T')[0]],
                [''],
                ['Section', 'Title', 'Weight %', 'Score %', 'Response', 'Gaps', 'Status']
            ];

            rfpSections.forEach(section => {
                const eval_ = evaluations[section.id];
                const response = responses[section.id] || '';
                const gapCount = eval_?.gaps?.length || 0;
                const status = eval_?.hasCriticalGaps ? 'CRITICAL - Needs Input' :
                              gapCount > 0 ? 'Partial' : 'Complete';

                responseData.push([
                    section.id,
                    section.title,
                    section.weight,
                    eval_?.score || 0,
                    response.replace(/\n/g, ' | '),
                    gapCount,
                    status
                ]);
            });

            const ws1 = XLSX.utils.aoa_to_sheet(responseData);
            ws1['!cols'] = [
                {wch: 8}, {wch: 35}, {wch: 10}, {wch: 10}, {wch: 80}, {wch: 8}, {wch: 20}
            ];
            XLSX.utils.book_append_sheet(wb, ws1, 'RFP Responses');

            // Sheet 2: Requirements Checklist
            const checklistData = [
                ['REQUIREMENTS CHECKLIST'],
                [''],
                ['Section', 'Requirement', 'Status', 'Confidence %', 'Suggestion']
            ];

            rfpSections.forEach(section => {
                const eval_ = evaluations[section.id];
                eval_?.checks?.forEach(check => {
                    checklistData.push([
                        section.id,
                        check.requirement,
                        check.status.toUpperCase(),
                        check.confidence,
                        check.suggestion || ''
                    ]);
                });
            });

            const ws2 = XLSX.utils.aoa_to_sheet(checklistData);
            ws2['!cols'] = [
                {wch: 8}, {wch: 60}, {wch: 12}, {wch: 12}, {wch: 50}
            ];
            XLSX.utils.book_append_sheet(wb, ws2, 'Requirements Checklist');

            // Sheet 3: Pricing Template (for Scanmarket)
            const pricingData = [
                ['PRICING BREAKDOWN - ELISA RFP'],
                [''],
                ['Programme Level', 'Price per Participant (EUR)', 'Group Size', 'Duration', 'Includes'],
                ['First-Line Managers', '[FILL IN]', '20-25', '10-12 months', 'Facilitation, materials, digital platform, Learning Buddy'],
                ['Mid-Level Managers', '[FILL IN]', '12-16', '6-8 months', '+ 360¬∞ analysis, Learning Group coach, Business Dilemma'],
                ['VP/Executive', '[FILL IN]', '12-16', '8-12 months', '+ Peer Advisory, Executive Coaching (4 sessions), Strategic Challenge'],
                [''],
                ['ADD-ON SERVICES', 'Price (EUR)', '', '', ''],
                ['Extra coaching session', '[FILL IN]', '', '', 'Per hour'],
                ['Translation FI/EE', '[FILL IN]', '', '', 'Per module'],
                ['Custom 360¬∞ report', '[FILL IN]', '', '', 'Per participant'],
                [''],
                ['VOLUME DISCOUNTS', 'Discount %', '', '', ''],
                ['3+ cohorts/year', '10%', '', '', ''],
                ['All three programme levels', '15%', '', '', ''],
                ['3-year agreement', '20%', '', '', ''],
                ['Combined (all above)', '25%', '', '', ''],
                [''],
                ['CONTRACT OPTIONS', '', '', '', ''],
                ['1 year', 'Available', '', '', ''],
                ['2 years', 'Available', '', '', ''],
                ['3 years', 'Recommended', '', '', ''],
                ['5 years', 'Available', '', '', ''],
                [''],
                ['PAYMENT TERMS', '', '', '', ''],
                ['At signing', '30%', '', '', ''],
                ['At programme start', '50%', '', '', ''],
                ['At completion', '20%', '', '', '']
            ];

            const ws3 = XLSX.utils.aoa_to_sheet(pricingData);
            ws3['!cols'] = [
                {wch: 30}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 50}
            ];
            XLSX.utils.book_append_sheet(wb, ws3, 'Pricing Template');

            // Sheet 4: Company Info (Section 3.1)
            const companyData = [
                ['COMPANY INFORMATION - SECTION 3.1'],
                [''],
                ['Field', 'Value', 'Status'],
                ['Legal Name', 'Doings [FULL LEGAL NAME]', '[FILL IN]'],
                ['Registration Number', '[FILL IN]', 'REQUIRED'],
                ['VAT Number', '[FILL IN]', 'REQUIRED'],
                ['Address', '[FILL IN]', 'REQUIRED'],
                ['Founded', '[YEAR]', 'REQUIRED'],
                ['Revenue (latest year)', '[X] EUR', 'REQUIRED'],
                ['Employees', '[X]', 'REQUIRED'],
                [''],
                ['REFERENCES', '', ''],
                ['Reference 1', 'Alleima (if permitted)', 'Commit & Elevate, Empower & Advance'],
                ['Reference 2', '[FILL IN]', ''],
                ['Reference 3', '[FILL IN]', ''],
                [''],
                ['KEY CONTACTS', '', ''],
                ['Key Account Manager', '[NAME]', '[EMAIL, PHONE]'],
                ['VP Programme Lead', '[NAME]', '[BACKGROUND]'],
                ['Mid-Level Lead', '[NAME]', '[BACKGROUND]'],
                ['First-Line Lead', '[NAME]', '[BACKGROUND]']
            ];

            const ws4 = XLSX.utils.aoa_to_sheet(companyData);
            ws4['!cols'] = [
                {wch: 25}, {wch: 40}, {wch: 40}
            ];
            XLSX.utils.book_append_sheet(wb, ws4, 'Company Info');

            // Download
            XLSX.writeFile(wb, `Elisa_RFP_Response_Doings_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // CSV Export (simple format for copy-paste)
        function exportToCSV(responses, evaluations) {
            let csv = 'Section,Title,Response,Score,Status\n';

            rfpSections.forEach(section => {
                const eval_ = evaluations[section.id];
                const response = (responses[section.id] || '').replace(/"/g, '""').replace(/\n/g, ' | ');
                const status = eval_?.hasCriticalGaps ? 'CRITICAL' : 'OK';

                csv += `"${section.id}","${section.title}","${response}",${eval_?.score || 0},"${status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Elisa_RFP_Response_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Word Document Import (using mammoth.js)
        async function importWordDocument(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        resolve(result.value);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Word Document Export (HTML method - guaranteed to work)
        function exportToWord(responses, evaluations) {
            const overallScore = Math.round(Object.values(evaluations).reduce((sum, e) => sum + (e.score || 0), 0) / rfpSections.length);

            // Build HTML that Word can open perfectly
            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="UTF-8"><title>Elisa RFP Response</title>
<!--[if gte mso 9]><xml><w:WordDocument><w:View>Print</w:View></w:WordDocument></xml><![endif]-->
<style>
body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.6; }
h1 { font-size: 22pt; color: #1E3A5F; text-align: center; margin-bottom: 5pt; }
h2 { font-size: 14pt; color: #0891B2; margin-top: 24pt; border-bottom: 1pt solid #0891B2; padding-bottom: 4pt; }
.subtitle { text-align: center; color: #666; font-size: 11pt; margin-bottom: 20pt; }
table { width: 100%; border-collapse: collapse; margin: 15pt 0; }
th { background: #E8F4F8; padding: 8pt; border: 1pt solid #ccc; text-align: left; font-weight: bold; }
td { padding: 8pt; border: 1pt solid #ccc; }
.good { color: #16a34a; }
.warning { color: #ca8a04; }
.bad { color: #dc2626; }
.meta { color: #666; font-size: 10pt; margin-bottom: 8pt; }
.req { background: #f5f5f5; padding: 8pt; margin-bottom: 12pt; font-size: 10pt; border-left: 3pt solid #0891B2; }
p { margin: 6pt 0; }
</style></head><body>

<h1>Elisa Leadership Development RFP Response</h1>
<p class="subtitle">Submitted by Doings by House of Impact AB<br>Generated: ${new Date().toLocaleDateString('sv-SE')}</p>

<h2>Executive Summary</h2>
<p><strong>Overall Score: <span class="${overallScore >= 70 ? 'good' : overallScore >= 50 ? 'warning' : 'bad'}">${overallScore}%</span></strong></p>

<table>
<tr><th>Section</th><th>Title</th><th>Score</th><th>Status</th></tr>
${rfpSections.map(s => {
    const e = evaluations[s.id] || { score: 0 };
    const cls = e.score >= 70 ? 'good' : e.score >= 50 ? 'warning' : 'bad';
    return `<tr><td><b>${s.id}</b></td><td>${s.title}</td><td class="${cls}">${e.score || 0}%</td><td>${e.hasCriticalGaps ? 'Needs work' : 'Good'}</td></tr>`;
}).join('')}
</table>

${rfpSections.map(s => {
    const resp = responses[s.id] || '';
    const e = evaluations[s.id] || { score: 0 };
    const cls = e.score >= 70 ? 'good' : e.score >= 50 ? 'warning' : 'bad';
    const content = resp.split('\\n').filter(p => p.trim()).map(p =>
        '<p>' + p.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>'
    ).join('') || '<p><i>No response provided</i></p>';

    return `<h2>${s.id} ${s.title}</h2>
<p class="meta">Score: <span class="${cls}">${e.score || 0}%</span> | Weight: ${s.weight}%</p>
<div class="req"><b>Requirements:</b> ${s.requirements.join('; ')}</div>
${content}`;
}).join('')}

</body></html>`;

            // Download as .doc file
            const blob = new Blob(['\\ufeff' + html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Elisa_RFP_Response_Doings_' + new Date().toISOString().split('T')[0] + '.doc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Smart Distribute - splits full text into sections
        function generateDistributePrompt(fullText) {
            const sectionsInfo = rfpSections.map(s =>
                `SECTION ${s.id} - ${s.title}:\nRequirements: ${s.requirements.join('; ')}`
            ).join('\n\n');

            return `You are helping prepare an RFP response for Elisa Corporation.

TASK: Distribute the following text into the correct RFP sections. Extract ONLY the relevant content for each section.

RFP SECTIONS AND THEIR REQUIREMENTS:
${sectionsInfo}

FULL INPUT TEXT:
"""
${fullText}
"""

INSTRUCTIONS:
1. Read through the entire text
2. For EACH section (3.1 through 3.8), extract ONLY the content that answers that section's requirements
3. If content fits multiple sections, put it in the MOST relevant one
4. Remove duplicate information
5. Remove irrelevant filler text
6. Keep factual data (names, numbers, dates)
7. If a section has no relevant content, write "[NO CONTENT FOUND]"

OUTPUT FORMAT (use EXACTLY this format with the markers):
===SECTION 3.1===
[Extracted content for 3.1 here]

===SECTION 3.2===
[Extracted content for 3.2 here]

===SECTION 3.3===
[Extracted content for 3.3 here]

===SECTION 3.4===
[Extracted content for 3.4 here]

===SECTION 3.5===
[Extracted content for 3.5 here]

===SECTION 3.6===
[Extracted content for 3.6 here]

===SECTION 3.7===
[Extracted content for 3.7 here]

===SECTION 3.8===
[Extracted content for 3.8 here]

START DISTRIBUTION:`;
        }

        // Parse distributed text from AI response
        function parseDistributedText(aiResponse) {
            const sections = {};
            const sectionIds = ['3.1', '3.2', '3.3', '3.4', '3.5', '3.6', '3.7', '3.8'];

            sectionIds.forEach((id, index) => {
                const marker = `===SECTION ${id}===`;
                const nextMarker = index < sectionIds.length - 1 ? `===SECTION ${sectionIds[index + 1]}===` : null;

                const startIndex = aiResponse.indexOf(marker);
                if (startIndex === -1) {
                    sections[id] = null;
                    return;
                }

                const contentStart = startIndex + marker.length;
                const contentEnd = nextMarker ? aiResponse.indexOf(nextMarker) : aiResponse.length;

                if (contentEnd === -1) {
                    sections[id] = aiResponse.substring(contentStart).trim();
                } else {
                    sections[id] = aiResponse.substring(contentStart, contentEnd).trim();
                }

                // Clean up
                if (sections[id] === '[NO CONTENT FOUND]' || sections[id] === '') {
                    sections[id] = null;
                }
            });

            return sections;
        }

        // Local text distribution - SMART VERSION
        // Handles prompt-wrapped text from Copilot/Claude and extracts actual content
        function localDistributeText(fullText) {
            const sections = {
                '3.1': null,
                '3.2': null,
                '3.3': null,
                '3.4': null,
                '3.5': null,
                '3.6': null,
                '3.7': null,
                '3.8': null
            };

            let text = fullText;
            console.log('Original text length:', text.length);

            // STEP 1: Check if this is a prompt-wrapped text (from Copilot/Claude)
            // Look for content between """ markers (FULL INPUT TEXT: """..""")
            const tripleQuoteMatch = text.match(/FULL INPUT TEXT:\s*"""\s*([\s\S]*?)"""/i);
            if (tripleQuoteMatch) {
                console.log('‚úì Detected Copilot/Claude prompt wrapper - extracting actual content');
                text = tripleQuoteMatch[1].trim();
            } else {
                // Also try just finding content between """ markers
                const allQuotesMatch = text.match(/"""\s*([\s\S]*?)"""/);
                if (allQuotesMatch) {
                    console.log('‚úì Detected """ wrapper - extracting content');
                    text = allQuotesMatch[1].trim();
                }
            }

            console.log('Text length after wrapper removal:', text.length);

            // STEP 2: Remove file references like [<File>...</File> | PowerPoint]
            text = text.replace(/\[<File>[^<]*<\/File>\s*\|\s*\w+\]/g, '');
            text = text.replace(/\[[^\]]*\.\.\.[^\]]*\|[^\]]*\]/g, ''); // [Elisa Lead...P 2026 (1) | PDF]
            text = text.replace(/\[[^\]]*\.\.\.[^\]]*\]/g, ''); // Any remaining [.....] patterns

            // STEP 3: Find section headers like "3.1 Company Information ‚Äì Draft"
            // Pattern: "3.X" at start of line + title + optional "‚Äì Draft"
            const lines = text.split('\n');
            const sectionStarts = [];

            lines.forEach((line, lineIndex) => {
                // Match lines starting with "3.X " followed by a title
                const headerMatch = line.match(/^(3\.[1-8])\s+([A-Za-z√Ö√Ñ√ñ√•√§√∂][A-Za-z√Ö√Ñ√ñ√•√§√∂\s,&]+)/);
                if (headerMatch) {
                    const sectionId = headerMatch[1];
                    const title = headerMatch[2].trim();
                    // Only accept if title is substantial (not just "3.1" alone)
                    if (title.length > 3) {
                        sectionStarts.push({
                            id: sectionId,
                            title: title,
                            lineIndex: lineIndex
                        });
                        console.log(`Found section: ${sectionId} "${title}" at line ${lineIndex}`);
                    }
                }
            });

            // Remove duplicates - keep only first occurrence of each section
            const uniqueSections = [];
            const seenIds = new Set();
            for (const s of sectionStarts) {
                if (!seenIds.has(s.id)) {
                    seenIds.add(s.id);
                    uniqueSections.push(s);
                }
            }

            console.log(`Found ${uniqueSections.length} unique sections`);

            // STEP 4: Extract content between section headers
            uniqueSections.forEach((section, i) => {
                const startLine = section.lineIndex + 1; // Skip the header line
                const endLine = i < uniqueSections.length - 1
                    ? uniqueSections[i + 1].lineIndex
                    : lines.length;

                const contentLines = lines.slice(startLine, endLine);
                let content = contentLines.join('\n').trim();

                // Clean up the content
                content = content.replace(/\[<File>[^<]*<\/File>\s*\|\s*\w+\]/g, '');
                content = content.replace(/\[[^\]]*\.\.\.[^\]]*\]/g, '');

                // Remove Swedish editorial notes
                content = content.replace(/\(Denna volym kan ni justera[^)]*\)/gi, '');
                content = content.replace(/\(Eftersom jag inte ser[^)]*\)/gi, '');
                content = content.replace(/\(Om ni internt[^)]*\)/gi, '');
                content = content.replace(/\(Detta kan ni justera[^)]*\)/gi, '');

                // Clean multiple blank lines
                content = content.replace(/\n{3,}/g, '\n\n').trim();

                if (content.length > 0) {
                    sections[section.id] = content;
                    console.log(`Section ${section.id}: ${content.length} chars extracted`);
                }
            });

            const foundCount = Object.values(sections).filter(v => v !== null && v.length > 0).length;
            console.log(`‚úì Distribution complete: ${foundCount} sections with content`);

            return sections;
        }

        // AI Refine Prompt Generator - creates prompt for Claude/GPT
        function generateRefinePrompt(sectionId, rawText) {
            const section = rfpSections.find(s => s.id === sectionId);
            if (!section) return '';

            const businessValueGuidelines = `
ELISA BUSINESS VALUE GUIDELINES:
Elisa's strategy is "faster, profitable growth". Every statement must connect to:
- Revenue growth / market expansion
- Profitability / margin improvement
- Speed to market / faster decisions
- Operational efficiency / productivity
- Customer satisfaction / retention
- Innovation capability

LANGUAGE RULES:
‚ùå AVOID soft HR language like:
- "develop leadership capabilities"
- "create psychological safety"
- "build engagement"
- "coaching mindset"

‚úÖ USE business outcome language like:
- "accelerate decision-making that drives faster growth"
- "reduce friction costs that slow delivery"
- "increase team output by 15-25% through better coordination"
- "shorten time-to-market through empowered teams"

QUANTIFY when possible using phrases like:
- "typically delivers..."
- "research shows..."
- "similar programmes achieve..."
- Use ranges: 15-25%, 10-20%, etc.
`;

            const prompt = `You are helping prepare an RFP response for Elisa Corporation (Finnish telecom, ‚Ç¨2.2B revenue, strategy: "faster, profitable growth").

TASK: Clean and refine the following raw text for RFP Section ${section.id}: ${section.title}

RFP REQUIREMENTS FOR THIS SECTION:
${section.requirements.map((r, i) => `${i+1}. ${r}`).join('\n')}

${businessValueGuidelines}

RAW INPUT TEXT TO REFINE:
"""
${rawText}
"""

INSTRUCTIONS:
1. REMOVE all text that doesn't directly answer the RFP requirements above
2. RESTRUCTURE the remaining content to clearly address each requirement
3. REWRITE using Elisa's business language (growth, revenue, efficiency, speed)
4. ADD quantified impacts where possible (use "typically", "up to", ranges)
5. KEEP factual information (names, numbers, dates) but improve framing
6. FORMAT as clean bullet points or short paragraphs
7. MARK any missing required information as [FILL IN: description]

OUTPUT FORMAT:
Return ONLY the refined response text, ready to paste into the RFP.
No explanations, no meta-commentary - just the refined content.

REFINED RESPONSE:`;

            return prompt;
        }

        // AI Coach Prompt Generator - analyzes gaps and generates coaching to reach 100%
        function generateCoachPrompt(section, currentText, evaluation) {
            const missingRequirements = evaluation.checks
                .filter(c => c.confidence < 100)
                .map(c => `‚Ä¢ ${c.requirement} (currently ${c.confidence}% - ${c.confidence < 50 ? 'MISSING' : 'WEAK'})${c.debug?.missed?.length ? ` [missing terms: ${c.debug.missed.join(', ')}]` : ''}`);

            const strongRequirements = evaluation.checks
                .filter(c => c.confidence >= 100)
                .map(c => `‚Ä¢ ${c.requirement} ‚úì`);

            return `You are an RFP coach helping improve a response for Elisa Corporation (Finnish telecom, ‚Ç¨2.2B revenue, strategy: "faster, profitable growth").

SECTION: ${section.id} ${section.title}
CURRENT SCORE: ${evaluation.score}% (Target: 100%)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ REQUIREMENTS THAT ARE MET:
${strongRequirements.length > 0 ? strongRequirements.join('\n') : '(None fully met yet)'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ùå REQUIREMENTS THAT NEED IMPROVEMENT:
${missingRequirements.length > 0 ? missingRequirements.join('\n') : '(All requirements met!)'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
CURRENT RESPONSE:
"""
${currentText || '[Empty - no response yet]'}
"""

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
YOUR TASK:
Write an IMPROVED version that scores 100% by:

1. ADDRESSING every missing/weak requirement listed above
2. Using Elisa's business language:
   - "faster, profitable growth"
   - "accelerate decision-making"
   - "increase team productivity by X%"
   - "reduce time-to-market"
   - "drive revenue through..."

3. QUANTIFYING impact with specific numbers:
   - "typically delivers 15-25% improvement"
   - "reduces cycle time by 20-30%"
   - "programmes like this achieve..."

4. KEEPING existing good content but enhancing weak areas

5. STRUCTURING clearly so each requirement is visibly addressed

OUTPUT: Write the complete improved response below. No explanations - just the response text ready to paste.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
IMPROVED RESPONSE:`;
        }

        // ============================================
        // DOINGS EXPERT SKILL - RFP RESPONSE GUIDE
        // Section-specific guidance from the Doings Expert skill files
        // Available globally for all agents to use
        // ============================================
        const DOINGS_RFP_GUIDE = {
            brandVoice: {
                tone: 'Warm but professional - Never stiff or corporate',
                style: 'Action-oriented - Focus on "doing", not just knowing',
                focus: 'Results-driven - Emphasize behavioral change and business impact',
                positioning: 'Co-creative - Position as partner, not vendor'
            },
            keyPhrases: ['Learning by Doings', 'People Experts doing greater business', 'From words to action', 'Sustainable change', 'Maximize learning transfer'],
            methodology: 'Make it Happen ‚Üí Make the Change ‚Üí Make it Last',
            capabilities: [
                '1. Commit to the Journey - Vision, values, self-leadership, learning mindset',
                '2. Accelerate Development - Change management, growth mindset, innovation',
                '3. Create Psychological Safety - Trust, inclusion, communication, bias awareness',
                '4. Build Engagement - Motivation, feedback, coaching conversations',
                '5. Work Smarter - Prioritization, delegation, sustainable performance'
            ],
            sections: {
                '3.1': {
                    focus: 'Company Information',
                    positioning: 'Doings is a Nordic specialist agency focused exclusively on leadership and organisational development. We partner with organisations navigating transformation, growth, and cultural change.',
                    coreExpertise: ['Leadership development programmes (all levels)', 'Organisational culture and change management', 'Executive coaching and team development', 'Learning design and digital platforms'],
                    differentiators: ['Behavioural science foundation with practical application', 'Co-creation methodology ensuring relevance', 'Integrated digital and physical learning journeys', 'Measurement-driven approach with documented impact', 'The professionals you meet in sales deliver your programme']
                },
                '3.2': {
                    focus: 'Programme Design and Approach',
                    keyMessages: ['Relevance - Content addresses real challenges', 'Application - Learning through doing', 'Sustainability - Behavioral change through structure'],
                    approach: ['Co-creation process (Double Diamond)', 'Behavioral change approach', 'Customization for different levels', 'Integration across programme levels']
                },
                '3.3': {
                    focus: 'Content and Delivery',
                    levels: {
                        firstLine: { focus: 'Coach role', duration: '10-12 months', hours: '~50h', methods: 'Learning Buddies, Action Plans' },
                        midLevel: { focus: 'Coach + Challenger', duration: '6-8 months', hours: '~60h', methods: '360¬∞, Learning Groups, Business Dilemmas' },
                        vpExecutive: { focus: 'All three roles', duration: '8-12 months', hours: '~50h', methods: 'Peer Advisory, Coaching, Strategic Challenges' }
                    }
                },
                '3.4': {
                    focus: 'Trainer Qualifications',
                    commitment: 'The facilitators presented in this proposal are the same professionals who will deliver your programmes.',
                    elements: ['Name and photo', 'Background', 'Experience', 'Certifications (ICF)', 'Languages', 'Specialty areas']
                },
                '3.5': {
                    focus: 'Measurement and Impact',
                    framework: ['1. Reaction: NPS >60', '2. Learning: Capability growth', '3. Behavior: Action Plan completion >80%', '4. Impact: Engagement increase'],
                    results: ['+34% feedback capability', '+12pp psychological safety', '92% Action Plan completion', '87% behavior change']
                },
                '3.6': {
                    focus: 'Programme Delivery & Governance',
                    governance: 'Steering Committee (Quarterly) ‚Üí Operational Team (Monthly)',
                    reporting: ['Feedback after module', 'Progress monthly', 'Business review quarterly', 'Annual review']
                },
                '3.7': {
                    focus: 'Pricing and Commercial Terms',
                    pricing: { firstLine: '~32,000 SEK/participant', midLevel: '~37,000 SEK/participant', vpExecutive: '~74,000 SEK/participant' },
                    discounts: ['3+ cohorts: 10%', 'All levels: 15%', '3-year: 20%', 'Combined: 25%'],
                    terms: '30% signing, 50% start, 20% completion'
                },
                '3.8': {
                    focus: 'Compliance and Data Protection',
                    gdpr: ['Full GDPR compliance', 'DPA available', 'EU data storage', 'SOC 2 security'],
                    ip: { standard: 'Doings retains', custom: 'Joint ownership', participant: 'Participant owns' }
                }
            }
        };

        // Helper function to get section-specific Doings guidance
        function getDoingsGuidanceForSection(sectionId) {
            const section = DOINGS_RFP_GUIDE.sections[sectionId] || {};
            return `
### DOINGS EXPERT GUIDANCE FOR SECTION ${sectionId}
Focus: ${section.focus || 'General'}

Brand Voice:
- ${DOINGS_RFP_GUIDE.brandVoice.tone}
- ${DOINGS_RFP_GUIDE.brandVoice.style}

Key Phrases: ${DOINGS_RFP_GUIDE.keyPhrases.slice(0, 3).join(', ')}

Methodology: ${DOINGS_RFP_GUIDE.methodology}

${section.positioning ? `Positioning: ${section.positioning}` : ''}
${section.differentiators ? `Differentiators:\n${section.differentiators.map(d => `- ${d}`).join('\n')}` : ''}
${section.keyMessages ? `Key Messages:\n${section.keyMessages.map(m => `- ${m}`).join('\n')}` : ''}
${section.levels ? `Levels:\n- First-Line: ${section.levels.firstLine.focus}, ${section.levels.firstLine.duration}\n- Mid-Level: ${section.levels.midLevel.focus}\n- VP/Executive: ${section.levels.vpExecutive.focus}` : ''}
${section.framework ? `Measurement: ${section.framework.join(', ')}` : ''}
${section.pricing ? `Pricing: First-Line ${section.pricing.firstLine}, Mid-Level ${section.pricing.midLevel}` : ''}
${section.commitment ? `Commitment: "${section.commitment}"` : ''}
`.trim();
        }

        // Components
        function ScoreRing({ score, size = 80 }) {
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (score / 100) * circumference;
            const color = score >= 80 ? '#10B981' : score >= 60 ? '#F59E0B' : '#EF4444';

            return (
                <svg width={size} height={size} viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#E5E7EB" strokeWidth="8" />
                    <circle cx="50" cy="50" r="45" fill="none" stroke={color} strokeWidth="8"
                        strokeDasharray={circumference} strokeDashoffset={offset}
                        className="score-ring transition-all duration-500" />
                    <text x="50" y="55" textAnchor="middle" fontSize="24" fontWeight="bold" fill={color}>{score}</text>
                </svg>
            );
        }

        function RequirementCheck({ check }) {
            const [showDebug, setShowDebug] = useState(false);
            const statusColors = {
                complete: 'bg-green-100 text-green-800 border-green-200',
                partial: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                missing: 'bg-red-100 text-red-800 border-red-200'
            };
            const statusIcons = { complete: '‚úì', partial: '‚óê', missing: '‚úó' };

            return (
                <div className={`p-3 rounded-lg border ${statusColors[check.status]} mb-2`}>
                    <div className="flex items-start gap-2">
                        <span className="text-lg">{statusIcons[check.status]}</span>
                        <div className="flex-1">
                            <p className="text-sm font-medium">{check.requirement}</p>
                            {check.suggestion && <p className="text-xs mt-1 opacity-75">üí° {check.suggestion}</p>}

                            {/* Debug toggle - show scoring breakdown */}
                            {check.debug && (
                                <button
                                    onClick={() => setShowDebug(!showDebug)}
                                    className="text-xs mt-2 text-blue-600 hover:text-blue-800 underline"
                                >
                                    {showDebug ? '‚ñº D√∂lj scoring-detaljer' : '‚ñ∂ Visa varf√∂r denna score'}
                                </button>
                            )}

                            {/* Expanded debug info */}
                            {showDebug && check.debug && (
                                <div className="mt-2 p-2 bg-white/50 rounded text-xs border border-current/20">
                                    <p className="font-mono mb-1"><strong>Algoritm:</strong> {check.debug.ratio}</p>
                                    <div className="flex flex-wrap gap-1 mb-1">
                                        <span className="font-medium">Matchade:</span>
                                        {check.debug.matched.length > 0 ? check.debug.matched.map((t, i) => (
                                            <span key={i} className="px-1 bg-green-200 text-green-800 rounded">{t}</span>
                                        )) : <span className="italic opacity-75">inga</span>}
                                    </div>
                                    <div className="flex flex-wrap gap-1">
                                        <span className="font-medium">Missade:</span>
                                        {check.debug.missed.length > 0 ? check.debug.missed.map((t, i) => (
                                            <span key={i} className="px-1 bg-red-200 text-red-800 rounded">{t}</span>
                                        )) : <span className="italic opacity-75">inga</span>}
                                    </div>
                                    {check.debug.missed.length > 0 && (
                                        <p className="mt-1 text-orange-700">
                                            üí° L√§gg till orden <strong>{check.debug.missed.join(', ')}</strong> f√∂r h√∂gre score
                                        </p>
                                    )}
                                </div>
                            )}
                        </div>
                        <span className="text-xs font-mono">{check.confidence}%</span>
                    </div>
                </div>
            );
        }

        // Text Import Modal
        function TextImportModal({ isOpen, onClose, onApply }) {
            const [inputText, setInputText] = useState('');
            const [preview, setPreview] = useState(null);

            const handleParse = () => {
                const extracted = parseInputText(inputText);
                setPreview(extracted);
            };

            const handleApply = () => {
                const extracted = parseInputText(inputText);
                onApply(extracted);
                setInputText('');
                setPreview(null);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                        <div className="gradient-bg text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">üì• Klistra Doings-info (org.nr, priser, namn)</h2>
                                    <p className="text-teal-200 text-sm">Klistra in TEXT (ej filer) med f√∂retagsinfo ‚Üí vi parsear automatiskt</p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Paste your text here (company info, prices, names, metrics...)
                                    </label>
                                    <textarea
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        placeholder={`Klistra in text i valfritt format. Exempel:

Doings AB
Org.nr: 556123-4567
VAT: SE556123456701
Grundat: 2015
Oms√§ttning: 45 MSEK
Anst√§llda: 28

KAM: Anna Lindqvist
VP Programme: Erik Johansson
Mid-level lead: Maria Svensson
First-line lead: Johan Andersson

Certifieringar: ICF PCC, MBTI

First-line: 2500 EUR
Mid-level: 4200 EUR
VP: 8500 EUR

Referens: Alleima, Volvo, Ericsson

Resultat fr√•n tidigare:
‚Ä¢ NPS f√∂rb√§ttring 35%
‚Ä¢ Feedback +42%
‚Ä¢ Action plan completion 89%

---
Parsern k√§nner igen de flesta format!
Testa att klistra in och klicka Preview.`}
                                        className="w-full h-64 p-3 border border-gray-300 rounded-lg text-sm font-mono resize-none focus:ring-2 focus:ring-teal-500"
                                    />
                                    <button
                                        onClick={handleParse}
                                        className="mt-3 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors"
                                    >
                                        üîç Preview Extraction
                                    </button>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Extracted Data Preview
                                    </label>
                                    <div className="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto text-sm">
                                        {preview ? (
                                            <div className="space-y-3">
                                                {preview.registrationNumber && (
                                                    <div><span className="font-medium">Registration:</span> <span className="highlight">{preview.registrationNumber}</span></div>
                                                )}
                                                {preview.vatNumber && (
                                                    <div><span className="font-medium">VAT:</span> <span className="highlight">{preview.vatNumber}</span></div>
                                                )}
                                                {preview.foundedYear && (
                                                    <div><span className="font-medium">Founded:</span> <span className="highlight">{preview.foundedYear}</span></div>
                                                )}
                                                {preview.revenue && (
                                                    <div><span className="font-medium">Revenue:</span> <span className="highlight">{preview.revenue}</span></div>
                                                )}
                                                {preview.employees && (
                                                    <div><span className="font-medium">Employees:</span> <span className="highlight">{preview.employees}</span></div>
                                                )}
                                                {preview.keyAccountManager && (
                                                    <div><span className="font-medium">Key Account Manager:</span> <span className="highlight">{preview.keyAccountManager}</span></div>
                                                )}
                                                {preview.facilitators.length > 0 && (
                                                    <div><span className="font-medium">Facilitators:</span> <span className="highlight">{preview.facilitators.join(', ')}</span></div>
                                                )}
                                                {preview.certifications.length > 0 && (
                                                    <div><span className="font-medium">Certifications:</span> <span className="highlight">{preview.certifications.join(', ')}</span></div>
                                                )}
                                                {(preview.prices.firstLine || preview.prices.midLevel || preview.prices.vp) && (
                                                    <div>
                                                        <span className="font-medium">Prices:</span>
                                                        <ul className="ml-4 mt-1">
                                                            {preview.prices.firstLine && <li>First-line: <span className="highlight">{preview.prices.firstLine} EUR</span></li>}
                                                            {preview.prices.midLevel && <li>Mid-level: <span className="highlight">{preview.prices.midLevel} EUR</span></li>}
                                                            {preview.prices.vp && <li>VP: <span className="highlight">{preview.prices.vp} EUR</span></li>}
                                                        </ul>
                                                    </div>
                                                )}
                                                {preview.metrics.length > 0 && (
                                                    <div>
                                                        <span className="font-medium">Metrics:</span>
                                                        <ul className="ml-4 mt-1">
                                                            {preview.metrics.slice(0,5).map((m, i) => <li key={i} className="highlight">{m}</li>)}
                                                        </ul>
                                                    </div>
                                                )}
                                                {preview.references.length > 0 && (
                                                    <div><span className="font-medium">References:</span> <span className="highlight">{preview.references.join(', ')}</span></div>
                                                )}
                                                {!preview.registrationNumber && !preview.vatNumber && !preview.foundedYear &&
                                                 !preview.keyAccountManager && preview.facilitators.length === 0 &&
                                                 !preview.prices.firstLine && preview.metrics.length === 0 && (
                                                    <p className="text-gray-500 italic">No structured data detected. Try adding labels like "Registration:", "Price:", "Facilitator:" etc.</p>
                                                )}
                                            </div>
                                        ) : (
                                            <p className="text-gray-500 italic">Paste text and click "Preview Extraction" to see what data can be extracted</p>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                                <h4 className="font-medium text-blue-800 mb-2">üí° Format som fungerar</h4>
                                <ul className="text-sm text-blue-700 space-y-1">
                                    <li>‚Ä¢ <strong>Org.nr:</strong> 556123-4567 eller Registration: 5561234567</li>
                                    <li>‚Ä¢ <strong>Priser:</strong> "First-line: 2500 EUR" eller "2 500‚Ç¨ f√∂r first-line"</li>
                                    <li>‚Ä¢ <strong>Personer:</strong> "KAM: Anna Lindqvist" eller "VP Programme: Erik Johansson"</li>
                                    <li>‚Ä¢ <strong>Certifikat:</strong> ICF PCC, MCC, MBTI, Hogan etc (hittas automatiskt)</li>
                                    <li>‚Ä¢ <strong>Metrics:</strong> Rader med procent hittas: "NPS +35%"</li>
                                    <li>‚Ä¢ <strong>Referenser:</strong> "Referens: Alleima, Volvo" eller "Kund: Ericsson"</li>
                                </ul>
                                <p className="text-xs text-blue-600 mt-2">Fungerar med svenska OCH engelska etiketter!</p>
                            </div>
                        </div>

                        <div className="border-t p-4 bg-gray-50 flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Cancel
                            </button>
                            <button
                                onClick={handleApply}
                                disabled={!inputText.trim()}
                                className="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ‚ú® Apply to Responses
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Smart Distribute Modal - SIMPLE ONE-CLICK VERSION
        function DistributeModal({ isOpen, onClose, onApplyDistributed }) {
            const [fullText, setFullText] = useState('');
            const [status, setStatus] = useState(null); // null, 'success', 'error'
            const [result, setResult] = useState(null);

            if (!isOpen) return null;

            const handleDistribute = () => {
                if (!fullText.trim()) return;

                console.log('=== SMART DISTRIBUTE START ===');
                const distributed = localDistributeText(fullText);
                const foundCount = Object.values(distributed).filter(v => v !== null && v.length > 0).length;

                if (foundCount > 0) {
                    setResult(distributed);
                    setStatus('success');
                    // Auto-apply after short delay
                    setTimeout(() => {
                        onApplyDistributed(distributed);
                        setFullText('');
                        setStatus(null);
                        setResult(null);
                        onClose();
                    }, 1500);
                } else {
                    setStatus('error');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
                        <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">üéØ F√∂rdela AI-genererat svar till 3.1-3.8</h2>
                                    <p className="text-orange-200 text-sm">Klistra in ‚Üí Klicka ‚Üí Klart!</p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6">
                            {status === 'success' ? (
                                <div className="text-center py-8">
                                    <div className="text-6xl mb-4">‚úÖ</div>
                                    <h3 className="text-xl font-bold text-green-700 mb-2">F√∂rdelning klar!</h3>
                                    <p className="text-gray-600 mb-4">
                                        Hittade {Object.values(result).filter(v => v).length} sektioner
                                    </p>
                                    <div className="flex flex-wrap gap-2 justify-center">
                                        {Object.entries(result).map(([id, content]) => (
                                            <span key={id} className={`px-3 py-1 rounded-full text-sm ${content ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}`}>
                                                {content ? '‚úì' : '‚óã'} {id}
                                            </span>
                                        ))}
                                    </div>
                                    <p className="text-sm text-gray-500 mt-4">Applicerar automatiskt...</p>
                                </div>
                            ) : status === 'error' ? (
                                <div className="text-center py-8">
                                    <div className="text-6xl mb-4">‚ùå</div>
                                    <h3 className="text-xl font-bold text-red-700 mb-2">Kunde inte hitta sektioner</h3>
                                    <p className="text-gray-600 mb-4">
                                        Texten m√•ste inneh√•lla rubriker som:<br/>
                                        <code className="bg-gray-100 px-2 py-1 rounded">3.1 Company Information</code>
                                    </p>
                                    <button
                                        onClick={() => setStatus(null)}
                                        className="px-4 py-2 bg-gray-600 text-white rounded-lg"
                                    >
                                        F√∂rs√∂k igen
                                    </button>
                                </div>
                            ) : (
                                <>
                                    <textarea
                                        value={fullText}
                                        onChange={(e) => setFullText(e.target.value)}
                                        placeholder="Klistra in hela texten h√§r (3.1 - 3.8)...

Texten ska inneh√•lla sektionsrubriker som:
3.1 Company Information
3.2 Programme Design
3.3 Content and Delivery
osv..."
                                        className="w-full h-64 p-4 border-2 border-gray-200 rounded-xl text-sm resize-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                        autoFocus
                                    />

                                    <button
                                        onClick={handleDistribute}
                                        disabled={!fullText.trim()}
                                        className="w-full mt-4 py-4 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-bold text-lg hover:from-orange-600 hover:to-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        üöÄ F√ñRDELA TILL ALLA SEKTIONER
                                    </button>

                                    <p className="text-center text-xs text-gray-400 mt-3">
                                        Fungerar med text fr√•n Copilot, Claude, eller manuellt skriven text
                                    </p>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // AI Refine Modal - generates prompt and handles refined text
        // ============================================
        // AGENT-POWERED REFINE MODAL (Replaces external ChatGPT workflow)
        // Calls Claude API directly, shows inline suggestions
        // ============================================
        function RefineModal({ isOpen, onClose, section, currentText, onApplyRefined, apiKey, customerIntelligence, doingsKnowledge }) {
            const [isLoading, setIsLoading] = useState(false);
            const [suggestion, setSuggestion] = useState(null);
            const [error, setError] = useState(null);
            const [showDiff, setShowDiff] = useState(true);

            useEffect(() => {
                if (isOpen && apiKey && !suggestion && !isLoading) {
                    runRefineAgent();
                }
            }, [isOpen, apiKey]);

            const runRefineAgent = async () => {
                if (!apiKey) {
                    setError('Ingen API-nyckel konfigurerad. G√• till Inst√§llningar f√∂r att aktivera AI-agenter.');
                    return;
                }

                setIsLoading(true);
                setError(null);
                setSuggestion(null);

                try {
                    const prompt = buildAgentRefinePrompt(section, currentText, customerIntelligence, doingsKnowledge);
                    const result = await callClaudeAPI(apiKey, prompt);
                    setSuggestion(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const buildAgentRefinePrompt = (section, text, intel, doings) => {
                const customerContext = intel ? `
Customer Context (${intel.sourceCount || 0} sources):
- Strategic priorities: ${intel.strategicPriorities?.keyFindings?.slice(0, 3).join('; ') || 'Not available'}
- Challenges: ${intel.currentChallenges?.keyFindings?.slice(0, 2).join('; ') || 'Not available'}
- Culture: ${intel.companyCulture?.keyFindings?.slice(0, 2).join('; ') || 'Not available'}
- Decision makers: ${intel.keyStakeholders?.map(s => `${s.name} (${s.role})`).join(', ') || 'Not specified'}
` : '';

                const doingsContext = doings?.loaded ? `
Doings Knowledge:
- Methodology: ${doings.methodology?.name} - ${doings.methodology?.pillars?.join(', ')}
- Differentiators: ${doings.differentiators?.slice(0, 3).join('; ')}
` : '';

                return `You are a senior RFP writer for Doings (leadership development).

Assignment: Improve and refine the response for section ${section.id} "${section.title}" in an RFP for Elisa.

${customerContext}
${doingsContext}

RFP Requirements for Section ${section.id}:
${section.requirements.map((r, i) => `${i + 1}. ${r}`).join('\n')}

Evaluation criterion: ${section.evaluationCriteria}
Weight: ${section.weight}%

Current Response to Improve:
${text}

Instructions:
1. Keep everything that is good, improve what can be better
2. Address all RFP requirements explicitly
3. Use Elisa's own terminology and strategy where possible
4. Make the text more persuasive and business-like
5. Remove or fill in [MISSING] placeholders with reasonable values if possible
6. Keep the structure if it works
7. Max 500 words

Important formatting rules:
- Write in English only
- Do not use emojis
- Do not use all caps for entire words
- Do not use markdown like ** or ##
- Headings can use Title Case followed by colon (e.g., "Heading:")

Respond only with the improved response. No introduction, explanation or markdown.`;
            };

            const handleAccept = () => {
                if (suggestion) {
                    onApplyRefined(suggestion);
                    setSuggestion(null);
                    onClose();
                }
            };

            const handleReject = () => {
                setSuggestion(null);
                onClose();
            };

            const handleRegenerate = () => {
                setSuggestion(null);
                runRefineAgent();
            };

            if (!isOpen || !section) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">ü§ñ AI-Agent F√∂rb√§ttrar - {section.id}: {section.title}</h2>
                                    <p className="text-purple-200 text-sm">
                                        {isLoading ? '‚è≥ Agenten analyserar och f√∂rb√§ttrar...' :
                                         suggestion ? '‚úÖ F√∂rslag klart - granska och godk√§nn' :
                                         error ? '‚ö†Ô∏è N√•got gick fel' : 'Klar att k√∂ra'}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* Loading State */}
                            {isLoading && (
                                <div className="flex flex-col items-center justify-center py-16">
                                    <div className="animate-spin rounded-full h-16 w-16 border-4 border-purple-200 border-t-purple-600 mb-4"></div>
                                    <p className="text-lg font-medium text-gray-700">üß† Refine Agent arbetar...</p>
                                    <p className="text-sm text-gray-500 mt-2">Analyserar RFP-krav och f√∂rb√§ttrar text</p>
                                    <div className="mt-4 flex gap-2 text-xs text-gray-400">
                                        <span className="px-2 py-1 bg-gray-100 rounded">üìã {section.requirements.length} krav</span>
                                        <span className="px-2 py-1 bg-gray-100 rounded">‚öñÔ∏è {section.weight}% vikt</span>
                                        {customerIntelligence && <span className="px-2 py-1 bg-green-100 text-green-700 rounded">üî¨ Kundinsikt aktiv</span>}
                                    </div>
                                </div>
                            )}

                            {/* Error State */}
                            {error && !isLoading && (
                                <div className="p-6 bg-red-50 rounded-xl border border-red-200">
                                    <h3 className="text-lg font-semibold text-red-800 mb-2">‚ö†Ô∏è Kunde inte k√∂ra agenten</h3>
                                    <p className="text-red-700 mb-4">{error}</p>
                                    <div className="flex gap-3">
                                        <button onClick={runRefineAgent} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                            üîÑ F√∂rs√∂k igen
                                        </button>
                                        <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">
                                            Avbryt
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Suggestion with Accept/Reject */}
                            {suggestion && !isLoading && (
                                <div>
                                    {/* Toggle view */}
                                    <div className="flex gap-2 mb-4">
                                        <button
                                            onClick={() => setShowDiff(true)}
                                            className={`px-3 py-1 rounded-lg text-sm ${showDiff ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                                        >
                                            üìä J√§mf√∂r (f√∂re/efter)
                                        </button>
                                        <button
                                            onClick={() => setShowDiff(false)}
                                            className={`px-3 py-1 rounded-lg text-sm ${!showDiff ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                                        >
                                            üìù Endast nytt
                                        </button>
                                    </div>

                                    {showDiff ? (
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <h4 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                                    <span className="w-3 h-3 bg-red-400 rounded-full"></span>
                                                    Nuvarande svar
                                                </h4>
                                                <div className="p-4 bg-red-50 border border-red-200 rounded-lg max-h-80 overflow-y-auto">
                                                    <pre className="text-sm text-gray-700 whitespace-pre-wrap">{currentText}</pre>
                                                </div>
                                            </div>
                                            <div>
                                                <h4 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                                    <span className="w-3 h-3 bg-green-400 rounded-full"></span>
                                                    AI-f√∂rb√§ttrat svar
                                                </h4>
                                                <div className="p-4 bg-green-50 border border-green-200 rounded-lg max-h-80 overflow-y-auto">
                                                    <pre className="text-sm text-gray-700 whitespace-pre-wrap">{suggestion}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <h4 className="font-medium text-gray-700 mb-2">ü§ñ AI-genererat f√∂rslag</h4>
                                            <div className="p-4 bg-white border-2 border-purple-300 rounded-lg max-h-96 overflow-y-auto">
                                                <pre className="text-sm text-gray-700 whitespace-pre-wrap">{suggestion}</pre>
                                            </div>
                                        </div>
                                    )}

                                    {/* Action Buttons */}
                                    <div className="mt-6 flex gap-3 justify-end border-t pt-4">
                                        <button onClick={handleRegenerate} className="px-4 py-2 text-purple-600 hover:text-purple-700 flex items-center gap-1">
                                            üîÑ Generera nytt
                                        </button>
                                        <button onClick={handleReject} className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                            ‚ùå Avvisa
                                        </button>
                                        <button onClick={handleAccept} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                            ‚úÖ Anv√§nd detta svar
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* No API Key State */}
                            {!apiKey && !isLoading && !error && (
                                <div className="p-6 bg-amber-50 rounded-xl border border-amber-200 text-center">
                                    <h3 className="text-lg font-semibold text-amber-800 mb-2">üîë API-nyckel kr√§vs</h3>
                                    <p className="text-amber-700 mb-4">
                                        F√∂r att aktivera AI-agenter beh√∂ver du konfigurera din Claude API-nyckel i Inst√§llningar.
                                    </p>
                                    <button onClick={onClose} className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700">
                                        St√§ng
                                    </button>
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 bg-gray-50">
                            <div className="flex items-center justify-between text-xs text-gray-500">
                                <span>ü§ñ Refine Agent ‚Ä¢ Sektion {section.id} ‚Ä¢ {section.requirements.length} krav</span>
                                {customerIntelligence && <span className="text-green-600">üî¨ Kundinsikt: {customerIntelligence.sourceCount} k√§llor</span>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // AGENT-POWERED COACH MODAL (Replaces external ChatGPT workflow)
        // AI Coach analyzes gaps and generates complete solution in-app
        // ============================================
        function CoachModal({ isOpen, onClose, section, currentText, evaluation, onApplyCoached, apiKey, customerIntelligence, doingsKnowledge }) {
            const [isLoading, setIsLoading] = useState(false);
            const [suggestion, setSuggestion] = useState(null);
            const [error, setError] = useState(null);

            const missingCount = evaluation?.checks?.filter(c => c.confidence < 100).length || 0;
            const totalCount = evaluation?.checks?.length || 0;
            const metCount = totalCount - missingCount;

            useEffect(() => {
                if (isOpen && apiKey && !suggestion && !isLoading) {
                    runCoachAgent();
                }
            }, [isOpen, apiKey]);

            const runCoachAgent = async () => {
                if (!apiKey) {
                    setError('Ingen API-nyckel konfigurerad. G√• till Inst√§llningar f√∂r att aktivera AI-agenter.');
                    return;
                }

                setIsLoading(true);
                setError(null);
                setSuggestion(null);

                try {
                    const prompt = buildAgentCoachPrompt();
                    const result = await callClaudeAPI(apiKey, prompt);
                    setSuggestion(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const buildAgentCoachPrompt = () => {
                const gaps = evaluation?.checks?.filter(c => c.confidence < 100) || [];
                const met = evaluation?.checks?.filter(c => c.confidence >= 100) || [];

                const customerContext = customerIntelligence ? `
Customer Context (${customerIntelligence.sourceCount || 0} sources):
- Strategy: ${customerIntelligence.strategicPriorities?.keyFindings?.slice(0, 3).join('; ') || 'Not available'}
- Challenges: ${customerIntelligence.currentChallenges?.keyFindings?.slice(0, 2).join('; ') || 'Not available'}
- Decision makers: ${customerIntelligence.keyStakeholders?.map(s => `${s.name} (${s.role})`).join(', ') || 'Not specified'}
` : '';

                return `You are an AI Coach for RFP responses. Your task is to take a response from ${evaluation.score}% to 100%.

Section: ${section.id} "${section.title}"
Weight: ${section.weight}%
Evaluation criterion: ${section.evaluationCriteria}

${customerContext}

Requirements that are met (${met.length}):
${met.map(c => `[Met] ${c.requirement}`).join('\n') || 'None yet'}

Requirements that are missing or need improvement (${gaps.length}):
${gaps.map(c => `[Gap] ${c.requirement} (${c.confidence}% - ${c.note || 'Needs improvement'})`).join('\n')}

Current Response:
${currentText}

Instructions:
1. Keep everything that works well (the met requirements)
2. Add or improve for each missing requirement
3. Be concrete and specific - avoid vague formulations
4. Fill in [MISSING] placeholders with reasonable values
5. Use Elisa's business language: "faster, profitable growth", "Coach-Challenger-Connector"
6. Structure with clear headings where appropriate
7. Goal: 100% on all requirements

Important formatting rules:
- Write in English only
- Do not use emojis
- Do not use all caps for entire words
- Do not use markdown like ** or ##
- Headings can use Title Case followed by colon (e.g., "Heading:")
- Lists with dashes (-) are ok

Deliver only the complete improved response. No explanations. No markdown.`;
            };

            const handleAccept = () => {
                if (suggestion) {
                    onApplyCoached(suggestion);
                    setSuggestion(null);
                    onClose();
                }
            };

            const handleReject = () => {
                setSuggestion(null);
                onClose();
            };

            if (!isOpen || !section) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-amber-500 to-orange-500 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">üéØ AI Coach Agent - N√• 100% p√• {section.id}</h2>
                                    <p className="text-amber-100 text-sm">
                                        {isLoading ? '‚è≥ Agenten analyserar gaps...' :
                                         suggestion ? '‚úÖ Komplett l√∂sning genererad!' :
                                         `${evaluation.score}% ‚Üí 100% | ${missingCount} krav beh√∂ver f√∂rb√§ttras`}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* Gap Analysis - Always visible */}
                            <div className="mb-6 grid md:grid-cols-2 gap-4">
                                <div className="p-4 bg-green-50 rounded-lg">
                                    <h4 className="font-medium text-green-800 mb-2">‚úÖ Uppfyllda krav ({metCount})</h4>
                                    <ul className="text-sm text-green-700 space-y-1 max-h-32 overflow-y-auto">
                                        {evaluation?.checks?.filter(c => c.confidence >= 100).map((c, i) => (
                                            <li key={i}>‚Ä¢ {c.requirement}</li>
                                        ))}
                                        {metCount === 0 && <li className="italic">Inga krav √§r helt uppfyllda √§nnu</li>}
                                    </ul>
                                </div>
                                <div className="p-4 bg-red-50 rounded-lg">
                                    <h4 className="font-medium text-red-800 mb-2">‚ùå Beh√∂ver f√∂rb√§ttras ({missingCount})</h4>
                                    <ul className="text-sm text-red-700 space-y-1 max-h-32 overflow-y-auto">
                                        {evaluation?.checks?.filter(c => c.confidence < 100).map((c, i) => (
                                            <li key={i} className="flex justify-between">
                                                <span>‚Ä¢ {c.requirement}</span>
                                                <span className={`font-medium ${c.confidence < 50 ? 'text-red-600' : 'text-yellow-600'}`}>
                                                    {c.confidence}%
                                                </span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>

                            {/* Loading State */}
                            {isLoading && (
                                <div className="flex flex-col items-center justify-center py-12 bg-gradient-to-b from-amber-50 to-orange-50 rounded-xl">
                                    <div className="animate-spin rounded-full h-16 w-16 border-4 border-amber-200 border-t-amber-600 mb-4"></div>
                                    <p className="text-lg font-medium text-amber-800">üéØ Coach Agent arbetar...</p>
                                    <p className="text-sm text-amber-600 mt-2">Analyserar {missingCount} gaps och genererar 100%-l√∂sning</p>
                                </div>
                            )}

                            {/* Error State */}
                            {error && !isLoading && (
                                <div className="p-6 bg-red-50 rounded-xl border border-red-200">
                                    <h3 className="text-lg font-semibold text-red-800 mb-2">‚ö†Ô∏è Kunde inte k√∂ra Coach Agent</h3>
                                    <p className="text-red-700 mb-4">{error}</p>
                                    <div className="flex gap-3">
                                        <button onClick={runCoachAgent} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                            üîÑ F√∂rs√∂k igen
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Suggestion with Accept/Reject */}
                            {suggestion && !isLoading && (
                                <div>
                                    <div className="p-3 bg-green-100 border border-green-300 rounded-lg mb-4">
                                        <p className="text-green-800 font-medium">‚úÖ AI Coach har genererat ett svar som adresserar alla {totalCount} krav!</p>
                                    </div>

                                    <div className="grid md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <h4 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                                <span className="w-3 h-3 bg-red-400 rounded-full"></span>
                                                Nuvarande ({evaluation.score}%)
                                            </h4>
                                            <div className="p-3 bg-gray-50 border rounded-lg max-h-64 overflow-y-auto">
                                                <pre className="text-xs text-gray-600 whitespace-pre-wrap">{currentText}</pre>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-medium text-gray-700 mb-2 flex items-center gap-2">
                                                <span className="w-3 h-3 bg-green-400 rounded-full"></span>
                                                Coach-f√∂rslag (‚Üí100%)
                                            </h4>
                                            <div className="p-3 bg-green-50 border border-green-200 rounded-lg max-h-64 overflow-y-auto">
                                                <pre className="text-xs text-gray-700 whitespace-pre-wrap">{suggestion}</pre>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Action Buttons */}
                                    <div className="flex gap-3 justify-end border-t pt-4">
                                        <button onClick={() => { setSuggestion(null); runCoachAgent(); }} className="px-4 py-2 text-amber-600 hover:text-amber-700">
                                            üîÑ Generera nytt
                                        </button>
                                        <button onClick={handleReject} className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                            ‚ùå Avvisa
                                        </button>
                                        <button onClick={handleAccept} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                            ‚úÖ Anv√§nd & sikta p√• 100%
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* No API Key */}
                            {!apiKey && !isLoading && !error && (
                                <div className="p-6 bg-amber-50 rounded-xl border border-amber-200 text-center">
                                    <h3 className="text-lg font-semibold text-amber-800 mb-2">üîë API-nyckel kr√§vs</h3>
                                    <p className="text-amber-700">Konfigurera din Claude API-nyckel i Inst√§llningar f√∂r att aktivera AI Coach.</p>
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 bg-gradient-to-r from-amber-50 to-orange-50">
                            <div className="flex items-center justify-between">
                                <div className="text-xs text-amber-700">
                                    üéØ Coach Agent ‚Ä¢ {missingCount} gaps att l√∂sa ‚Ä¢ Automatisk 100%-generering
                                </div>
                                <div className="text-sm font-bold text-orange-700">
                                    {evaluation.score}% ‚Üí 100%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // SECTION CARD WITH AGENT-POWERED ACTIONS
        // Now with in-app AI actions, no external ChatGPT
        // ============================================
        function SectionCard({ section, response, onResponseChange, evaluation, apiKey, customerIntelligence, doingsKnowledge }) {
            const [isExpanded, setIsExpanded] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [localResponse, setLocalResponse] = useState(response);
            const [showRefineModal, setShowRefineModal] = useState(false);
            const [showCoachModal, setShowCoachModal] = useState(false);

            // NEW: Agent-powered inline suggestion state
            const [inlineSuggestion, setInlineSuggestion] = useState(null);
            const [suggestionType, setSuggestionType] = useState(null); // 'fill-gaps' | 'weakness' | 'quick-improve'
            const [isAgentWorking, setIsAgentWorking] = useState(false);

            useEffect(() => { setLocalResponse(response); }, [response]);

            const handleSave = () => {
                onResponseChange(section.id, localResponse);
                setIsEditing(false);
            };

            const handleApplyRefined = (refined) => {
                setLocalResponse(refined);
                onResponseChange(section.id, refined);
            };

            const handleApplyCoached = (coached) => {
                setLocalResponse(coached);
                onResponseChange(section.id, coached);
            };

            // NEW: Agent action - Fill Gaps (uses Doings Expert Skill)
            const runFillGapsAgent = async () => {
                if (!apiKey) return;
                setIsAgentWorking(true);
                setSuggestionType('fill-gaps');

                try {
                    const gaps = evaluation?.gaps || [];
                    const doingsGuide = getDoingsGuidanceForSection(section.id);
                    const prompt = `You are the Doings Expert Agent. Fill in the missing parts ([MISSING], gaps) in this RFP response.

Section: ${section.id} "${section.title}"

${doingsGuide}

Identified Gaps:
${gaps.map(g => `- ${g}`).join('\n') || 'Look for [MISSING], [FILL IN], vague formulations.'}

Current Response:
${localResponse}

${customerIntelligence ? `Customer Context (Elisa): ${customerIntelligence.strategicPriorities?.keyFindings?.slice(0, 2).join('; ') || 'Faster, profitable growth'}` : ''}

Instructions:
1. Find all [MISSING], [FILL IN], [CLARIFY], or empty fields
2. Fill in with concrete values from the Doings Expert guide above
3. Use Doings-specific prices, methods, and formulations
4. Keep everything else exactly as it is
5. If you need real data, write [To be verified: suggested value]

Important formatting rules:
- Write in English only
- Do not use emojis
- Do not use all caps for entire words
- Do not use markdown like ** or ##
- Headings can use Title Case followed by colon (e.g., "Heading:")

Respond only with the complete updated response. No markdown, no explanations.`;

                    const result = await callClaudeAPI(apiKey, prompt);
                    setInlineSuggestion(result);
                } catch (err) {
                    console.error('Fill gaps agent error:', err);
                } finally {
                    setIsAgentWorking(false);
                }
            };

            // NEW: Agent action - Find Weaknesses (uses Doings Expert Skill)
            const runWeaknessAgent = async () => {
                if (!apiKey) return;
                setIsAgentWorking(true);
                setSuggestionType('weakness');

                try {
                    const doingsGuide = getDoingsGuidanceForSection(section.id);
                    const prompt = `You are a critical RFP reviewer with expertise in Doings methodology.

Section: ${section.id} "${section.title}"
RFP Requirements: ${section.requirements.join('; ')}
Evaluation Criterion: ${section.evaluationCriteria}

${doingsGuide}

Current Response:
${localResponse}

Current Score: ${evaluation.score}%

Task: Analyze the response against the Doings Expert guide and provide 3-5 specific weaknesses.

Format each weakness as:

Weakness 1: [Brief description of the issue]
Action: [Concrete suggestion based on Doings methodology]

Weakness 2: [Brief description]
Action: [Suggestion]

(Continue for 3-5 weaknesses)

Focus on:
- Are Doings key phrases and methodology descriptions missing?
- Is pricing/structure aligned with Doings standards?
- Is the tone "warm but professional" as Doings advocates?
- Are all RFP requirements clearly addressed?

Important formatting rules:
- Write in English only
- Do not use emojis
- Do not use all caps for entire words (only first letter capitalized is ok)
- Do not use markdown like ** or ##
- Use plain text with clear structure`;

                    const result = await callClaudeAPI(apiKey, prompt);
                    setInlineSuggestion(result);
                } catch (err) {
                    console.error('Weakness agent error:', err);
                } finally {
                    setIsAgentWorking(false);
                }
            };

            // NEW: Agent action - Quick Improve (uses Doings Expert Skill)
            const runQuickImproveAgent = async () => {
                if (!apiKey) return;
                setIsAgentWorking(true);
                setSuggestionType('quick-improve');

                try {
                    const doingsGuide = getDoingsGuidanceForSection(section.id);
                    const prompt = `You are the Doings Expert Agent - senior copywriter for RFP responses.

Section: ${section.id} "${section.title}"

${doingsGuide}

Current Response:
${localResponse}

Improve by:
1. Apply Doings brand voice: "Warm but professional, action-oriented"
2. Integrate key phrases: "Learning by Doings", "From words to action"
3. Strengthen value propositions with Doings differentiators
4. Add concrete examples/numbers from the Doings guide
5. Remove generic consultant jargon and passive voice

Important formatting rules:
- Write in English only
- Do not use emojis
- Do not use all caps for entire words
- Do not use markdown like ** or ##
- Headings can use Title Case followed by colon (e.g., "Heading:")

Respond only with the improved response. Keep approximately the same length. No markdown.`;

                    const result = await callClaudeAPI(apiKey, prompt);
                    setInlineSuggestion(result);
                } catch (err) {
                    console.error('Quick improve agent error:', err);
                } finally {
                    setIsAgentWorking(false);
                }
            };

            // Handle accepting inline suggestion
            const handleAcceptSuggestion = () => {
                if (inlineSuggestion && suggestionType !== 'weakness') {
                    setLocalResponse(inlineSuggestion);
                    onResponseChange(section.id, inlineSuggestion);
                }
                setInlineSuggestion(null);
                setSuggestionType(null);
            };

            // Handle rejecting inline suggestion
            const handleRejectSuggestion = () => {
                setInlineSuggestion(null);
                setSuggestionType(null);
            };

            // Determine if this section has a real response
            const hasResponse = response?.trim().length > 50;

            return (
                <div className={`bg-white rounded-xl shadow-sm border overflow-hidden mb-4 ${
                    hasResponse ? 'border-gray-200' : 'border-dashed border-gray-300'
                }`}>
                    {/* Header - Clickable to expand */}
                    <div className={`p-4 cursor-pointer transition-colors ${
                        hasResponse ? 'hover:bg-gray-50' : 'hover:bg-slate-50 bg-slate-50/50'
                    }`}
                         onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                {/* Score Ring - Shows 0% with special styling when no response */}
                                {hasResponse ? (
                                    <ScoreRing score={evaluation.score} size={60} />
                                ) : (
                                    <div className="relative">
                                        <ScoreRing score={0} size={60} />
                                        <div className="absolute inset-0 flex items-center justify-center">
                                            <span className="text-xs text-gray-400">‚è≥</span>
                                        </div>
                                    </div>
                                )}
                                <div>
                                    <h3 className={`font-semibold ${hasResponse ? 'text-gray-900' : 'text-gray-600'}`}>
                                        {section.id} {section.title}
                                    </h3>
                                    <p className="text-sm text-gray-500">
                                        {section.requirements.length} krav ‚Ä¢ Vikt: {section.weight}%
                                        {!hasResponse && <span className="ml-2 text-amber-600">‚Ä¢ V√§ntar p√• generering</span>}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {hasResponse ? (
                                    <>
                                        {apiKey && (
                                            <span className="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">ü§ñ AI</span>
                                        )}
                                        <span className={`text-xs px-2 py-1 rounded-full ${
                                            evaluation.hasCriticalGaps ? 'bg-red-100 text-red-700' :
                                            evaluation.gaps.length > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'
                                        }`}>{evaluation.gaps.length} luckor</span>
                                    </>
                                ) : (
                                    <span className="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-500">
                                        Inget svar √§nnu
                                    </span>
                                )}
                                <svg className={`w-5 h-5 text-gray-400 transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}
                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        {/* Summary - different for empty vs filled */}
                        {hasResponse ? (
                            <p className="text-sm mt-2 text-gray-600">{evaluation.summary}</p>
                        ) : (
                            <p className="text-sm mt-2 text-gray-400 italic">
                                üìã RFP-krav: {section.requirements.slice(0, 2).join('; ')}
                                {section.requirements.length > 2 && ` (+${section.requirements.length - 2} till)`}
                            </p>
                        )}
                    </div>

                    {isExpanded && (
                        <div className="border-t border-gray-200">
                            {/* Agent Action Bar - Different states based on whether response exists */}
                            {apiKey && !isEditing && (
                                response?.trim().length > 50 ? (
                                    /* HAS RESPONSE: Show analysis/improvement agents */
                                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-purple-50 border-b flex items-center gap-2 flex-wrap">
                                        <span className="text-xs font-medium text-gray-500 mr-2">ü§ñ F√∂rb√§ttringsagenter:</span>
                                        <button
                                            onClick={(e) => { e.stopPropagation(); runFillGapsAgent(); }}
                                            disabled={isAgentWorking}
                                            className="text-xs px-3 py-1.5 bg-green-100 text-green-700 rounded-full hover:bg-green-200 disabled:opacity-50 flex items-center gap-1"
                                        >
                                            ‚ú® Fyll luckor
                                        </button>
                                        <button
                                            onClick={(e) => { e.stopPropagation(); runWeaknessAgent(); }}
                                            disabled={isAgentWorking}
                                            className="text-xs px-3 py-1.5 bg-red-100 text-red-700 rounded-full hover:bg-red-200 disabled:opacity-50 flex items-center gap-1"
                                        >
                                            üî¥ Hitta svagheter
                                        </button>
                                        <button
                                            onClick={(e) => { e.stopPropagation(); runQuickImproveAgent(); }}
                                            disabled={isAgentWorking}
                                            className="text-xs px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 disabled:opacity-50 flex items-center gap-1"
                                        >
                                            üí° Snabbf√∂rb√§ttra
                                        </button>
                                        {evaluation.score < 100 && (
                                            <button
                                                onClick={(e) => { e.stopPropagation(); setShowCoachModal(true); }}
                                                disabled={isAgentWorking}
                                                className="text-xs px-3 py-1.5 bg-amber-100 text-amber-700 rounded-full hover:bg-amber-200 disabled:opacity-50 flex items-center gap-1 font-medium"
                                            >
                                                üéØ Coach ‚Üí 100%
                                            </button>
                                        )}
                                        {isAgentWorking && (
                                            <span className="text-xs text-purple-600 flex items-center gap-1 ml-2">
                                                <span className="animate-spin">‚è≥</span> Agent arbetar...
                                            </span>
                                        )}
                                    </div>
                                ) : (
                                    /* NO RESPONSE: Show "waiting for generation" state */
                                    <div className="px-4 py-3 bg-gradient-to-r from-gray-50 to-slate-100 border-b flex items-center gap-2 flex-wrap">
                                        <span className="text-xs text-gray-500">
                                            ‚è≥ F√∂rb√§ttringsagenter aktiveras efter att svar genererats f√∂r denna sektion
                                        </span>
                                    </div>
                                )
                            )}

                            {/* NEW: Inline Suggestion Display */}
                            {inlineSuggestion && (
                                <div className="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-purple-200">
                                    <div className="flex items-center justify-between mb-3">
                                        <h4 className="font-medium text-purple-800 flex items-center gap-2">
                                            {suggestionType === 'fill-gaps' && '‚ú® Luckor ifyllda'}
                                            {suggestionType === 'weakness' && 'üî¥ Svaghetanalys'}
                                            {suggestionType === 'quick-improve' && 'üí° Snabbf√∂rb√§ttring'}
                                        </h4>
                                        <div className="flex gap-2">
                                            {suggestionType !== 'weakness' && (
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); handleAcceptSuggestion(); }}
                                                    className="text-xs px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700"
                                                >
                                                    ‚úÖ Acceptera
                                                </button>
                                            )}
                                            <button
                                                onClick={(e) => { e.stopPropagation(); handleRejectSuggestion(); }}
                                                className="text-xs px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                            >
                                                ‚ùå St√§ng
                                            </button>
                                        </div>
                                    </div>
                                    <div className={`p-3 rounded-lg max-h-48 overflow-y-auto text-sm ${
                                        suggestionType === 'weakness' ? 'bg-white border border-red-200' : 'bg-white border border-green-200'
                                    }`}>
                                        <pre className="whitespace-pre-wrap text-gray-700">{inlineSuggestion}</pre>
                                    </div>
                                </div>
                            )}

                            {hasResponse ? (
                                /* HAS RESPONSE: Show response + evaluation */
                                <>
                                    <div className="grid md:grid-cols-2 gap-0">
                                        <div className="p-4 border-r border-gray-200">
                                            <div className="flex items-center justify-between mb-3">
                                                <h4 className="font-medium text-gray-700">Ditt Svar</h4>
                                                <div className="flex gap-2">
                                                    {!isEditing ? (
                                                        <>
                                                            <button onClick={(e) => { e.stopPropagation(); setShowRefineModal(true); }}
                                                                    className="text-sm text-purple-600 hover:text-purple-700 bg-purple-50 px-2 py-1 rounded">ü™Ñ F√∂rfina</button>
                                                            <button onClick={(e) => { e.stopPropagation(); setIsEditing(true); }}
                                                                    className="text-sm text-teal-600 hover:text-teal-700">‚úèÔ∏è Redigera</button>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <button onClick={(e) => { e.stopPropagation(); handleSave(); }}
                                                                    className="text-sm bg-teal-600 text-white px-3 py-1 rounded hover:bg-teal-700">Spara</button>
                                                            <button onClick={(e) => { e.stopPropagation(); setIsEditing(false); setLocalResponse(response); }}
                                                                    className="text-sm text-gray-500 hover:text-gray-700">Avbryt</button>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                            {isEditing ? (
                                                <textarea value={localResponse} onChange={(e) => setLocalResponse(e.target.value)}
                                                          onClick={(e) => e.stopPropagation()}
                                                          className="w-full h-64 p-3 border border-gray-300 rounded-lg text-sm font-mono resize-none" />
                                            ) : (
                                                <pre className="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg h-64 overflow-y-auto">
                                                    {response}
                                                </pre>
                                            )}
                                        </div>
                                        <div className="p-4 bg-gray-50">
                                            <h4 className="font-medium text-gray-700 mb-3">Utv√§rdering</h4>
                                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                                {evaluation.checks.map((check, idx) => (
                                                    <RequirementCheck key={idx} check={check} />
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                /* NO RESPONSE: Show RFP requirements prominently */
                                <div className="p-6 bg-slate-50">
                                    <div className="text-center mb-6">
                                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-amber-100 text-amber-800 rounded-full text-sm">
                                            <span className="animate-pulse">‚è≥</span>
                                            V√§ntar p√• att agenter ska generera svar
                                        </div>
                                    </div>
                                    <div className="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <h4 className="font-medium text-gray-700 mb-3 flex items-center gap-2">
                                                üìã RFP-krav att uppfylla
                                            </h4>
                                            <ul className="space-y-2">
                                                {section.requirements.map((req, idx) => (
                                                    <li key={idx} className="flex items-start gap-2 text-sm">
                                                        <span className="text-gray-400 mt-0.5">‚óã</span>
                                                        <span className="text-gray-600">{req}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 className="font-medium text-gray-700 mb-3 flex items-center gap-2">
                                                üéØ Utv√§rderingskriterium
                                            </h4>
                                            <p className="text-sm text-gray-600 bg-white p-3 rounded-lg border">
                                                {section.evaluationCriteria}
                                            </p>
                                            <div className="mt-4 p-3 bg-teal-50 border border-teal-200 rounded-lg">
                                                <p className="text-xs text-teal-700">
                                                    <strong>üéØ Doings Expert</strong> kommer anv√§nda inbyggd metodik f√∂r att besvara denna sektion
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {/* Requirements footer - always shown */}
                            <div className="p-4 bg-slate-800 text-white">
                                <h4 className="font-medium mb-2 text-teal-400">üìã RFP-krav (Sektion {section.id})</h4>
                                <ul className="text-sm space-y-1 text-gray-300">
                                    {section.requirements.map((req, idx) => (<li key={idx}>‚Ä¢ {req}</li>))}
                                </ul>
                                <p className="text-xs mt-3 text-gray-400">Utv√§rderingskriterium: {section.evaluationCriteria}</p>
                            </div>
                        </div>
                    )}

                    {/* Modals now receive apiKey and intelligence */}
                    <RefineModal
                        isOpen={showRefineModal}
                        onClose={() => setShowRefineModal(false)}
                        section={section}
                        currentText={localResponse}
                        onApplyRefined={handleApplyRefined}
                        apiKey={apiKey}
                        customerIntelligence={customerIntelligence}
                        doingsKnowledge={doingsKnowledge}
                    />

                    <CoachModal
                        isOpen={showCoachModal}
                        onClose={() => setShowCoachModal(false)}
                        section={section}
                        currentText={localResponse}
                        evaluation={evaluation}
                        onApplyCoached={handleApplyCoached}
                        apiKey={apiKey}
                        customerIntelligence={customerIntelligence}
                        doingsKnowledge={doingsKnowledge}
                    />
                </div>
            );
        }

        // ============================================
        // HITL REVIEW MODAL
        // Human-in-the-Loop review of all generated sections
        // Approve, request changes, add comments
        // ============================================
        function HITLReviewModal({
            isOpen,
            onClose,
            responses,
            sectionApprovals,
            sectionComments,
            onApprove,
            onRequestChanges,
            onResetApproval,
            onAddComment,
            reviewStatus,
            onExport
        }) {
            const [activeSection, setActiveSection] = useState(null);
            const [changeComment, setChangeComment] = useState('');
            const [newComment, setNewComment] = useState('');

            if (!isOpen) return null;

            const sectionsWithContent = rfpSections.filter(s =>
                responses[s.id]?.trim().length > 50
            );

            const getStatusBadge = (sectionId) => {
                const approval = sectionApprovals[sectionId];
                if (!approval) {
                    return { color: 'bg-amber-100 text-amber-700 border-amber-300', label: '‚è≥ V√§ntar p√• granskning', icon: '‚è≥' };
                }
                if (approval.status === 'approved') {
                    return { color: 'bg-green-100 text-green-700 border-green-300', label: '‚úÖ Godk√§nd', icon: '‚úÖ' };
                }
                if (approval.status === 'changes-requested') {
                    return { color: 'bg-red-100 text-red-700 border-red-300', label: 'üîÑ √Ñndringar beg√§rda', icon: 'üîÑ' };
                }
                return { color: 'bg-gray-100 text-gray-500', label: '?', icon: '?' };
            };

            const handleApprove = (sectionId) => {
                onApprove(sectionId);
                // Move to next pending section
                const nextPending = sectionsWithContent.find(s =>
                    s.id !== sectionId && !sectionApprovals[s.id]
                );
                if (nextPending) {
                    setActiveSection(nextPending.id);
                }
            };

            const handleRequestChanges = (sectionId) => {
                if (changeComment.trim()) {
                    onRequestChanges(sectionId, changeComment);
                    setChangeComment('');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl overflow-hidden max-h-[95vh] flex flex-col">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-5">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h2 className="text-2xl font-bold flex items-center gap-2">
                                        üë§ Human-in-the-Loop Granskning
                                    </h2>
                                    <p className="text-indigo-200 mt-1">
                                        Granska, godk√§nn eller beg√§r √§ndringar f√∂r varje sektion
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>

                            {/* Progress bar */}
                            <div className="mt-4">
                                <div className="flex justify-between text-sm mb-2">
                                    <span>Granskningsframsteg</span>
                                    <span>{reviewStatus.approved} av {reviewStatus.total} godk√§nda</span>
                                </div>
                                <div className="w-full h-3 bg-indigo-800 rounded-full overflow-hidden flex">
                                    <div
                                        className="h-full bg-green-400 transition-all"
                                        style={{ width: `${(reviewStatus.approved / reviewStatus.total) * 100}%` }}
                                    />
                                    <div
                                        className="h-full bg-red-400 transition-all"
                                        style={{ width: `${(reviewStatus.changesRequested / reviewStatus.total) * 100}%` }}
                                    />
                                </div>
                                <div className="flex gap-4 mt-2 text-xs">
                                    <span className="flex items-center gap-1">
                                        <span className="w-3 h-3 bg-green-400 rounded"></span>
                                        Godk√§nda ({reviewStatus.approved})
                                    </span>
                                    <span className="flex items-center gap-1">
                                        <span className="w-3 h-3 bg-red-400 rounded"></span>
                                        √Ñndringar ({reviewStatus.changesRequested})
                                    </span>
                                    <span className="flex items-center gap-1">
                                        <span className="w-3 h-3 bg-indigo-800 rounded"></span>
                                        V√§ntar ({reviewStatus.pending})
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Main content - Two column layout */}
                        <div className="flex-1 flex overflow-hidden">
                            {/* Left sidebar - Section list */}
                            <div className="w-80 border-r bg-gray-50 overflow-y-auto">
                                <div className="p-3">
                                    <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Sektioner</h3>
                                    {sectionsWithContent.map(section => {
                                        const status = getStatusBadge(section.id);
                                        return (
                                            <button
                                                key={section.id}
                                                onClick={() => setActiveSection(section.id)}
                                                className={`w-full text-left p-3 rounded-lg mb-2 transition-all ${
                                                    activeSection === section.id
                                                        ? 'bg-indigo-100 border-2 border-indigo-400'
                                                        : 'bg-white border border-gray-200 hover:border-gray-300'
                                                }`}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-800">{section.id}</span>
                                                    <span className="text-lg">{status.icon}</span>
                                                </div>
                                                <p className="text-sm text-gray-600 truncate">{section.title}</p>
                                                <span className={`inline-block mt-1 px-2 py-0.5 rounded text-xs border ${status.color}`}>
                                                    {status.label}
                                                </span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Right content - Section detail */}
                            <div className="flex-1 overflow-y-auto">
                                {activeSection ? (
                                    <div className="p-6">
                                        {(() => {
                                            const section = rfpSections.find(s => s.id === activeSection);
                                            const response = responses[activeSection];
                                            const approval = sectionApprovals[activeSection];
                                            const comments = sectionComments[activeSection] || [];
                                            const status = getStatusBadge(activeSection);

                                            return (
                                                <>
                                                    {/* Section header */}
                                                    <div className="flex items-start justify-between mb-4">
                                                        <div>
                                                            <h3 className="text-xl font-bold text-gray-800">
                                                                {section.id} {section.title}
                                                            </h3>
                                                            <p className="text-sm text-gray-500">
                                                                {section.requirements.length} krav ‚Ä¢ {section.weight}% vikt
                                                            </p>
                                                        </div>
                                                        <span className={`px-3 py-1 rounded-full text-sm border ${status.color}`}>
                                                            {status.label}
                                                        </span>
                                                    </div>

                                                    {/* Requirements checklist */}
                                                    <div className="mb-4 p-3 bg-gray-50 rounded-lg">
                                                        <h4 className="text-sm font-semibold text-gray-700 mb-2">üìã Krav att verifiera:</h4>
                                                        <ul className="space-y-1">
                                                            {section.requirements.map((req, i) => (
                                                                <li key={i} className="flex items-start gap-2 text-sm">
                                                                    <input type="checkbox" className="mt-1 accent-green-500" />
                                                                    <span className="text-gray-600">{req}</span>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>

                                                    {/* Response content */}
                                                    <div className="mb-4">
                                                        <h4 className="text-sm font-semibold text-gray-700 mb-2">üìù AI-genererat svar:</h4>
                                                        <div className="p-4 bg-white border rounded-lg max-h-64 overflow-y-auto">
                                                            <p className="text-sm text-gray-700 whitespace-pre-wrap">{response}</p>
                                                        </div>
                                                        <p className="text-xs text-gray-400 mt-1">{response?.length || 0} tecken</p>
                                                    </div>

                                                    {/* Previous comments */}
                                                    {comments.length > 0 && (
                                                        <div className="mb-4">
                                                            <h4 className="text-sm font-semibold text-gray-700 mb-2">üí¨ Kommentarer:</h4>
                                                            <div className="space-y-2">
                                                                {comments.map((c, i) => (
                                                                    <div key={i} className="p-2 bg-yellow-50 border border-yellow-200 rounded text-sm">
                                                                        <p className="text-gray-700">{c.text}</p>
                                                                        <p className="text-xs text-gray-400 mt-1">
                                                                            {new Date(c.createdAt).toLocaleString('sv-SE')}
                                                                        </p>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* Approval status message */}
                                                    {approval?.status === 'changes-requested' && (
                                                        <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                                                            <p className="text-sm text-red-700 font-medium">üîÑ √Ñndringar beg√§rda:</p>
                                                            <p className="text-sm text-red-600">{approval.comment}</p>
                                                            <button
                                                                onClick={() => onResetApproval(activeSection)}
                                                                className="mt-2 text-xs text-red-500 underline"
                                                            >
                                                                √Öterst√§ll status
                                                            </button>
                                                        </div>
                                                    )}

                                                    {/* Action buttons */}
                                                    <div className="border-t pt-4 space-y-3">
                                                        {approval?.status !== 'approved' && (
                                                            <>
                                                                {/* Request changes input */}
                                                                <div className="flex gap-2">
                                                                    <input
                                                                        type="text"
                                                                        value={changeComment}
                                                                        onChange={(e) => setChangeComment(e.target.value)}
                                                                        placeholder="Beskriv vilka √§ndringar som beh√∂vs..."
                                                                        className="flex-1 px-3 py-2 border rounded-lg text-sm"
                                                                    />
                                                                    <button
                                                                        onClick={() => handleRequestChanges(activeSection)}
                                                                        disabled={!changeComment.trim()}
                                                                        className="px-4 py-2 bg-amber-500 text-white rounded-lg text-sm font-medium hover:bg-amber-600 disabled:opacity-50"
                                                                    >
                                                                        üîÑ Beg√§r √§ndringar
                                                                    </button>
                                                                </div>

                                                                {/* Approve button */}
                                                                <button
                                                                    onClick={() => handleApprove(activeSection)}
                                                                    className="w-full py-3 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 flex items-center justify-center gap-2"
                                                                >
                                                                    ‚úÖ Godk√§nn sektion {section.id}
                                                                </button>
                                                            </>
                                                        )}

                                                        {approval?.status === 'approved' && (
                                                            <div className="text-center py-4">
                                                                <span className="text-4xl">‚úÖ</span>
                                                                <p className="text-green-700 font-medium mt-2">Denna sektion √§r godk√§nd</p>
                                                                <p className="text-sm text-gray-500">
                                                                    Godk√§nd: {new Date(approval.approvedAt).toLocaleString('sv-SE')}
                                                                </p>
                                                                <button
                                                                    onClick={() => onResetApproval(activeSection)}
                                                                    className="mt-2 text-sm text-gray-500 underline"
                                                                >
                                                                    √Öngra godk√§nnande
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </div>
                                ) : (
                                    <div className="flex items-center justify-center h-full text-gray-400">
                                        <div className="text-center">
                                            <span className="text-6xl">üëà</span>
                                            <p className="mt-4">V√§lj en sektion att granska</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="border-t p-4 bg-gray-50">
                            <div className="flex items-center justify-between">
                                <div className="text-sm">
                                    {reviewStatus.allApproved ? (
                                        <span className="text-green-600 font-medium flex items-center gap-2">
                                            <span className="text-xl">üéâ</span>
                                            Alla sektioner godk√§nda! Redo f√∂r export.
                                        </span>
                                    ) : (
                                        <span className="text-gray-600">
                                            {reviewStatus.pending} sektioner v√§ntar p√• granskning
                                        </span>
                                    )}
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={onClose}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800"
                                    >
                                        St√§ng
                                    </button>
                                    <button
                                        onClick={onExport}
                                        disabled={!reviewStatus.allApproved}
                                        className={`px-6 py-2 rounded-lg font-medium flex items-center gap-2 ${
                                            reviewStatus.allApproved
                                                ? 'bg-gradient-to-r from-green-500 to-teal-500 text-white hover:from-green-600 hover:to-teal-600 shadow-lg'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {reviewStatus.allApproved ? (
                                            <>üì§ Exportera godk√§nt f√∂rslag</>
                                        ) : (
                                            <>üîí Godk√§nn alla f√∂r export</>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // READY TO GENERATE MODAL
        // Shows RFP requirement analysis and asks user to confirm generation
        // ============================================
        function ReadyToGenerateModal({
            isOpen,
            onClose,
            onGenerate,
            isGenerating,
            generationProgress,
            rfpAnalysis,
            customerIntelligence,
            doingsKnowledge,
            customSkills
        }) {
            if (!isOpen) return null;

            const analysis = rfpAnalysis || { sections: [], totalRequirements: 0 };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden max-h-[90vh] flex flex-col">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-green-600 to-teal-600 text-white p-5">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h2 className="text-2xl font-bold flex items-center gap-2">
                                        <span className="animate-pulse">‚ú®</span>
                                        Redo att Generera RFP-svar
                                    </h2>
                                    <p className="text-green-100 mt-1">
                                        Alla f√∂ruts√§ttningar uppfyllda. Agenterna √§r synkade och redo.
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        {/* Prerequisites Status */}
                        <div className="p-4 bg-green-50 border-b">
                            <div className="grid grid-cols-3 gap-4">
                                <div className="flex items-center gap-2 text-green-700">
                                    <span className="text-xl">‚úÖ</span>
                                    <div>
                                        <p className="font-medium">RFP Laddad</p>
                                        <p className="text-xs text-green-600">{analysis.totalRequirements} krav identifierade</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 text-green-700">
                                    <span className="text-xl">‚úÖ</span>
                                    <div>
                                        <p className="font-medium">Kundinsikt Klar</p>
                                        <p className="text-xs text-green-600">{customerIntelligence?.sourceCount || 0} k√§llor</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 text-green-700">
                                    <span className="text-xl">‚úÖ</span>
                                    <div>
                                        <p className="font-medium">üéØ Doings Expert</p>
                                        <p className="text-xs text-green-600">Inbyggd + {customSkills?.length || 0} extra skills</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Section-to-Agent Mapping */}
                        <div className="flex-1 overflow-y-auto p-4">
                            <h3 className="font-semibold text-gray-800 mb-3">üìã Sektions-analys & Agent-matchning</h3>

                            <div className="space-y-3">
                                {analysis.sections.map((section) => (
                                    <div
                                        key={section.sectionId}
                                        className={`p-4 rounded-xl border ${
                                            section.hasExistingResponse
                                                ? 'bg-gray-50 border-gray-200'
                                                : 'bg-white border-teal-200 shadow-sm'
                                        }`}
                                    >
                                        <div className="flex items-start justify-between">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-xl ${section.hasExistingResponse ? 'opacity-50' : ''}`}>
                                                        {section.primaryAgent.icon}
                                                    </span>
                                                    <div>
                                                        <p className="font-medium text-gray-800">
                                                            {section.sectionId} {section.sectionTitle}
                                                        </p>
                                                        <p className="text-xs text-gray-500">
                                                            {section.requirementCount} krav ‚Ä¢ {section.weight}% vikt ‚Ä¢
                                                            Agent: <span className="font-medium">{section.primaryAgent.name}</span>
                                                        </p>
                                                    </div>
                                                </div>

                                                {/* Requirements preview */}
                                                <div className="mt-2 pl-8">
                                                    <details className="text-sm">
                                                        <summary className="text-gray-500 cursor-pointer hover:text-gray-700">
                                                            Visa krav ({section.requirementCount})
                                                        </summary>
                                                        <ul className="mt-2 space-y-1">
                                                            {section.requirements.map((req, i) => (
                                                                <li key={i} className="text-xs text-gray-600 flex items-start gap-2">
                                                                    <span className="text-teal-500">‚Ä¢</span>
                                                                    {req}
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </details>
                                                </div>

                                                {/* Key insights this section will use */}
                                                <div className="mt-2 pl-8 flex flex-wrap gap-1">
                                                    {section.keyInsights.map((insight, i) => (
                                                        <span key={i} className="px-2 py-0.5 bg-teal-100 text-teal-700 rounded text-xs">
                                                            {insight}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Status */}
                                            <div className="ml-4">
                                                {section.hasExistingResponse ? (
                                                    <span className="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-xs">
                                                        Har svar ‚úì
                                                    </span>
                                                ) : (
                                                    <span className="px-3 py-1 bg-teal-500 text-white rounded-full text-xs animate-pulse">
                                                        Att generera
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Generation Progress (when generating) */}
                        {isGenerating && (
                            <div className="p-4 bg-indigo-50 border-t border-indigo-200">
                                <div className="flex items-center gap-4">
                                    <div className="w-full">
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-indigo-700 font-medium">
                                                Genererar: {generationProgress.section}
                                            </span>
                                            <span className="text-indigo-600">
                                                {generationProgress.current} / {generationProgress.total}
                                            </span>
                                        </div>
                                        <div className="w-full h-3 bg-indigo-200 rounded-full overflow-hidden">
                                            <div
                                                className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500"
                                                style={{ width: `${(generationProgress.current / generationProgress.total) * 100}%` }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Footer */}
                        <div className="border-t p-4 bg-gray-50">
                            <div className="flex items-center justify-between">
                                <div className="text-sm text-gray-600">
                                    <span className="font-medium">{analysis.sections.filter(s => !s.hasExistingResponse).length}</span>
                                    {' '}sektioner att generera ‚Ä¢{' '}
                                    <span className="font-medium">{analysis.totalRequirements}</span>
                                    {' '}totala krav
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={onClose}
                                        disabled={isGenerating}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800 disabled:opacity-50"
                                    >
                                        {isGenerating ? 'V√§nta...' : 'Avbryt'}
                                    </button>
                                    <button
                                        onClick={onGenerate}
                                        disabled={isGenerating}
                                        className="px-6 py-2 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg font-medium hover:from-green-700 hover:to-teal-700 disabled:opacity-50 flex items-center gap-2 shadow-lg"
                                    >
                                        {isGenerating ? (
                                            <>
                                                <span className="animate-spin">‚ü≥</span>
                                                Genererar...
                                            </>
                                        ) : (
                                            <>
                                                <span>üöÄ</span>
                                                Ja, generera alla svar!
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Agent & Knowledge Hub Modal - Shows all agents and their skills
        function SkillUploadModal({ isOpen, onClose, onAddSkill, skills, workflowStatus, customerIntelligence, doingsKnowledge }) {
            const [activeTab, setActiveTab] = useState('agents'); // 'agents' | 'knowledge' | 'upload'
            const [skillName, setSkillName] = useState('');
            const [skillDesc, setSkillDesc] = useState('');
            const [skillContent, setSkillContent] = useState('');
            const [expandedAgent, setExpandedAgent] = useState(null);

            // Agent registry with status - reflects actual workflow dependencies
            const hasResponses = workflowStatus?.hasResponses || false;

            const AGENTS = {
                doingsAgent: {
                    id: 'doings', name: 'Doings Expert', icon: 'üéØ', phase: 0,
                    role: 'F√∂rmedla Doings v√§rde, metoder och erbjudande',
                    skills: [
                        'Learning by Doings-metodik',
                        '5 Capabilities Framework',
                        'RFP Sektion-guide (3.1-3.8)',
                        'Priss√§ttning & paket',
                        'Brand Voice & Key Phrases'
                    ],
                    status: 'ready',  // Always ready - built-in via DOINGS_RFP_GUIDE
                    builtIn: true,
                    statusNote: 'Inbyggd kunskap - alltid tillg√§nglig'
                },
                researchAgent: {
                    id: 'research', name: 'Research Agent', icon: 'üî¨', phase: 1,
                    role: 'Samla djup kundinsikt fr√•n 25+ webk√§llor',
                    skills: ['Perplexity API web-s√∂kning', 'Multi-s√∂kning (8 fokusomr√•den)', 'K√§ll-aggregering', 'Stakeholder-identifiering'],
                    status: customerIntelligence ? 'done' : 'ready',
                    statusNote: customerIntelligence ? `‚úì ${customerIntelligence.sourceCount || 0} k√§llor analyserade` : 'Redo att s√∂ka'
                },
                writerAgent: {
                    id: 'writer', name: 'Response Writer', icon: '‚úçÔ∏è', phase: 2,
                    role: 'Generera RFP-svar baserat p√• kundinsikt + Doings-metodik',
                    skills: ['Aff√§rsspr√•k-anpassning', 'Kundton-matchning', 'Value proposition-integrering', 'Sektionsspecifik RFP-guide'],
                    status: customerIntelligence ? (hasResponses ? 'done' : 'ready') : 'waiting',
                    statusNote: hasResponses ? '‚úì Svar genererade' : (customerIntelligence ? 'Redo att generera!' : 'V√§ntar p√• kundinsikt')
                },
                weaknessAgent: {
                    id: 'weakness', name: 'Weakness Detector', icon: 'üî¥', phase: 3,
                    role: 'Hitta svagheter och luckor i genererade svar',
                    skills: ['Krav-gap-analys', 'Stakeholder-alignment', 'Konkurrensperspektiv', 'Tonalitetsanalys'],
                    status: hasResponses ? 'ready' : 'waiting',
                    statusNote: hasResponses ? 'Redo att analysera' : 'V√§ntar p√• genererade svar'
                },
                stakeholderAgent: {
                    id: 'stakeholder', name: 'Stakeholder Mapper', icon: 'üë•', phase: 3,
                    role: 'Mappa f√∂rslaget mot k√§nda beslutsfattare',
                    skills: ['Beslutsfattar-profiling', 'Win-theme-identifiering', 'Kommunikationsstil-anpassning'],
                    status: hasResponses ? 'ready' : 'waiting',
                    statusNote: hasResponses ? 'Redo att mappa' : 'V√§ntar p√• genererade svar'
                },
                questionsAgent: {
                    id: 'questions', name: 'Critical Questions', icon: '‚ùì', phase: 3,
                    role: 'Identifiera obesvarade fr√•gor och blindspots',
                    skills: ['Gap-identifiering', 'Antagande-utmaning', 'Risk-flaggning'],
                    status: hasResponses ? 'ready' : 'waiting',
                    statusNote: hasResponses ? 'Redo att granska' : 'V√§ntar p√• genererade svar'
                },
                roiAgent: {
                    id: 'roi', name: 'ROI & Business Case', icon: 'üí∞', phase: 3,
                    role: 'Bygga √∂vertygande business case och ROI-argument',
                    skills: ['ROI-kalkylering', 'CFO-anpassad argumentation', 'Payback-period-analys'],
                    status: hasResponses ? 'ready' : 'waiting',
                    statusNote: hasResponses ? 'Redo att ber√§kna' : 'V√§ntar p√• genererade svar'
                }
            };

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const text = await file.text();
                    setSkillContent(text);
                    setSkillName(file.name.replace(/\.[^.]+$/, '').replace(/_/g, ' '));
                    const lines = text.split('\n').slice(0, 5);
                    const descLine = lines.find(l => l.length > 20 && l.length < 200 && !l.startsWith('#'));
                    if (descLine) setSkillDesc(descLine.replace(/^[-*]\s*/, '').trim());
                }
            };

            const handleSave = () => {
                if (skillName && skillContent) {
                    onAddSkill({ id: 'custom-' + Date.now(), name: skillName, description: skillDesc || 'Custom skill', content: skillContent });
                    setSkillName(''); setSkillDesc(''); setSkillContent('');
                    setActiveTab('knowledge');
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'done': return 'bg-green-100 text-green-700 border-green-300';
                    case 'ready': return 'bg-teal-100 text-teal-700 border-teal-300';
                    case 'working': return 'bg-blue-100 text-blue-700 border-blue-300 animate-pulse';
                    case 'waiting': return 'bg-gray-100 text-gray-500 border-gray-300';
                    case 'needs-input': return 'bg-amber-100 text-amber-700 border-amber-300';
                    default: return 'bg-gray-100 text-gray-500';
                }
            };

            const getStatusLabel = (status) => {
                switch (status) {
                    case 'done': return '‚úì Klar';
                    case 'ready': return '‚óè Redo';
                    case 'working': return '‚ü≥ Arbetar';
                    case 'waiting': return '‚óã V√§ntar';
                    case 'needs-input': return '! Beh√∂ver data';
                    default: return '?';
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
                        <div className="gradient-bg text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">ü§ñ Agent & Kunskaps-Hub</h2>
                                    <p className="text-teal-200 text-sm">
                                        {Object.values(AGENTS).filter(a => a.status === 'ready' || a.status === 'done').length} av {Object.keys(AGENTS).length} agenter redo
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="border-b bg-gray-50 px-4 pt-3">
                            <div className="flex gap-2">
                                {[
                                    { id: 'agents', label: 'ü§ñ Agenter', count: Object.keys(AGENTS).length },
                                    { id: 'knowledge', label: 'üìö Kunskap', count: skills?.length || 0 },
                                    { id: 'upload', label: '‚ûï L√§gg till', count: null }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${
                                            activeTab === tab.id
                                                ? 'bg-white text-teal-600 border-t border-l border-r border-gray-200'
                                                : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100'
                                        }`}
                                    >
                                        {tab.label} {tab.count !== null && `(${tab.count})`}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto flex-1">
                            {/* Agents Tab */}
                            {activeTab === 'agents' && (
                                <div className="space-y-3">
                                    <p className="text-sm text-gray-600 mb-4">
                                        Varje agent har specialiserade skills och samverkar f√∂r att besvara RFP:n.
                                    </p>

                                    {Object.values(AGENTS).map(agent => (
                                        <div
                                            key={agent.id}
                                            className={`border rounded-xl overflow-hidden transition-all ${
                                                expandedAgent === agent.id ? 'border-teal-400 shadow-md' : 'border-gray-200'
                                            }`}
                                        >
                                            <button
                                                onClick={() => setExpandedAgent(expandedAgent === agent.id ? null : agent.id)}
                                                className="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors"
                                            >
                                                <div className="flex items-center gap-3">
                                                    <span className="text-2xl">{agent.icon}</span>
                                                    <div className="text-left">
                                                        <p className="font-medium text-gray-800">{agent.name}</p>
                                                        <p className="text-xs text-gray-500">Fas {agent.phase} ‚Ä¢ {agent.skills.length} skills</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className={`px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(agent.status)}`}>
                                                        {getStatusLabel(agent.status)}
                                                    </span>
                                                    <span className="text-gray-400">{expandedAgent === agent.id ? '‚ñº' : '‚ñ∂'}</span>
                                                </div>
                                            </button>

                                            {expandedAgent === agent.id && (
                                                <div className="px-4 pb-4 border-t bg-gray-50">
                                                    <p className="text-sm text-gray-700 my-3">{agent.role}</p>
                                                    {agent.builtIn && (
                                                        <div className="mb-3 px-3 py-2 bg-teal-50 border border-teal-200 rounded-lg">
                                                            <p className="text-xs text-teal-700 flex items-center gap-2">
                                                                <span>üîí</span>
                                                                <span><strong>Inbyggd kunskap</strong> - Denna agent har all sin kompetens inb√§ddad fr√•n Doings-skill-biblioteket</span>
                                                            </p>
                                                        </div>
                                                    )}
                                                    <div className="flex flex-wrap gap-2">
                                                        {agent.skills.map((skill, i) => (
                                                            <span key={i} className={`px-2 py-1 border rounded text-xs ${
                                                                agent.builtIn
                                                                    ? 'bg-teal-50 border-teal-300 text-teal-700'
                                                                    : 'bg-white border-gray-300 text-gray-600'
                                                            }`}>
                                                                {agent.builtIn && '‚úì '}{skill}
                                                            </span>
                                                        ))}
                                                    </div>
                                                    {agent.statusNote && (
                                                        <p className={`mt-3 text-xs px-2 py-1 rounded ${
                                                            agent.status === 'done' ? 'bg-green-100 text-green-700' :
                                                            agent.status === 'ready' ? 'bg-teal-100 text-teal-700' :
                                                            'bg-gray-100 text-gray-500'
                                                        }`}>
                                                            üìç {agent.statusNote}
                                                        </p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))}

                                    {/* Collaboration Script - Shows actual workflow */}
                                    <div className="mt-6 p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                                        <h4 className="font-medium text-indigo-800 mb-2">üé≠ Agent-Orkestreringsfl√∂de</h4>
                                        <ol className="text-sm text-indigo-700 space-y-2">
                                            <li className="flex items-start gap-2">
                                                <span className="bg-teal-500 text-white text-xs px-1.5 py-0.5 rounded">FAS 0</span>
                                                <span><strong>üéØ Doings Expert</strong> <span className="text-teal-600 text-xs">(alltid redo - inbyggd)</span></span>
                                            </li>
                                            <li className="flex items-start gap-2">
                                                <span className="bg-indigo-500 text-white text-xs px-1.5 py-0.5 rounded">FAS 1</span>
                                                <span><strong>üî¨ Research Agent</strong> samlar kundinsikt fr√•n webb</span>
                                            </li>
                                            <li className="flex items-start gap-2">
                                                <span className="bg-green-500 text-white text-xs px-1.5 py-0.5 rounded">FAS 2</span>
                                                <span><strong>‚úçÔ∏è Response Writer</strong> genererar RFP-svar f√∂r 3.1-3.8</span>
                                            </li>
                                            <li className="flex items-start gap-2">
                                                <span className="bg-amber-500 text-white text-xs px-1.5 py-0.5 rounded">FAS 3</span>
                                                <span><strong>üî¥ Weakness + ‚ùì Questions + üë• Stakeholder + üí∞ ROI</strong> analyserar & f√∂rb√§ttrar</span>
                                            </li>
                                        </ol>
                                        <p className="text-xs text-indigo-500 mt-3 italic">
                                            ‚Üí Fas 3-agenter aktiveras f√∂rst efter att svar genererats
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* Knowledge Tab */}
                            {activeTab === 'knowledge' && (
                                <div className="space-y-4">
                                    {skills && skills.length > 0 ? (
                                        <>
                                            <p className="text-sm text-gray-600">
                                                Laddade kunskapsdokument som agenterna anv√§nder:
                                            </p>
                                            {skills.map(s => (
                                                <div key={s.id} className="p-4 bg-green-50 border border-green-200 rounded-xl">
                                                    <div className="flex items-start justify-between">
                                                        <div>
                                                            <p className="font-medium text-green-800">üìÑ {s.name}</p>
                                                            <p className="text-sm text-green-600">{s.description}</p>
                                                            <p className="text-xs text-green-500 mt-1">{s.content?.length || 0} tecken</p>
                                                        </div>
                                                        <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Laddad ‚úì</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </>
                                    ) : (
                                        <div className="text-center py-8 text-gray-500">
                                            <span className="text-4xl">üì≠</span>
                                            <p className="mt-2">Ingen kunskap laddad √§nnu</p>
                                            <p className="text-sm">Klicka p√• "L√§gg till" f√∂r att ladda upp Doings-dokument</p>
                                        </div>
                                    )}

                                    {/* Quick info about what to upload */}
                                    <div className="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                        <h4 className="font-medium text-amber-800 mb-2">üí° Vad ska jag ladda upp?</h4>
                                        <ul className="text-sm text-amber-700 space-y-1">
                                            <li>‚Ä¢ <strong>Doings metodbeskrivning</strong> - ACTION, 5 Dynamics, etc.</li>
                                            <li>‚Ä¢ <strong>Prislista & paket</strong> - S√• ROI-agenten kan r√§kna</li>
                                            <li>‚Ä¢ <strong>Referenscase</strong> - Framg√•ngshistorier att citera</li>
                                            <li>‚Ä¢ <strong>Differentierare</strong> - Vad g√∂r Doings unikt?</li>
                                        </ul>
                                    </div>
                                </div>
                            )}

                            {/* Upload Tab */}
                            {activeTab === 'upload' && (
                                <div className="space-y-4">
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-teal-500 transition-colors">
                                        <input type="file" accept=".md,.txt" onChange={handleFile} className="hidden" id="skill-file" />
                                        <label htmlFor="skill-file" className="cursor-pointer">
                                            <span className="text-4xl">üìö</span>
                                            <p className="mt-2 font-medium text-gray-700">Klicka f√∂r att ladda upp MD eller TXT</p>
                                            <p className="text-sm text-gray-500">Dessa dokument blir tillg√§ngliga f√∂r alla agenter</p>
                                        </label>
                                    </div>

                                    {skillContent && (
                                        <div className="space-y-3 p-4 bg-gray-50 rounded-xl">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Namn</label>
                                                <input type="text" value={skillName} onChange={(e) => setSkillName(e.target.value)} className="w-full p-2 border rounded-lg" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Beskrivning</label>
                                                <input type="text" value={skillDesc} onChange={(e) => setSkillDesc(e.target.value)} className="w-full p-2 border rounded-lg" placeholder="Vad inneh√•ller dokumentet?" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">F√∂rhandsvisning ({skillContent.length} tecken)</label>
                                                <div className="prompt-box text-xs" style={{maxHeight: '100px'}}>{skillContent.slice(0, 300)}...</div>
                                            </div>
                                            <button
                                                onClick={handleSave}
                                                disabled={!skillName || !skillContent}
                                                className="w-full py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-50 font-medium"
                                            >
                                                ‚úì L√§gg till kunskapsdokument
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 bg-gray-50 flex justify-between items-center">
                            <p className="text-sm text-gray-500">
                                {workflowStatus?.nextStep && (
                                    <span>N√§sta: {workflowStatus.nextStep.label}</span>
                                )}
                            </p>
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">St√§ng</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // CUSTOMER INTELLIGENCE SYSTEM
        // Purpose: Load and parse research from external AI (ChatGPT/Perplexity)
        // to provide context for all analysis agents
        // ============================================

        /**
         * parseCustomerIntelligence()
         *
         * Parses unstructured customer intelligence text (from ChatGPT research)
         * into structured data that can be used by all analysis agents.
         *
         * Expected input format (flexible):
         * - Sections with headers like "Strategic Priorities", "Key Stakeholders", etc.
         * - KEY FINDINGS, RFP IMPLICATIONS, BLINDSPOTS, DIFFERENTIATORS subsections
         *
         * @param {string} rawText - The pasted research output
         * @returns {object} Structured customerIntelligence object
         */
        function parseCustomerIntelligence(rawText) {
            const intel = {
                loadedAt: new Date().toISOString(),
                sourceCount: 0,
                strategicPriorities: { keyFindings: [], rfpImplications: [], blindspots: [], differentiators: [] },
                currentChallenges: { keyFindings: [], rfpImplications: [], blindspots: [], differentiators: [] },
                companyCulture: { keyFindings: [], rfpImplications: [], blindspots: [], differentiators: [] },
                competitiveLandscape: { keyFindings: [], rfpImplications: [], blindspots: [], differentiators: [] },
                keyStakeholders: [],
                pastInitiatives: { keyFindings: [], rfpImplications: [], blindspots: [], differentiators: [] },
                budgetSignals: { keyFindings: [], rfpImplications: [], blindspots: [], differentiators: [] },
                urgencyTimeline: { keyFindings: [], rfpImplications: [], blindspots: [], differentiators: [] },
                rawText: rawText,
                allInsights: [] // NEW: Store all extracted insights
            };

            // Extract source count (e.g., "35 k√§llor" or "35 sources")
            const sourceMatch = rawText.match(/(\d+)\s*(?:k√§llor|sources|source)/i);
            if (sourceMatch) intel.sourceCount = parseInt(sourceMatch[1]);

            // Helper: Extract all meaningful lines (bullets, numbered items, or important content)
            const extractMeaningfulLines = (text) => {
                const results = [];
                const lines = text.split('\n');
                for (const line of lines) {
                    let cleaned = line
                        .replace(/^[\s\-\*‚Ä¢\d\)\.]+/, '') // Remove bullet markers
                        .replace(/\*\*/g, '') // Remove bold markdown
                        .replace(/\[[\d,\s]+\]/g, '') // Remove citation markers like [1,2]
                        .trim();

                    // Keep lines that are substantive (not just headers)
                    if (cleaned.length > 20 &&
                        !cleaned.match(/^(===|---|STRATEGY|LEADERSHIP|CHALLENGES|BUDGET|CULTURE|SEARCH)/i) &&
                        !cleaned.match(/^(Provide|Search for|Focus on|Be specific|Include|For each)/i)) {
                        results.push(cleaned);
                    }
                }
                return results;
            };

            // Helper: Extract section content between markers
            const extractSection = (text, startMarkers, endMarkers = []) => {
                for (const marker of startMarkers) {
                    const startRegex = new RegExp(marker, 'i');
                    const startMatch = text.search(startRegex);
                    if (startMatch !== -1) {
                        let endPos = text.length;
                        for (const end of endMarkers) {
                            const endRegex = new RegExp(end, 'gi');
                            endRegex.lastIndex = startMatch + 50; // Start searching after header
                            const endMatch = endRegex.exec(text);
                            if (endMatch && endMatch.index < endPos) {
                                endPos = endMatch.index;
                            }
                        }
                        return text.substring(startMatch, endPos);
                    }
                }
                return '';
            };

            // Parse sections from Perplexity's format
            const sectionMappings = [
                {
                    key: 'strategicPriorities',
                    markers: ['STRATEGI & FINANSER', 'STRATEGIC PRIORITIES', 'STRATEGY & FINANCIALS', 'FINANCIAL HEALTH', 'KEY METRICS'],
                    endMarkers: ['===', 'LEDARSKAP', 'LEADERSHIP', 'CHALLENGES', 'UTMANINGAR']
                },
                {
                    key: 'keyStakeholdersRaw', // Special handling
                    markers: ['LEDARSKAP & STAKEHOLDERS', 'LEADERSHIP', 'KEY STAKEHOLDERS', 'NAME & TITLE'],
                    endMarkers: ['===', 'UTMANINGAR', 'CHALLENGES', 'KULTUR', 'CULTURE']
                },
                {
                    key: 'currentChallenges',
                    markers: ['UTMANINGAR & KONKURRENS', 'CHALLENGES', 'COMPETITIVE LANDSCAPE', 'MARKET POSITION'],
                    endMarkers: ['===', 'KULTUR', 'CULTURE', 'BUDGET', 'TIMING']
                },
                {
                    key: 'companyCulture',
                    markers: ['KULTUR & TIDIGARE', 'CULTURE', 'VALUES', 'PAST INITIATIVES', 'PREVIOUS PROGRAMS'],
                    endMarkers: ['===', 'BUDGET', 'TIMING']
                },
                {
                    key: 'budgetSignals',
                    markers: ['BUDGET & TIMING', 'BUDGET SIGNALS', 'PROCUREMENT', 'FISCAL', 'ROI'],
                    endMarkers: ['===']
                }
            ];

            // Extract insights from each section
            for (const mapping of sectionMappings) {
                const sectionText = extractSection(rawText, mapping.markers, mapping.endMarkers);
                if (sectionText && mapping.key !== 'keyStakeholdersRaw') {
                    const findings = extractMeaningfulLines(sectionText);
                    if (intel[mapping.key]) {
                        intel[mapping.key].keyFindings = findings.slice(0, 10);
                        intel.allInsights.push(...findings);
                    }
                }
            }

            // Parse stakeholders from entire text (look everywhere)
            const stakeholderPatterns = [
                /\*\*([A-Z√Ö√Ñ√ñ√ú][a-z√•√§√∂√º]+(?:\s+[A-Z√Ö√Ñ√ñ√ú][a-z√•√§√∂√º]+)+)\*\*[,\s]*(?:‚Äì|-|:)?\s*(CEO|CFO|COO|CTO|CHRO|CMO|EVP|SVP|VP|Director|Chief|Head|President|Managing|Executive|Leader)[^\n]*/gi,
                /([A-Z√Ö√Ñ√ñ√ú][a-z√•√§√∂√º]+(?:\s+[A-Z√Ö√Ñ√ñ√ú][a-z√•√§√∂√º]+)+),?\s*(?:‚Äì|-|:)?\s*(CEO|CFO|COO|CTO|CHRO|CMO|EVP|SVP|VP|Director|Chief|Head|President|Managing|Executive|Leader)[^\n]*/gi,
                /(?:NAME|NAMN)[:\s]*([A-Z√Ö√Ñ√ñ√ú][^\n,]+)[,\n]?\s*(?:TITLE|TITEL|ROLE)[:\s]*([^\n]+)/gi
            ];

            const foundStakeholders = new Set();
            for (const pattern of stakeholderPatterns) {
                let match;
                while ((match = pattern.exec(rawText)) !== null) {
                    const name = match[1].replace(/\*\*/g, '').trim();
                    let role = match[2] ? match[2].trim() : '';
                    // Clean up role
                    role = role.replace(/\*\*/g, '').replace(/[,\.].*$/, '').trim();

                    if (name.length > 3 && name.length < 50 && !foundStakeholders.has(name.toLowerCase())) {
                        foundStakeholders.add(name.toLowerCase());
                        intel.keyStakeholders.push({
                            name: name,
                            role: role,
                            focus: '',
                            winWith: ''
                        });
                    }
                }
            }

            // If no structured sections found, extract any bullet points as insights
            if (intel.allInsights.length === 0) {
                const allLines = extractMeaningfulLines(rawText);
                intel.allInsights = allLines;
                // Distribute to categories based on keywords
                for (const line of allLines.slice(0, 50)) {
                    const lower = line.toLowerCase();
                    if (lower.match(/strateg|priorit|goal|vision|mission|growth|expansion/)) {
                        intel.strategicPriorities.keyFindings.push(line);
                    } else if (lower.match(/challeng|problem|issue|risk|threat|concern/)) {
                        intel.currentChallenges.keyFindings.push(line);
                    } else if (lower.match(/cultur|value|people|employee|workplace/)) {
                        intel.companyCulture.keyFindings.push(line);
                    } else if (lower.match(/compet|market|industry|rival|position/)) {
                        intel.competitiveLandscape.keyFindings.push(line);
                    } else if (lower.match(/budget|invest|spend|cost|price|roi|fiscal/)) {
                        intel.budgetSignals.keyFindings.push(line);
                    } else if (lower.match(/timeline|deadline|urgent|quick|fast|immediate/)) {
                        intel.urgencyTimeline.keyFindings.push(line);
                    } else if (lower.match(/past|previous|histor|initiative|project|program/)) {
                        intel.pastInitiatives.keyFindings.push(line);
                    } else {
                        // Default to strategic priorities
                        intel.strategicPriorities.keyFindings.push(line);
                    }
                }
            }

            return intel;
        }

        /**
         * CustomerIntelLoaderModal
         *
         * Modal for generating or importing customer intelligence research.
         * Two modes:
         * - Generate: Uses Perplexity API with web search to create research in-app
         * - Import: Paste external research from ChatGPT/other sources
         *
         * Props:
         * - isOpen: boolean
         * - onClose: function
         * - onLoad: function(customerIntelligence) - callback when intel is loaded
         * - existingIntel: object|null - previously loaded intel
         * - perplexityKey: string - Perplexity API key for web search
         * - apiKey: string - Claude API key for structuring (optional)
         */
        function CustomerIntelLoaderModal({ isOpen, onClose, onLoad, existingIntel, perplexityKey, apiKey, onOpenSettings, rfpDocument, onUploadRfp, onClearRfp, onOpenAgentHub }) {
            // Mode: 'generate' | 'import'
            const [mode, setMode] = useState('generate');

            // Generate mode state
            const [customerName, setCustomerName] = useState('');
            const [additionalContext, setAdditionalContext] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generationStep, setGenerationStep] = useState(''); // Current step description
            const [generationProgress, setGenerationProgress] = useState(0);
            const [rawResearchResult, setRawResearchResult] = useState(null);
            const [citations, setCitations] = useState([]);

            // Import mode state
            const [inputText, setInputText] = useState('');

            // Shared state
            const [parsedPreview, setParsedPreview] = useState(null);
            const [step, setStep] = useState('input'); // 'input', 'generating', 'preview', 'loaded'
            const [error, setError] = useState(null);

            // Reset state when modal opens
            useEffect(() => {
                if (isOpen) {
                    setInputText('');
                    setCustomerName('');
                    setAdditionalContext('');
                    setParsedPreview(null);
                    setRawResearchResult(null);
                    setCitations([]);
                    setError(null);
                    setIsGenerating(false);
                    setGenerationProgress(0);
                    setStep(existingIntel ? 'loaded' : 'input');
                    // Default to generate if perplexity key exists, otherwise import
                    setMode(perplexityKey ? 'generate' : 'import');
                }
            }, [isOpen, existingIntel, perplexityKey]);

            // Build comprehensive research prompt
            const buildResearchPrompt = (companyName, context, rfpContent) => {
                // Include RFP excerpt if available (first 4000 chars to stay within limits)
                const rfpExcerpt = rfpContent ? rfpContent.substring(0, 4000) : '';

                return `You are a Customer Intelligence Analyst preparing research for an RFP response team.

COMPANY TO RESEARCH: ${companyName}

${rfpExcerpt ? `RFP DOCUMENT EXCERPT (use this to understand what we're responding to):\n---\n${rfpExcerpt}\n---\n` : ''}
${context ? `ADDITIONAL CONTEXT FROM USER:\n${context}\n` : ''}

Conduct deep research and provide intelligence in these 8 categories:

1) STRATEGIC PRIORITIES
Search for: Annual reports, investor presentations, CEO interviews, press releases, strategy announcements
KEY FINDINGS: List 3-5 specific strategic priorities with evidence
RFP IMPLICATIONS: How should our proposal align with these priorities?
BLINDSPOTS: What might competitors miss?
DIFFERENTIATORS: How can we stand out?

2) CURRENT CHALLENGES
Search for: News articles, analyst reports, industry challenges, competitor moves
KEY FINDINGS: List 3-5 current challenges they're facing
RFP IMPLICATIONS: How does our solution address these?
BLINDSPOTS: Hidden challenges not obvious from surface research?
DIFFERENTIATORS: Unique ways we can help?

3) ORGANIZATIONAL CULTURE & VALUES
Search for: Careers page, employee reviews (Glassdoor), leadership interviews, CSR reports
KEY FINDINGS: What defines their culture?
RFP IMPLICATIONS: How should we match their culture in our proposal?
BLINDSPOTS: Cultural nuances to be aware of?
DIFFERENTIATORS: Cultural alignment opportunities?

4) COMPETITIVE LANDSCAPE
Search for: Industry reports, competitor announcements, market analysis
KEY FINDINGS: Who are their main competitors? Market position?
RFP IMPLICATIONS: How do they differentiate?
BLINDSPOTS: Competitive threats they might be concerned about?
DIFFERENTIATORS: How can we help them compete?

5) KEY STAKEHOLDERS
Search for: LinkedIn profiles, press releases, organizational charts, news mentions
For each key decision-maker found, provide:
- Name and Title
- Background and focus areas
- What would win them over?

6) PAST INITIATIVES (Similar to RFP topic)
Search for: Case studies, press releases, past vendor announcements
KEY FINDINGS: What similar initiatives have they done?
RFP IMPLICATIONS: Lessons learned? What worked/didn't?
BLINDSPOTS: Failed initiatives to be aware of?
DIFFERENTIATORS: How to build on past success?

7) BUDGET SIGNALS
Search for: Financial reports, procurement announcements, investment news
KEY FINDINGS: Budget indicators, investment priorities, financial health
RFP IMPLICATIONS: How to frame pricing?
BLINDSPOTS: Hidden budget constraints?
DIFFERENTIATORS: ROI angles that resonate?

8) URGENCY & TIMELINE
Search for: Announcements, deadlines, regulatory requirements, fiscal year
KEY FINDINGS: What's driving their timeline?
RFP IMPLICATIONS: How to align with their urgency?
BLINDSPOTS: Hidden deadlines?
DIFFERENTIATORS: Speed/flexibility advantages?

FORMAT YOUR RESPONSE with clear headers for each numbered section.
Include specific names, dates, numbers, and quotes where possible.
Cite your sources inline.
Be thorough - this research will inform a multi-million dollar proposal.`;
            };

            // Generate customer intelligence using MULTIPLE Perplexity searches for deeper research
            const handleGenerate = async () => {
                if (!customerName.trim() || !perplexityKey) return;

                setIsGenerating(true);
                setError(null);
                setStep('generating');
                setGenerationProgress(5);
                setGenerationStep('Initierar djup research (8 s√∂kningar)...');

                // Define 5 focused search prompts for comprehensive coverage
                const searchPrompts = [
                    {
                        name: 'Strategi & Finanser',
                        icon: 'üìä',
                        prompt: `Research ${customerName}: STRATEGY & FINANCIALS
Search for: Annual reports, investor presentations, earnings calls, strategic priorities, financial performance, growth targets.
${rfpDocument?.content ? `RFP Context: ${rfpDocument.content.substring(0, 1500)}` : ''}
${additionalContext ? `Additional context: ${additionalContext}` : ''}

Provide:
1) STRATEGIC PRIORITIES - Key strategic goals and initiatives (with specific quotes/numbers)
2) FINANCIAL HEALTH - Revenue, growth, investments, budget signals
3) RFP IMPLICATIONS - How should a vendor align with their strategy?
4) KEY METRICS - Specific numbers, percentages, targets mentioned

Be specific. Include names, dates, numbers. Cite sources.`
                    },
                    {
                        name: 'Ledarskap & Stakeholders',
                        icon: 'üë•',
                        prompt: `Research ${customerName}: LEADERSHIP & KEY STAKEHOLDERS
Search for: CEO, CFO, CHRO, HR Director, L&D leaders, LinkedIn profiles, executive interviews, organizational structure.
${additionalContext ? `Context: ${additionalContext}` : ''}

For each key executive found, provide:
1) NAME & TITLE
2) BACKGROUND - Previous roles, education, focus areas
3) PUBLIC STATEMENTS - Quotes about strategy, priorities, challenges
4) WHAT WINS THEM OVER - Based on their profile, what would resonate?

Focus on: C-suite, HR/People leaders, anyone involved in leadership development decisions.
Be specific with names and titles. Cite LinkedIn, interviews, news.`
                    },
                    {
                        name: 'Utmaningar & Konkurrens',
                        icon: '‚ö°',
                        prompt: `Research ${customerName}: CHALLENGES & COMPETITIVE LANDSCAPE
Search for: Recent news, industry challenges, competitor analysis, market position, threats, opportunities.
${additionalContext ? `Context: ${additionalContext}` : ''}

Provide:
1) CURRENT CHALLENGES - What problems are they facing? (specific, recent)
2) COMPETITIVE POSITION - Who are main competitors? Market share?
3) INDUSTRY TRENDS - What's affecting their sector?
4) URGENCY SIGNALS - Why might they need to act now?
5) BLINDSPOTS - What might they be missing?

Focus on challenges relevant to: ${additionalContext || 'leadership, talent, organizational development'}
Be specific. Include recent news, dates, quotes.`
                    },
                    {
                        name: 'Kultur & Tidigare Initiativ',
                        icon: 'üè¢',
                        prompt: `Research ${customerName}: CULTURE & PAST INITIATIVES
Search for: Company culture, values, employee reviews (Glassdoor), past L&D programs, training initiatives, vendor partnerships, case studies.
${additionalContext ? `Context: ${additionalContext}` : ''}

Provide:
1) COMPANY CULTURE - Core values, work environment, what employees say
2) PAST INITIATIVES - Previous leadership/training programs (what worked/didn't)
3) VENDOR HISTORY - Known partners or providers they've used
4) CULTURAL FIT - What type of approach would resonate?
5) SUCCESS CRITERIA - How do they typically measure success?

Be specific. Include program names, vendor names, employee quotes.`
                    },
                    {
                        name: 'Budget & Timing',
                        icon: 'üí∞',
                        prompt: `Research ${customerName}: BUDGET SIGNALS & TIMELINE
Search for: Procurement patterns, investment announcements, fiscal year, budget cycles, HR investments, training spend.
${additionalContext ? `Context: ${additionalContext}` : ''}

Provide:
1) BUDGET SIGNALS - Any indications of budget size, investment priorities
2) FISCAL CALENDAR - When is their fiscal year? Budget planning cycle?
3) PROCUREMENT PROCESS - How do they typically buy? RFP patterns?
4) TIMELINE DRIVERS - What's creating urgency? Deadlines?
5) VALUE PRIORITIES - Price sensitive or value-focused?
6) ROI EXPECTATIONS - How do they measure return on investment?

Focus on signals relevant to: ${additionalContext || 'leadership development, training investment'}
Include specific numbers where available.`
                    },
                    {
                        name: 'Nyheter & Pressmeddelanden',
                        icon: 'üì∞',
                        prompt: `Research ${customerName}: RECENT NEWS & PRESS RELEASES
Search for: Latest news, press releases, announcements, product launches, partnerships, acquisitions from the last 12 months.
${additionalContext ? `Context: ${additionalContext}` : ''}

Provide:
1) MAJOR ANNOUNCEMENTS - What have they announced recently?
2) PRODUCT/SERVICE NEWS - New offerings, expansions, changes?
3) PARTNERSHIP NEWS - Who are they partnering with? Why?
4) ORGANIZATIONAL CHANGES - Any restructuring, new hires, departures?
5) MARKET MOVES - Expansion, contraction, new markets?

Focus on news that indicates strategic direction. Include dates and specific details.`
                    },
                    {
                        name: 'Teknologi & Innovation',
                        icon: 'üî¨',
                        prompt: `Research ${customerName}: TECHNOLOGY & INNOVATION
Search for: Digital transformation, technology investments, IT strategy, innovation programs, tech stack, digital initiatives.
${additionalContext ? `Context: ${additionalContext}` : ''}

Provide:
1) TECH PRIORITIES - What technology investments are they making?
2) DIGITAL TRANSFORMATION - Any digital initiatives or modernization?
3) INNOVATION PROGRAMS - How do they approach innovation?
4) TECH PARTNERS - Who are their technology vendors/partners?
5) DATA & AI - Any data or AI initiatives mentioned?

Be specific about technologies, vendors, and programs mentioned.`
                    },
                    {
                        name: 'Employer Brand & HR',
                        icon: 'üèÜ',
                        prompt: `Research ${customerName}: EMPLOYER BRAND & HR INITIATIVES
Search for: Glassdoor reviews, employer awards, HR programs, employee experience, talent strategy, workplace culture, DEI initiatives.
${additionalContext ? `Context: ${additionalContext}` : ''}

Provide:
1) EMPLOYER REPUTATION - Glassdoor rating, employee reviews, workplace awards
2) HR PROGRAMS - What HR/people initiatives are they known for?
3) TALENT CHALLENGES - Any hiring difficulties, retention issues mentioned?
4) LEARNING & DEVELOPMENT - Existing L&D programs, training investments
5) DEI INITIATIVES - Diversity, equity, inclusion programs

Include specific programs, ratings, and employee quotes where available.`
                    }
                ];

                try {
                    const allResults = [];
                    const allCitations = [];

                    // Run searches sequentially to show progress (could be parallel but UX is better sequential)
                    for (let i = 0; i < searchPrompts.length; i++) {
                        const search = searchPrompts[i];
                        const progressBase = 5 + Math.floor((i / searchPrompts.length) * 85); // Distribute evenly from 5-90

                        setGenerationProgress(progressBase);
                        setGenerationStep(`${search.icon} S√∂ker: ${search.name} (${i + 1}/${searchPrompts.length})...`);

                        try {
                            const result = await callPerplexityAPI(perplexityKey, search.prompt);
                            allResults.push(`\n\n=== ${search.name.toUpperCase()} ===\n${result.content}`);
                            if (result.citations) {
                                allCitations.push(...result.citations);
                            }
                        } catch (searchErr) {
                            console.warn(`Search ${search.name} failed:`, searchErr);
                            allResults.push(`\n\n=== ${search.name.toUpperCase()} ===\n[S√∂kning misslyckades]`);
                        }

                        // Small delay between searches to avoid rate limiting
                        if (i < searchPrompts.length - 1) {
                            await new Promise(r => setTimeout(r, 500));
                        }
                    }

                    setGenerationProgress(90);
                    setGenerationStep('Kombinerar och analyserar alla resultat...');

                    // Combine all results
                    const combinedContent = allResults.join('\n');

                    // Remove duplicate citations
                    const uniqueCitations = [...new Set(allCitations)];

                    // Store raw result and citations
                    setRawResearchResult(combinedContent);
                    setCitations(uniqueCitations);

                    // Parse the combined result
                    setGenerationProgress(95);
                    setGenerationStep('Extraherar nyckeldata...');

                    const parsed = parseCustomerIntelligence(combinedContent);

                    // Add source count from citations
                    parsed.sourceCount = uniqueCitations.length;
                    parsed.generatedBy = 'perplexity-deep';
                    parsed.customerName = customerName;
                    parsed.citations = uniqueCitations;
                    parsed.searchCount = searchPrompts.length;

                    setGenerationProgress(100);
                    setGenerationStep(`Klar! ${uniqueCitations.length} k√§llor fr√•n ${searchPrompts.length} s√∂kningar`);

                    setParsedPreview(parsed);
                    setStep('preview');

                } catch (err) {
                    console.error('Generation error:', err);
                    setError(err.message);
                    setStep('input');
                } finally {
                    setIsGenerating(false);
                }
            };

            // Handle import (paste) mode
            const handleParse = () => {
                if (!inputText.trim()) return;
                setError(null);
                const parsed = parseCustomerIntelligence(inputText);
                parsed.generatedBy = 'import';
                setParsedPreview(parsed);
                setStep('preview');
            };

            // Confirm and load the intelligence
            const handleConfirmLoad = () => {
                if (parsedPreview) {
                    try {
                        localStorage.setItem('doings_customer_intelligence', JSON.stringify(parsedPreview));
                    } catch (e) {
                        console.warn('Could not save to localStorage:', e);
                    }
                    onLoad(parsedPreview);
                    onClose();
                }
            };

            // Clear loaded intelligence
            const handleClear = () => {
                try {
                    localStorage.removeItem('doings_customer_intelligence');
                } catch (e) {}
                onLoad(null);
                setStep('input');
                setParsedPreview(null);
                setRawResearchResult(null);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">üî¨ Kundinsikt (Fas 1: Research)</h2>
                                    <p className="text-indigo-200 text-sm">
                                        Generera eller importera djup kundresearch f√∂r alla agenter
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        {/* Mode Tabs - only show if not loaded/generating/preview */}
                        {step === 'input' && (
                            <div className="border-b bg-gray-50 p-2 flex gap-2">
                                <button
                                    onClick={() => setMode('generate')}
                                    className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all ${
                                        mode === 'generate'
                                            ? 'bg-purple-600 text-white shadow-md'
                                            : 'bg-white text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    <span className="text-lg mr-2">üîç</span>
                                    Generera med Web Search
                                    {!perplexityKey && <span className="block text-xs opacity-75">Kr√§ver Perplexity API-nyckel</span>}
                                </button>
                                <button
                                    onClick={() => setMode('import')}
                                    className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all ${
                                        mode === 'import'
                                            ? 'bg-indigo-600 text-white shadow-md'
                                            : 'bg-white text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    <span className="text-lg mr-2">üìã</span>
                                    Importera extern research
                                </button>
                            </div>
                        )}

                        <div className="p-6 overflow-y-auto max-h-[60vh]">
                            {/* Error display */}
                            {error && (
                                <div className="mb-4 p-4 bg-red-50 rounded-xl border border-red-200">
                                    <p className="text-red-700 font-medium">‚ùå Fel</p>
                                    <p className="text-red-600 text-sm">{error}</p>
                                </div>
                            )}

                            {/* GENERATE MODE - Input */}
                            {step === 'input' && mode === 'generate' && (
                                <div>
                                    {!perplexityKey ? (
                                        <div className="p-6 bg-amber-50 rounded-xl border border-amber-200 text-center">
                                            <p className="text-amber-800 font-semibold mb-2">‚ö†Ô∏è Perplexity API-nyckel kr√§vs</p>
                                            <p className="text-amber-700 text-sm mb-4">
                                                F√∂r att generera kundinsikt med web search beh√∂ver du l√§gga till din Perplexity API-nyckel.
                                            </p>
                                            <div className="flex gap-3 justify-center">
                                                <button
                                                    onClick={() => { onClose(); onOpenSettings && onOpenSettings(); }}
                                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium"
                                                >
                                                    ‚öôÔ∏è √ñppna Inst√§llningar
                                                </button>
                                                <a href="https://www.perplexity.ai/settings/api" target="_blank"
                                                   className="px-4 py-2 bg-white border border-purple-300 text-purple-600 rounded-lg hover:bg-purple-50">
                                                    Skaffa API-nyckel ‚Üí
                                                </a>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="mb-4 p-4 bg-purple-50 rounded-xl border border-purple-200">
                                                <h3 className="font-semibold text-purple-800 mb-2">üîç Automatisk Web Research</h3>
                                                <p className="text-sm text-purple-700">
                                                    Perplexity s√∂ker p√• webben och sammanst√§ller djup kundinsikt automatiskt.
                                                </p>
                                            </div>

                                            {/* RFP Document upload/indicator */}
                                            <div className="mb-4">
                                                {rfpDocument ? (
                                                    <div className="p-3 bg-green-50 rounded-xl border border-green-200">
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-2xl">üìÑ</span>
                                                            <div className="flex-1">
                                                                <p className="text-sm font-medium text-green-800">RFP-dokument laddas som kontext</p>
                                                                <p className="text-xs text-green-600">{rfpDocument.fileName} ({rfpDocument.wordCount} ord)</p>
                                                            </div>
                                                            <span className="text-green-500">‚úì</span>
                                                        </div>
                                                        <div className="mt-2 flex gap-2">
                                                            {rfpDocument.fileDataUrl && (
                                                                <button
                                                                    onClick={() => {
                                                                        // Open PDF in new window with embedded viewer
                                                                        const newWindow = window.open('', '_blank');
                                                                        newWindow.document.write(`
                                                                            <!DOCTYPE html>
                                                                            <html>
                                                                            <head><title>${rfpDocument.fileName}</title></head>
                                                                            <body style="margin:0;padding:0;height:100vh;">
                                                                                <embed src="${rfpDocument.fileDataUrl}" type="application/pdf" width="100%" height="100%" />
                                                                            </body>
                                                                            </html>
                                                                        `);
                                                                        newWindow.document.close();
                                                                    }}
                                                                    className="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
                                                                >
                                                                    üëÅÔ∏è Visa PDF
                                                                </button>
                                                            )}
                                                            <details className="inline">
                                                                <summary className="px-3 py-1 text-xs bg-blue-100 text-blue-600 rounded hover:bg-blue-200 cursor-pointer list-none">
                                                                    üìù Visa text
                                                                </summary>
                                                                <div className="absolute z-10 mt-1 p-3 bg-white border rounded-lg shadow-lg max-w-lg max-h-64 overflow-auto text-xs text-gray-700 whitespace-pre-wrap">
                                                                    {rfpDocument.content.substring(0, 2000)}
                                                                    {rfpDocument.content.length > 2000 && '...'}
                                                                </div>
                                                            </details>
                                                            <button
                                                                onClick={() => onClearRfp && onClearRfp()}
                                                                className="px-3 py-1 text-xs bg-red-100 text-red-600 rounded hover:bg-red-200"
                                                            >
                                                                üóëÔ∏è Ta bort
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <label className="block cursor-pointer">
                                                        <input
                                                            type="file"
                                                            accept=".pdf,.docx,.txt,.md"
                                                            onChange={onUploadRfp}
                                                            className="hidden"
                                                        />
                                                        <div className="p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-purple-400 hover:bg-purple-50/50 transition-all text-center">
                                                            <span className="text-3xl">üìÑ</span>
                                                            <p className="text-sm font-medium text-gray-700 mt-2">Ladda upp RFP-dokument (valfritt)</p>
                                                            <p className="text-xs text-gray-500">PDF, Word (.docx) eller text (.txt)</p>
                                                        </div>
                                                    </label>
                                                )}
                                            </div>

                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        F√∂retagsnamn *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={customerName}
                                                        onChange={(e) => setCustomerName(e.target.value)}
                                                        placeholder="T.ex. Elisa Corporation, Volvo Cars, H&M..."
                                                        className="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        RFP-kontext (valfritt men rekommenderat)
                                                    </label>
                                                    <textarea
                                                        value={additionalContext}
                                                        onChange={(e) => setAdditionalContext(e.target.value)}
                                                        placeholder="T.ex: RFP f√∂r ledarutvecklingsprogram, Nordic scope, budget ~500k EUR, fokus p√• 300 leaders..."
                                                        className="w-full h-32 p-3 border-2 border-gray-200 rounded-lg resize-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                                                    />
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        Ju mer kontext, desto b√§ttre matchade insikter
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* GENERATE MODE - Generating */}
                            {step === 'generating' && (
                                <div className="py-6">
                                    <div className="text-center mb-6">
                                        <div className="text-5xl mb-3 animate-pulse">üîç</div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">Djup Research P√•g√•r</h3>
                                        <p className="text-purple-600 font-medium">{generationStep}</p>
                                    </div>

                                    <div className="max-w-md mx-auto mb-6">
                                        <div className="w-full bg-gray-200 rounded-full h-4">
                                            <div
                                                className="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500"
                                                style={{ width: `${generationProgress}%` }}
                                            ></div>
                                        </div>
                                        <p className="text-center text-sm text-gray-500 mt-2">{generationProgress}%</p>
                                    </div>

                                    {/* Search steps indicator */}
                                    <div className="grid grid-cols-5 gap-2 mb-6">
                                        {['üìä Strategi', 'üë• Ledare', '‚ö° Utmaningar', 'üè¢ Kultur', 'üí∞ Budget'].map((label, i) => {
                                            const stepProgress = 10 + (i * 16);
                                            const isActive = generationProgress >= stepProgress && generationProgress < stepProgress + 16;
                                            const isDone = generationProgress > stepProgress + 10;
                                            return (
                                                <div key={i} className={`text-center p-2 rounded-lg text-xs ${
                                                    isDone ? 'bg-green-100 text-green-700' :
                                                    isActive ? 'bg-purple-100 text-purple-700 animate-pulse' :
                                                    'bg-gray-100 text-gray-400'
                                                }`}>
                                                    {isDone ? '‚úì' : label.split(' ')[0]}
                                                    <div className="text-[10px] mt-1">{label.split(' ')[1]}</div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                                        <p className="text-xs text-purple-700 text-center">
                                            <strong>5 fokuserade s√∂kningar</strong> f√∂r att hitta fler k√§llor √§n en enda bred s√∂kning.
                                            Varje s√∂kning fokuserar p√• ett specifikt omr√•de.
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* IMPORT MODE - Input */}
                            {step === 'input' && mode === 'import' && (
                                <div>
                                    <div className="mb-4 p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                                        <h3 className="font-semibold text-indigo-800 mb-2">üìã Importera extern research</h3>
                                        <p className="text-sm text-indigo-700">
                                            Klistra in research fr√•n ChatGPT, Claude, eller annan k√§lla.
                                        </p>
                                    </div>

                                    <textarea
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        placeholder="Klistra in din customer intelligence research h√§r...

Exempel-format:

1) Strategic Priorities
KEY FINDINGS: ...
RFP IMPLICATIONS: ...

2) Current Challenges
KEY FINDINGS: ...

5) Key Stakeholders
- Namn, Roll...

etc."
                                        className="w-full h-64 p-4 border-2 border-gray-200 rounded-xl font-mono text-sm resize-none focus:border-indigo-500"
                                    />

                                    <div className="mt-2 text-sm text-gray-500">
                                        {inputText.length > 0 && `${inputText.length.toLocaleString()} tecken`}
                                    </div>
                                </div>
                            )}

                            {/* Preview (shared for both modes) */}
                            {step === 'preview' && parsedPreview && (
                                <div>
                                    <div className="mb-4 p-4 bg-green-50 rounded-xl border border-green-200">
                                        <h3 className="font-semibold text-green-800 mb-1">
                                            ‚úÖ {parsedPreview.generatedBy === 'perplexity' ? 'Research genererad!' : 'Parsning klar!'}
                                        </h3>
                                        {parsedPreview.customerName && (
                                            <p className="text-sm text-green-700">F√∂retag: {parsedPreview.customerName}</p>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        {/* Stats */}
                                        <div className="space-y-3">
                                            {citations.length > 0 && (
                                                <div className="p-3 bg-purple-50 rounded-lg">
                                                    <p className="text-sm font-medium text-purple-700">üåê Webb-k√§llor</p>
                                                    <p className="text-2xl font-bold text-purple-600">{citations.length}</p>
                                                    <div className="mt-2 max-h-48 overflow-y-auto space-y-1">
                                                        {citations.map((c, i) => (
                                                            <a
                                                                key={i}
                                                                href={c}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="block text-xs text-purple-600 hover:text-purple-800 hover:underline truncate"
                                                                title={c}
                                                            >
                                                                ‚Ä¢ {(() => {
                                                                    try {
                                                                        const url = new URL(c);
                                                                        return url.hostname.replace('www.', '') + (url.pathname !== '/' ? url.pathname.substring(0, 30) : '');
                                                                    } catch (e) { return c.substring(0, 50); }
                                                                })()}
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <p className="text-sm font-medium text-gray-700">üë• Stakeholders</p>
                                                <p className="text-2xl font-bold text-purple-600">{parsedPreview.keyStakeholders.length}</p>
                                                {parsedPreview.keyStakeholders.slice(0, 3).map((s, i) => (
                                                    <p key={i} className="text-xs text-gray-600">{s.name} ({s.role})</p>
                                                ))}
                                            </div>

                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <p className="text-sm font-medium text-gray-700">üéØ Totalt insikter</p>
                                                <p className="text-2xl font-bold text-teal-600">
                                                    {(parsedPreview.allInsights?.length || 0) +
                                                     parsedPreview.strategicPriorities.keyFindings.length +
                                                     parsedPreview.currentChallenges.keyFindings.length}
                                                </p>
                                            </div>
                                        </div>

                                        {/* Key findings by category */}
                                        <div className="space-y-3 max-h-80 overflow-y-auto">
                                            {parsedPreview.strategicPriorities.keyFindings.length > 0 && (
                                                <div className="p-3 bg-indigo-50 rounded-lg">
                                                    <p className="text-sm font-medium text-indigo-700 mb-2">üìä Strategi ({parsedPreview.strategicPriorities.keyFindings.length}):</p>
                                                    {parsedPreview.strategicPriorities.keyFindings.slice(0, 5).map((f, i) => (
                                                        <p key={i} className="text-xs text-gray-700 mb-1 leading-relaxed">‚Ä¢ {f.length > 200 ? f.substring(0, 200) + '...' : f}</p>
                                                    ))}
                                                    {parsedPreview.strategicPriorities.keyFindings.length > 5 && (
                                                        <p className="text-xs text-indigo-500 italic">+{parsedPreview.strategicPriorities.keyFindings.length - 5} fler...</p>
                                                    )}
                                                </div>
                                            )}

                                            {parsedPreview.currentChallenges.keyFindings.length > 0 && (
                                                <div className="p-3 bg-amber-50 rounded-lg">
                                                    <p className="text-sm font-medium text-amber-700 mb-2">‚ö° Utmaningar ({parsedPreview.currentChallenges.keyFindings.length}):</p>
                                                    {parsedPreview.currentChallenges.keyFindings.slice(0, 5).map((f, i) => (
                                                        <p key={i} className="text-xs text-gray-700 mb-1 leading-relaxed">‚Ä¢ {f.length > 200 ? f.substring(0, 200) + '...' : f}</p>
                                                    ))}
                                                </div>
                                            )}

                                            {parsedPreview.companyCulture.keyFindings.length > 0 && (
                                                <div className="p-3 bg-green-50 rounded-lg">
                                                    <p className="text-sm font-medium text-green-700 mb-2">üè¢ Kultur ({parsedPreview.companyCulture.keyFindings.length}):</p>
                                                    {parsedPreview.companyCulture.keyFindings.slice(0, 3).map((f, i) => (
                                                        <p key={i} className="text-xs text-gray-700 mb-1 leading-relaxed">‚Ä¢ {f.length > 200 ? f.substring(0, 200) + '...' : f}</p>
                                                    ))}
                                                </div>
                                            )}

                                            {parsedPreview.budgetSignals.keyFindings.length > 0 && (
                                                <div className="p-3 bg-purple-50 rounded-lg">
                                                    <p className="text-sm font-medium text-purple-700 mb-2">üí∞ Budget & Timing ({parsedPreview.budgetSignals.keyFindings.length}):</p>
                                                    {parsedPreview.budgetSignals.keyFindings.slice(0, 3).map((f, i) => (
                                                        <p key={i} className="text-xs text-gray-700 mb-1 leading-relaxed">‚Ä¢ {f.length > 200 ? f.substring(0, 200) + '...' : f}</p>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Show raw result toggle for debugging */}
                                    {rawResearchResult && (
                                        <details className="mt-4">
                                            <summary className="text-sm text-gray-500 cursor-pointer hover:text-gray-700">
                                                Visa r√• research-text
                                            </summary>
                                            <pre className="mt-2 p-3 bg-gray-100 rounded text-xs overflow-auto max-h-40 whitespace-pre-wrap">
                                                {rawResearchResult}
                                            </pre>
                                        </details>
                                    )}
                                </div>
                            )}

                            {/* Already Loaded */}
                            {step === 'loaded' && existingIntel && (
                                <div>
                                    <div className="mb-4 p-4 bg-green-50 rounded-xl border border-green-200">
                                        <h3 className="font-semibold text-green-800 mb-2">‚úÖ Kundinsikt laddad</h3>
                                        <p className="text-sm text-green-700">
                                            Laddad: {new Date(existingIntel.loadedAt).toLocaleString('sv-SE')}
                                            {existingIntel.customerName && ` ‚Ä¢ ${existingIntel.customerName}`}
                                            {existingIntel.generatedBy === 'perplexity' && ' ‚Ä¢ Via Perplexity'}
                                        </p>
                                    </div>

                                    <div className="grid grid-cols-3 gap-4 mb-4">
                                        <div className="p-4 bg-indigo-50 rounded-lg text-center">
                                            <p className="text-3xl font-bold text-indigo-600">{existingIntel.sourceCount || existingIntel.citations?.length || '?'}</p>
                                            <p className="text-sm text-indigo-700">K√§llor</p>
                                        </div>
                                        <div className="p-4 bg-purple-50 rounded-lg text-center">
                                            <p className="text-3xl font-bold text-purple-600">{existingIntel.keyStakeholders?.length || 0}</p>
                                            <p className="text-sm text-purple-700">Stakeholders</p>
                                        </div>
                                        <div className="p-4 bg-teal-50 rounded-lg text-center">
                                            <p className="text-3xl font-bold text-teal-600">
                                                {Object.values(existingIntel).filter(v => v?.keyFindings?.length > 0).length}
                                            </p>
                                            <p className="text-sm text-teal-700">Kategorier</p>
                                        </div>
                                    </div>

                                    {existingIntel.keyStakeholders?.length > 0 && (
                                        <div className="p-4 bg-gray-50 rounded-lg mb-4">
                                            <p className="text-sm font-medium text-gray-700 mb-2">üë• Identifierade stakeholders:</p>
                                            <div className="flex flex-wrap gap-2">
                                                {existingIntel.keyStakeholders.map((s, i) => (
                                                    <span key={i} className="px-3 py-1 bg-white border rounded-full text-sm">
                                                        {s.name} <span className="text-gray-500">({s.role})</span>
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Show all citations as clickable links */}
                                    {existingIntel.citations?.length > 0 && (
                                        <details className="mt-4" open>
                                            <summary className="text-sm font-medium text-purple-700 cursor-pointer hover:text-purple-900 mb-2">
                                                üåê Alla k√§llor ({existingIntel.citations.length}) - klicka f√∂r att √∂ppna
                                            </summary>
                                            <div className="mt-2 p-3 bg-purple-50 rounded-lg max-h-48 overflow-y-auto space-y-1">
                                                {existingIntel.citations.map((c, i) => (
                                                    <a
                                                        key={i}
                                                        href={c}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="block text-xs text-purple-600 hover:text-purple-800 hover:underline"
                                                        title={c}
                                                    >
                                                        {i + 1}. {(() => {
                                                            try {
                                                                const url = new URL(c);
                                                                return url.hostname.replace('www.', '') + url.pathname.substring(0, 50);
                                                            } catch (e) { return c.substring(0, 60); }
                                                        })()}
                                                    </a>
                                                ))}
                                            </div>
                                        </details>
                                    )}

                                    {/* Show key insights summary */}
                                    {(existingIntel.strategicPriorities?.keyFindings?.length > 0 ||
                                      existingIntel.currentChallenges?.keyFindings?.length > 0) && (
                                        <details className="mt-4">
                                            <summary className="text-sm font-medium text-teal-700 cursor-pointer hover:text-teal-900 mb-2">
                                                üîë Nyckelinsikter - klicka f√∂r att visa
                                            </summary>
                                            <div className="mt-2 space-y-3 max-h-64 overflow-y-auto">
                                                {existingIntel.strategicPriorities?.keyFindings?.length > 0 && (
                                                    <div className="p-2 bg-indigo-50 rounded">
                                                        <p className="text-xs font-medium text-indigo-700 mb-1">Strategi:</p>
                                                        {existingIntel.strategicPriorities.keyFindings.slice(0, 3).map((f, i) => (
                                                            <p key={i} className="text-xs text-gray-700 mb-1">‚Ä¢ {f.substring(0, 150)}...</p>
                                                        ))}
                                                    </div>
                                                )}
                                                {existingIntel.currentChallenges?.keyFindings?.length > 0 && (
                                                    <div className="p-2 bg-amber-50 rounded">
                                                        <p className="text-xs font-medium text-amber-700 mb-1">Utmaningar:</p>
                                                        {existingIntel.currentChallenges.keyFindings.slice(0, 3).map((f, i) => (
                                                            <p key={i} className="text-xs text-gray-700 mb-1">‚Ä¢ {f.substring(0, 150)}...</p>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </details>
                                    )}

                                    {/* Next Step Suggestion */}
                                    <div className="mt-4 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-200">
                                        <h4 className="font-semibold text-indigo-800 mb-2 flex items-center gap-2">
                                            <span className="animate-pulse">üëâ</span> N√§sta steg: Synka Kunskapsbas
                                        </h4>
                                        <p className="text-sm text-indigo-700 mb-3">
                                            Kundinsikten √§r laddad! Nu beh√∂ver agenterna veta vad <strong>Doings</strong> erbjuder f√∂r att kunna f√∂rmedla ert v√§rde.
                                        </p>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => { onClose(); if (onOpenAgentHub) onOpenAgentHub(); }}
                                                className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium flex items-center gap-2"
                                            >
                                                ü§ñ √ñppna Agent-Hub ‚Üí
                                            </button>
                                            <button
                                                onClick={onClose}
                                                className="px-4 py-2 text-indigo-600 hover:text-indigo-800 text-sm"
                                            >
                                                G√∂r det senare
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="border-t p-4 bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-500">
                                {step === 'input' && mode === 'generate' && perplexityKey && 'Ange f√∂retagsnamn f√∂r att starta'}
                                {step === 'input' && mode === 'generate' && !perplexityKey && 'L√§gg till Perplexity-nyckel i Inst√§llningar'}
                                {step === 'input' && mode === 'import' && 'Klistra in research f√∂r att forts√§tta'}
                                {step === 'generating' && 'S√∂ker p√• webben...'}
                                {step === 'preview' && 'Granska och bekr√§fta'}
                                {step === 'loaded' && '‚úì Alla agenter har tillg√•ng till denna kontext'}
                            </div>
                            <div className="flex gap-3">
                                {step === 'loaded' && (
                                    <button onClick={handleClear} className="px-4 py-2 text-red-600 hover:text-red-800">
                                        üóëÔ∏è Rensa
                                    </button>
                                )}
                                {step === 'preview' && (
                                    <button onClick={() => { setStep('input'); setParsedPreview(null); }} className="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        ‚Üê Tillbaka
                                    </button>
                                )}
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    St√§ng
                                </button>
                                {step === 'input' && mode === 'generate' && perplexityKey && (
                                    <button
                                        onClick={handleGenerate}
                                        disabled={!customerName.trim() || isGenerating}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
                                    >
                                        üîç Generera Kundinsikt
                                    </button>
                                )}
                                {step === 'input' && mode === 'import' && (
                                    <button
                                        onClick={handleParse}
                                        disabled={!inputText.trim()}
                                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
                                    >
                                        üîç Analysera & F√∂rhandsgranska
                                    </button>
                                )}
                                {step === 'preview' && (
                                    <button
                                        onClick={handleConfirmLoad}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        ‚úÖ Ladda Kundinsikt
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // STRATEGIC ANALYSIS TOOLKIT - 4 MODAL COMPONENTS
        // ============================================

        // 1. WEAKNESS DETECTOR MODAL (with HITL AI Integration)
        function WeaknessAnalysisModal({ isOpen, onClose, responses, evaluations, apiKey, onUpdateResponses, customerIntelligence }) {
            const [copied, setCopied] = useState(false);
            const [selectedPerspective, setSelectedPerspective] = useState('all');
            const [isLoading, setIsLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [suggestions, setSuggestions] = useState([]);
            const [error, setError] = useState(null);
            const [showPrompt, setShowPrompt] = useState(false);
            const [step, setStep] = useState('select'); // 'select', 'loading', 'review', 'result'

            const perspectives = [
                { id: 'all', name: 'Alla perspektiv', icon: 'üéØ', desc: 'Komplett analys fr√•n alla vinklar' },
                { id: 'procurement', name: 'Procurement/Sourcing', icon: 'üìã', desc: 'Compliance, risk, SLA, pris' },
                { id: 'hr', name: 'HR/L&D', icon: 'üë•', desc: 'Pedagogik, m√§tbarhet, employee experience' },
                { id: 'finance', name: 'Finance/CFO', icon: 'üí∞', desc: 'ROI, TCO, budget-fit, hidden costs' },
                { id: 'business', name: 'Business Leaders', icon: 'üìà', desc: 'Aff√§rsnytta, implementation, tid' },
                { id: 'ceo', name: 'CEO/Executive', icon: 'üëî', desc: 'Strategisk alignment, risk, signalv√§rde' }
            ];

            const generateWeaknessPrompt = () => {
                const allContent = rfpSections.map(s => `### ${s.id} ${s.title}\n${responses[s.id] || '[TOM]'}`).join('\n\n');
                const evalSummary = Object.entries(evaluations).map(([id, e]) => `${id}: ${e.score}% - Gaps: ${e.gaps.map(g => g.requirement).join(', ') || 'None'}`).join('\n');

                const perspectiveInstructions = {
                    all: `Analysera fr√•n ALLA dessa perspektiv: Procurement, HR/L&D, CFO/Finance, Business Leaders, CEO.`,
                    procurement: 'Analysera fr√•n **Procurement/Sourcing**-perspektivet: Compliance, risk, SLA, priss√§ttning.',
                    hr: 'Analysera fr√•n **HR/L&D Director**-perspektivet: Pedagogik, m√§tbarhet, engagement.',
                    finance: 'Analysera fr√•n **CFO/Finance**-perspektivet: ROI, TCO, budget-alignment.',
                    business: 'Analysera fr√•n **Business Leaders**-perspektivet: Relevans, tid-till-effekt.',
                    ceo: 'Analysera fr√•n **CEO/Executive**-perspektivet: Strategisk alignment, risk.'
                };

                // Build customer intelligence context if available
                let intelContext = '';
                if (customerIntelligence) {
                    intelContext = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üî¨ KUNDINSIKT (${customerIntelligence.sourceCount} k√§llor):

**ELISAS STRATEGI:**
${customerIntelligence.strategicPriorities?.keyFindings?.slice(0, 3).join('\n') || 'Ej laddat'}

**UTMANINGAR:**
${customerIntelligence.currentChallenges?.keyFindings?.slice(0, 3).join('\n') || 'Ej laddat'}

**KULTUR:**
${customerIntelligence.companyCulture?.keyFindings?.slice(0, 2).join('\n') || 'Ej laddat'}

**STAKEHOLDERS:**
${customerIntelligence.keyStakeholders?.map(s => `- ${s.name} (${s.role})`).join('\n') || 'Ej laddat'}

**BUDGET-SIGNALER:**
${customerIntelligence.budgetSignals?.keyFindings?.slice(0, 2).join('\n') || 'Ej laddat'}

ANV√ÑND DENNA KONTEXT f√∂r att ge relevanta, specifika rekommendationer som matchar Elisas verklighet.
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
                }

                return `Du √§r en erfaren RFP-granskare. Analysera f√∂rslaget till Elisa Corporation (finsk telecom, ‚Ç¨2.2B, ~800 chefer).

${perspectiveInstructions[selectedPerspective]}
${intelContext}
üìä SCORING: ${evalSummary}

üìù F√ñRSLAG:
${allContent}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
VIKTIGT: Ge KONKRETA F√ñRB√ÑTTRINGSF√ñRSLAG per sektion.
${customerIntelligence ? 'Basera analysen p√• KUNDINSIKTEN ovan - anpassa till Elisas specifika situation.' : ''}

F√∂r varje svaghet du hittar, strukturera s√• h√§r:

SEKTION 3.X: [Titel]
- PROBLEM: [Beskriv svagheten kort]
- ALLVARLIGHET: [kritisk/viktig/f√∂rb√§ttring]
- F√ñRESLAGEN TEXT: "[Konkret textf√∂rslag som kan l√§ggas till]"

Exempel:
SEKTION 3.1: Company Information
- PROBLEM: Saknar specifika finansiella nyckeltal
- ALLVARLIGHET: viktig
- F√ñRESLAGEN TEXT: "Doings omsatte 12 MSEK 2025 med 15% tillv√§xt. Vi har nollskuld och 8 m√•naders runway."

G√• igenom ALLA sektioner 3.1-3.8 och ge minst 1-3 konkreta f√∂rb√§ttringar per sektion.
VAR SPECIFIK. Ge exakta textf√∂rslag som kan kopieras direkt.`;
            };

            const handleCopy = async () => {
                await navigator.clipboard.writeText(generateWeaknessPrompt());
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleRunAI = async () => {
                setStep('loading');
                setIsLoading(true);
                setError(null);
                setAiResult(null);
                setSuggestions([]);

                try {
                    const result = await callClaudeAPI(apiKey, generateWeaknessPrompt());
                    setAiResult(result);

                    // Parse suggestions from AI response
                    const parsed = parseAISuggestions(result);
                    if (parsed.length > 0) {
                        setSuggestions(parsed);
                        setStep('review');
                    } else {
                        setStep('result');
                    }
                } catch (err) {
                    setError(err.message);
                    setStep('select');
                }
                setIsLoading(false);
            };

            const handleApplyAll = () => {
                const accepted = suggestions.filter(s => s.status === 'accepted');
                if (accepted.length === 0 || !onUpdateResponses) return;

                // Group suggestions by section
                const bySection = {};
                accepted.forEach(s => {
                    if (!bySection[s.sectionId]) bySection[s.sectionId] = [];
                    bySection[s.sectionId].push(s.suggestedText || s.suggestion);
                });

                // Update responses
                const newResponses = { ...responses };
                Object.entries(bySection).forEach(([sectionId, texts]) => {
                    const current = newResponses[sectionId] || '';
                    const additions = texts.join('\n\n');
                    newResponses[sectionId] = current + (current ? '\n\n---\nüìù AI-F√ñRB√ÑTTRINGAR:\n' : '') + additions;
                });

                onUpdateResponses(newResponses);
                onClose();
            };

            const handleReset = () => {
                setAiResult(null);
                setError(null);
                setSuggestions([]);
                setStep('select');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-red-600 to-red-700 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">üî¥ Svaghetsdetektor</h2>
                                    <p className="text-red-200 text-sm">
                                        {step === 'select' && (apiKey ? 'ü§ñ V√§lj perspektiv ‚Üí AI analyserar ‚Üí Granska ‚Üí Applicera' : 'Kopiera prompt')}
                                        {step === 'loading' && '‚è≥ Analyserar...'}
                                        {step === 'review' && '‚úÖ Granska och godk√§nn f√∂rslag'}
                                        {step === 'result' && 'üìä Analysresultat'}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* Step 1: Perspective Selector */}
                            {step === 'select' && (
                                <>
                                    <div className="mb-6">
                                        <h3 className="font-semibold text-gray-800 mb-3">1Ô∏è‚É£ V√§lj granskningsperspektiv:</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                            {perspectives.map(p => (
                                                <button
                                                    key={p.id}
                                                    onClick={() => setSelectedPerspective(p.id)}
                                                    className={`p-3 rounded-lg border-2 text-left transition-all ${
                                                        selectedPerspective === p.id
                                                            ? 'border-red-500 bg-red-50'
                                                            : 'border-gray-200 hover:border-red-300'
                                                    }`}
                                                >
                                                    <span className="text-2xl">{p.icon}</span>
                                                    <p className="font-medium text-sm mt-1">{p.name}</p>
                                                    <p className="text-xs text-gray-500">{p.desc}</p>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Prompt Preview */}
                                    <div className="mt-4">
                                        <button
                                            onClick={() => setShowPrompt(!showPrompt)}
                                            className="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1"
                                        >
                                            {showPrompt ? '‚ñº' : '‚ñ∂'} {showPrompt ? 'D√∂lj' : 'Visa'} prompt
                                        </button>
                                        {showPrompt && (
                                            <div className="prompt-box mt-2" style={{maxHeight: '200px', overflowY: 'auto'}}>
                                                <pre className="whitespace-pre-wrap text-xs">{generateWeaknessPrompt()}</pre>
                                            </div>
                                        )}
                                    </div>

                                    {error && (
                                        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-xl">
                                            <p className="text-red-700 text-sm">‚ùå {error}</p>
                                        </div>
                                    )}
                                </>
                            )}

                            {/* Step 2: Loading */}
                            {step === 'loading' && (
                                <div className="text-center py-12">
                                    <div className="animate-spin text-6xl mb-4">üîÑ</div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">Analyserar ditt f√∂rslag...</h3>
                                    <p className="text-gray-600">AI granskar fr√•n {perspectives.find(p => p.id === selectedPerspective)?.name}-perspektivet</p>
                                    <p className="text-sm text-gray-400 mt-2">Detta tar ca 15-45 sekunder</p>
                                </div>
                            )}

                            {/* Step 3: Review Suggestions (HITL) */}
                            {step === 'review' && suggestions.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-bold text-lg text-gray-800">
                                            2Ô∏è‚É£ Granska f√∂rslag ({suggestions.length} hittade)
                                        </h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">
                                            ‚Üê B√∂rja om
                                        </button>
                                    </div>

                                    <SuggestionsList
                                        suggestions={suggestions}
                                        onSuggestionsChange={setSuggestions}
                                        onApplyAll={handleApplyAll}
                                        rfpSections={rfpSections}
                                    />
                                </div>
                            )}

                            {/* Step 4: Raw Result (fallback if no structured suggestions) */}
                            {step === 'result' && aiResult && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="font-bold text-lg text-gray-800">üìä Analysresultat</h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">
                                            ‚Üê Ny analys
                                        </button>
                                    </div>
                                    <div className="p-4 bg-gray-50 rounded-xl border border-gray-200" style={{maxHeight: '400px', overflowY: 'auto'}}>
                                        <pre className="whitespace-pre-wrap text-sm font-sans">{aiResult}</pre>
                                    </div>
                                    <button
                                        onClick={async () => {
                                            await navigator.clipboard.writeText(aiResult);
                                            setCopied(true);
                                            setTimeout(() => setCopied(false), 2000);
                                        }}
                                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                                    >
                                        {copied ? '‚úì Kopierad!' : 'üìã Kopiera resultat'}
                                    </button>
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-500">
                                {apiKey ? (
                                    <span className="text-green-600 flex items-center gap-1">
                                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                        AI aktiverad ‚Ä¢ Human-in-the-Loop workflow
                                    </span>
                                ) : (
                                    <span>Ingen API-nyckel ‚Üí kopiera prompt manuellt</span>
                                )}
                            </div>
                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">St√§ng</button>
                                {step === 'select' && (
                                    <>
                                        <button onClick={handleCopy} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                            üìã Kopiera prompt
                                        </button>
                                        {apiKey && (
                                            <button
                                                onClick={handleRunAI}
                                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"
                                            >
                                                ü§ñ K√∂r AI-analys
                                            </button>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 2. CRITICAL QUESTIONS MODAL (with HITL AI Integration)
        function CriticalQuestionsModal({ isOpen, onClose, responses, evaluations, apiKey, onUpdateResponses, customerIntelligence }) {
            const [copied, setCopied] = useState(false);
            const [questionType, setQuestionType] = useState('pre-submission');
            const [isLoading, setIsLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [suggestions, setSuggestions] = useState([]);
            const [error, setError] = useState(null);
            const [step, setStep] = useState('select');

            const questionTypes = [
                { id: 'pre-submission', name: 'F√∂re inl√§mning', icon: 'üì§', desc: 'Fr√•gor vi M√ÖSTE ha svar p√• fr√•n Elisa' },
                { id: 'clarification', name: 'F√∂rtydliganden', icon: '‚ùì', desc: 'Oklarheter i RFP:n som beh√∂ver svar' },
                { id: 'missing-info', name: 'Saknad info', icon: 'üìù', desc: 'Info vi beh√∂ver internt f√∂r att fylla i' },
                { id: 'risk', name: 'Riskfr√•gor', icon: '‚ö†Ô∏è', desc: 'Potentiella risker att adressera' }
            ];

            const generateQuestionsPrompt = () => {
                const allContent = rfpSections.map(s => `### ${s.id} ${s.title}\n${responses[s.id] || '[TOM]'}`).join('\n\n');
                const gaps = Object.entries(evaluations).flatMap(([id, e]) => e.gaps.map(g => `${id}: ${g.requirement}`));

                // Add customer intelligence blindspots if available
                let blindspotsContext = '';
                if (customerIntelligence) {
                    const allBlindspots = [
                        ...(customerIntelligence.strategicPriorities?.blindspots || []),
                        ...(customerIntelligence.currentChallenges?.blindspots || []),
                        ...(customerIntelligence.budgetSignals?.blindspots || [])
                    ];
                    if (allBlindspots.length > 0) {
                        blindspotsContext = `

üî¨ BLINDSPOTS FR√ÖN KUNDRESEARCH (${customerIntelligence.sourceCount} k√§llor):
${allBlindspots.slice(0, 5).map(b => `- ${b}`).join('\n')}

GENERERA FR√ÖGOR SOM ADRESSERAR DESSA BLINDSPOTS!`;
                    }
                }

                return `Du √§r en erfaren bid manager. Generera kritiska fr√•gor f√∂r Elisa RFP.

KONTEXT: Elisa (finsk telecom, ‚Ç¨2.2B), Leadership Development, ~800 chefer, deadline 17 feb 2026.

LUCKOR I V√ÖRT F√ñRSLAG: ${gaps.length > 0 ? gaps.join('; ') : 'Inga kritiska'}
${blindspotsContext}

F√ñRSLAG: ${allContent}

GENERERA fr√•gor i detta format f√∂r varje relevant sektion:

SEKTION 3.X: [Titel]
- FR√ÖGA: "[Exakt formulering]"
- PRIORITET: [kritisk/viktig/nice-to-know]
- VARF√ñR: [Kort motivering]
- OM INGET SVAR: "[Vad vi antar/g√∂r]"

Ge 5-10 konkreta fr√•gor. B√∂rja med de viktigaste.${customerIntelligence ? '\nFokusera p√• fr√•gor som adresserar blindspots fr√•n researchen!' : ''}`;
            };

            const handleCopy = async () => {
                await navigator.clipboard.writeText(generateQuestionsPrompt());
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleRunAI = async () => {
                setStep('loading');
                setIsLoading(true);
                setError(null);
                try {
                    const result = await callClaudeAPI(apiKey, generateQuestionsPrompt());
                    setAiResult(result);
                    const parsed = parseAISuggestions(result);
                    setSuggestions(parsed.length > 0 ? parsed : []);
                    setStep(parsed.length > 0 ? 'review' : 'result');
                } catch (err) {
                    setError(err.message);
                    setStep('select');
                }
                setIsLoading(false);
            };

            const handleApplyAll = () => {
                const accepted = suggestions.filter(s => s.status === 'accepted');
                if (accepted.length === 0 || !onUpdateResponses) return;
                // For questions, we might add them as notes to relevant sections
                const notes = accepted.map(s => `‚ùì ${s.suggestedText || s.suggestion}`).join('\n');
                alert(`‚úÖ ${accepted.length} fr√•gor noterade!\n\nKopiera dessa till din fr√•gelista:\n\n${notes}`);
                onClose();
            };

            const handleReset = () => {
                setAiResult(null);
                setError(null);
                setSuggestions([]);
                setStep('select');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-amber-500 to-amber-600 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">‚ùì Kritiska Fr√•gor</h2>
                                    <p className="text-amber-200 text-sm">
                                        {apiKey ? 'ü§ñ AI genererar fr√•gor ‚Üí Granska ‚Üí Exportera' : 'Kopiera prompt'}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {step === 'select' && (
                                <div className="mb-6">
                                    <h3 className="font-semibold text-gray-800 mb-3">Typ av fr√•gor:</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                        {questionTypes.map(t => (
                                            <button key={t.id} onClick={() => setQuestionType(t.id)}
                                                className={`p-3 rounded-lg border-2 text-left transition-all ${questionType === t.id ? 'border-amber-500 bg-amber-50' : 'border-gray-200 hover:border-amber-300'}`}>
                                                <span className="text-2xl">{t.icon}</span>
                                                <p className="font-medium text-sm mt-1">{t.name}</p>
                                                <p className="text-xs text-gray-500">{t.desc}</p>
                                            </button>
                                        ))}
                                    </div>
                                    {error && <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-xl"><p className="text-red-700 text-sm">‚ùå {error}</p></div>}
                                </div>
                            )}

                            {step === 'loading' && (
                                <div className="text-center py-12">
                                    <div className="animate-spin text-6xl mb-4">üîÑ</div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">Genererar fr√•gor...</h3>
                                </div>
                            )}

                            {step === 'review' && suggestions.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-bold text-lg text-gray-800">Granska fr√•gor ({suggestions.length})</h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">‚Üê B√∂rja om</button>
                                    </div>
                                    <SuggestionsList suggestions={suggestions} onSuggestionsChange={setSuggestions} onApplyAll={handleApplyAll} rfpSections={rfpSections} />
                                </div>
                            )}

                            {step === 'result' && aiResult && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="font-bold text-lg text-gray-800">üìä Genererade fr√•gor</h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">‚Üê Ny analys</button>
                                    </div>
                                    <div className="p-4 bg-gray-50 rounded-xl border" style={{maxHeight: '400px', overflowY: 'auto'}}>
                                        <pre className="whitespace-pre-wrap text-sm font-sans">{aiResult}</pre>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-500">{apiKey ? <span className="text-green-600">ü§ñ AI aktiverad</span> : <span>Kopiera prompt manuellt</span>}</div>
                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">St√§ng</button>
                                {step === 'select' && (
                                    <>
                                        <button onClick={handleCopy} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">üìã Kopiera prompt</button>
                                        {apiKey && <button onClick={handleRunAI} className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700">ü§ñ Generera fr√•gor</button>}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 3. STAKEHOLDER MAPPING MODAL
        function StakeholderMappingModal({ isOpen, onClose, responses, apiKey, onUpdateResponses, customerIntelligence }) {
            const [copied, setCopied] = useState(false);
            const [selectedStakeholder, setSelectedStakeholder] = useState('all');
            const [isLoading, setIsLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [suggestions, setSuggestions] = useState([]);
            const [error, setError] = useState(null);
            const [step, setStep] = useState('select'); // 'select', 'loading', 'review', 'result'

            // Default stakeholders (used if no customer intelligence loaded)
            const defaultStakeholders = [
                { id: 'all', role: 'Alla stakeholders', icon: 'üéØ', priority: 'HIGH', focus: 'Komplett analys f√∂r alla beslutsfattare', wins: 'Helhetsbild av v√•ra styrkor' },
                { id: 'chro', role: 'CHRO / HR Director', icon: 'üë•', priority: 'HIGH', focus: 'Programme quality, L&D strategy alignment, employee experience', wins: 'Proven methodology, measurable outcomes, scalability' },
                { id: 'cfo', role: 'CFO / Finance', icon: 'üí∞', priority: 'HIGH', focus: 'ROI, budget compliance, cost predictability', wins: 'Clear pricing, business case, TCO transparency' },
                { id: 'procurement', role: 'Procurement Lead', icon: 'üìã', priority: 'HIGH', focus: 'Compliance, risk mitigation, SLA', wins: 'References, certifications, contract terms' },
                { id: 'business', role: 'Business Line Heads', icon: 'üìà', priority: 'MEDIUM', focus: 'Minimal disruption, quick impact, relevance', wins: 'Flexible delivery, real business challenges' },
                { id: 'ceo', role: 'CEO/Executive Sponsor', icon: 'üëî', priority: 'MEDIUM', focus: 'Strategic alignment, transformation signal', wins: 'Strategic narrative, credibility, vision' }
            ];

            // Merge with real stakeholders from customer intelligence if available
            const elisaStakeholders = customerIntelligence?.keyStakeholders?.length > 0
                ? [
                    { id: 'all', role: 'Alla stakeholders', icon: 'üéØ', priority: 'HIGH', focus: 'Komplett analys f√∂r alla beslutsfattare', wins: 'Helhetsbild av v√•ra styrkor', isReal: false },
                    ...customerIntelligence.keyStakeholders.map((s, i) => ({
                        id: `real_${i}`,
                        role: `${s.name} (${s.role})`,
                        icon: s.role.includes('CEO') ? 'üëî' : s.role.includes('CFO') ? 'üí∞' : s.role.includes('People') || s.role.includes('HR') ? 'üë•' : 'üìã',
                        priority: 'HIGH',
                        focus: s.focus || 'Baserat p√• research',
                        wins: s.winWith || 'Anpassade argument',
                        isReal: true,
                        originalData: s
                    })),
                    ...defaultStakeholders.filter(s => s.id !== 'all')
                ]
                : defaultStakeholders;

            const generateStakeholderPrompt = () => {
                const allContent = rfpSections.map(s => `### ${s.id} ${s.title}\n${responses[s.id] || '[TOM]'}`).join('\n\n');

                // Build stakeholder context based on selection and customer intelligence
                const selectedInfo = elisaStakeholders.find(s => s.id === selectedStakeholder);
                const stakeholderInstructions = selectedStakeholder === 'all'
                    ? `Analysera hur v√•rt f√∂rslag uppfattas av ALLA stakeholders.`
                    : `Fokusera analysen p√• **${selectedInfo?.role}** och vad de specifikt beh√∂ver se.`;

                // Enhanced context from customer intelligence
                let intelContext = '';
                if (customerIntelligence) {
                    intelContext = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üî¨ KUNDINSIKT FR√ÖN RESEARCH (${customerIntelligence.sourceCount} k√§llor):

**IDENTIFIERADE BESLUTSFATTARE:**
${customerIntelligence.keyStakeholders?.map(s => `- **${s.name}** (${s.role})`).join('\n') || 'Ej specificerat'}

**ELISAS STRATEGISKA PRIORITERINGAR:**
${customerIntelligence.strategicPriorities?.keyFindings?.slice(0, 3).join('\n- ') || 'Ej laddat'}

**KULTUR & V√ÑRDERINGAR:**
${customerIntelligence.companyCulture?.keyFindings?.slice(0, 2).join('\n- ') || 'Ej laddat'}

**BUDGET-SIGNALER (viktigt f√∂r CFO):**
${customerIntelligence.budgetSignals?.keyFindings?.slice(0, 2).join('\n- ') || 'Ej laddat'}

ANV√ÑND DESSA VERKLIGA NAMN OCH INSIKTER i dina rekommendationer!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
                }

                return `Du √§r en strategisk bid-r√•dgivare som hj√§lper oss vinna Elisa-aff√§ren genom smart stakeholder-hantering.

${stakeholderInstructions}
${intelContext}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë• STAKEHOLDER-ROLLER ATT √ñVERTYGA:

${elisaStakeholders.filter(s => s.id !== 'all').map(s => `**${s.role}** [${s.priority}]
   Fokus: ${s.focus}
   Vinner med: ${s.wins}`).join('\n\n')}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìù V√ÖRT F√ñRSLAG:
${allContent}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
VIKTIGT: Ge KONKRETA F√ñRB√ÑTTRINGSF√ñRSLAG per sektion.
${customerIntelligence ? 'Anv√§nd VERKLIGA NAMN p√• stakeholders d√§r m√∂jligt!' : ''}

F√∂r varje rekommendation, strukturera s√• h√§r:

SEKTION 3.X: [Titel]
- PROBLEM: [Vad saknas f√∂r att √∂vertyga stakeholdern]
- ALLVARLIGHET: [kritisk/viktig/f√∂rb√§ttring]
- F√ñRESLAGEN TEXT: "[Konkret textf√∂rslag som kan l√§ggas till]"
- STAKEHOLDER: [${customerIntelligence ? 'Namn och roll' : 'Roll'}]

Exempel:
SEKTION 3.7: Pricing and Commercial Terms
- PROBLEM: ${customerIntelligence?.keyStakeholders?.find(s => s.role.includes('CFO'))?.name || 'CFO'} saknar j√§mf√∂relse med alternativkostnad
- ALLVARLIGHET: viktig
- F√ñRESLAGEN TEXT: "J√§mf√∂rt med en felrekrytering (750,000 SEK) motsvarar investeringen per chef bara 3% av denna risk."
- STAKEHOLDER: ${customerIntelligence?.keyStakeholders?.find(s => s.role.includes('CFO'))?.name || 'CFO'} (CFO)

G√• igenom ALLA relevanta sektioner och ge konkreta f√∂rslag f√∂r att vinna ${selectedStakeholder === 'all' ? 'varje stakeholder' : 'denna stakeholder'}.`;
            };

            const handleCopy = async () => {
                await navigator.clipboard.writeText(generateStakeholderPrompt());
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleRunAI = async () => {
                setStep('loading');
                setIsLoading(true);
                setError(null);
                try {
                    const result = await callClaudeAPI(apiKey, generateStakeholderPrompt());
                    setAiResult(result);
                    const parsed = parseAISuggestions(result);
                    setSuggestions(parsed.length > 0 ? parsed : []);
                    setStep(parsed.length > 0 ? 'review' : 'result');
                } catch (err) {
                    setError(err.message);
                    setStep('select');
                }
                setIsLoading(false);
            };

            const handleApplyAll = () => {
                const accepted = suggestions.filter(s => s.status === 'accepted');
                if (accepted.length === 0 || !onUpdateResponses) return;

                const bySection = {};
                accepted.forEach(s => {
                    if (!bySection[s.sectionId]) bySection[s.sectionId] = [];
                    bySection[s.sectionId].push(s.suggestedText || s.suggestion);
                });

                const newResponses = { ...responses };
                Object.entries(bySection).forEach(([sectionId, texts]) => {
                    const current = newResponses[sectionId] || '';
                    const additions = texts.join('\n\n');
                    newResponses[sectionId] = current + (current ? '\n\n---\nüë• STAKEHOLDER-ANPASSNINGAR:\n' : '') + additions;
                });

                onUpdateResponses(newResponses);
                onClose();
            };

            const handleReset = () => {
                setAiResult(null);
                setError(null);
                setSuggestions([]);
                setStep('select');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">üë• Stakeholder Mapping</h2>
                                    <p className="text-purple-200 text-sm">
                                        {step === 'select' && (apiKey ? 'ü§ñ V√§lj stakeholder ‚Üí AI analyserar ‚Üí Granska ‚Üí Applicera' : 'Kopiera prompt')}
                                        {step === 'loading' && '‚è≥ Analyserar...'}
                                        {step === 'review' && '‚úÖ Granska och godk√§nn f√∂rslag'}
                                        {step === 'result' && 'üìä Analysresultat'}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* Step 1: Stakeholder Selector */}
                            {step === 'select' && (
                                <>
                                    <div className="mb-6">
                                        <h3 className="font-semibold text-gray-800 mb-3">1Ô∏è‚É£ V√§lj stakeholder-perspektiv:</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                            {elisaStakeholders.map(s => (
                                                <button key={s.id} onClick={() => setSelectedStakeholder(s.id)}
                                                    className={`p-3 rounded-lg border-2 text-left transition-all ${
                                                        selectedStakeholder === s.id ? 'border-purple-500 bg-purple-50' :
                                                        s.priority === 'HIGH' ? 'border-red-200 bg-red-50/50 hover:border-purple-300' :
                                                        'border-gray-200 hover:border-purple-300'
                                                    }`}>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-2xl">{s.icon}</span>
                                                        <span className="font-medium text-sm">{s.role}</span>
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-1">{s.focus}</p>
                                                </button>
                                            ))}
                                        </div>
                                        {error && <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-xl"><p className="text-red-700 text-sm">‚ùå {error}</p></div>}
                                    </div>
                                </>
                            )}

                            {/* Loading */}
                            {step === 'loading' && (
                                <div className="text-center py-12">
                                    <div className="animate-spin text-6xl mb-4">üîÑ</div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">Analyserar stakeholder-fit...</h3>
                                    <p className="text-gray-500">AI granskar hur f√∂rslaget uppfattas av {selectedStakeholder === 'all' ? 'alla beslutsfattare' : elisaStakeholders.find(s => s.id === selectedStakeholder)?.role}</p>
                                </div>
                            )}

                            {/* Review Step */}
                            {step === 'review' && suggestions.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-bold text-lg text-gray-800">Granska stakeholder-anpassningar ({suggestions.length})</h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">‚Üê B√∂rja om</button>
                                    </div>
                                    <SuggestionsList suggestions={suggestions} onSuggestionsChange={setSuggestions} onApplyAll={handleApplyAll} rfpSections={rfpSections} />
                                </div>
                            )}

                            {/* Result without structured suggestions */}
                            {step === 'result' && aiResult && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="font-bold text-lg text-gray-800">üìä Stakeholder-analys</h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">‚Üê Ny analys</button>
                                    </div>
                                    <div className="p-4 bg-gray-50 rounded-xl border" style={{maxHeight: '400px', overflowY: 'auto'}}>
                                        <pre className="whitespace-pre-wrap text-sm font-sans">{aiResult}</pre>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-500">{apiKey ? <span className="text-green-600">ü§ñ AI aktiverad</span> : <span>Kopiera prompt manuellt</span>}</div>
                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">St√§ng</button>
                                {step === 'select' && (
                                    <>
                                        <button onClick={handleCopy} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">üìã Kopiera prompt</button>
                                        {apiKey && <button onClick={handleRunAI} className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ü§ñ Analysera stakeholders</button>}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 4. ROI / BUSINESS CASE MODAL
        function ROICalculatorModal({ isOpen, onClose, responses, apiKey, onUpdateResponses, customerIntelligence }) {
            const [copied, setCopied] = useState(false);
            const [participants, setParticipants] = useState(800);
            const [pricePerPerson, setPricePerPerson] = useState(15000);
            const [programDuration, setProgramDuration] = useState(12);
            const [isLoading, setIsLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [suggestions, setSuggestions] = useState([]);
            const [error, setError] = useState(null);
            const [step, setStep] = useState('input'); // 'input', 'loading', 'review', 'result'

            const totalInvestment = participants * pricePerPerson;

            const generateROIPrompt = () => {
                const allContent = rfpSections.map(s => `### ${s.id} ${s.title}\n${responses[s.id] || '[TOM]'}`).join('\n\n');

                // Add budget signals from customer intelligence
                let budgetContext = '';
                if (customerIntelligence?.budgetSignals?.keyFindings?.length > 0) {
                    budgetContext = `

üî¨ BUDGET-SIGNALER FR√ÖN KUNDRESEARCH (${customerIntelligence.sourceCount} k√§llor):
${customerIntelligence.budgetSignals.keyFindings.slice(0, 4).map(f => `- ${f}`).join('\n')}

**CFO-PROFIL:**
${customerIntelligence.keyStakeholders?.find(s => s.role.includes('CFO'))
    ? `${customerIntelligence.keyStakeholders.find(s => s.role.includes('CFO')).name} - anpassa argumenten f√∂r denna person!`
    : 'Ej specificerad'}

ANPASSA BUSINESS CASET TILL DESSA SIGNALER!`;
                }

                return `Du √§r en expert p√• att bygga √∂vertygande business cases f√∂r leadership development-investeringar.
${budgetContext}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä ELISA INVESTMENT PARAMETERS:

**Grunddata:**
- Antal deltagare: ${participants} chefer
- Investering per person: ${pricePerPerson.toLocaleString()} SEK
- Total investering: ${totalInvestment.toLocaleString()} SEK
- Programl√§ngd: ${programDuration} m√•nader

**Elisa nyckeltal${customerIntelligence ? ' (verifierat fr√•n research)' : ' (uppskattade)'}:**
- Oms√§ttning: ‚Ç¨2.2B (~25 miljarder SEK)
- Antal anst√§llda: ~5000
- Genomsnittlig chef ansvarar f√∂r: 6-8 medarbetare
- Strategi: "Faster, profitable growth"${customerIntelligence?.strategicPriorities?.keyFindings?.[0] ? ` - "${customerIntelligence.strategicPriorities.keyFindings[0].substring(0, 100)}..."` : ''}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìù V√ÖRT F√ñRSLAG:
${allContent}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
VIKTIGT: Generera KONKRETA TEXTF√ñRSLAG som kan l√§ggas till i relevanta sektioner.

F√∂r varje ROI-argument, strukturera s√• h√§r:

SEKTION 3.X: [Mest relevanta sektionen]
- PROBLEM: [Vad saknas i v√•r ROI/business case-kommunikation]
- ALLVARLIGHET: [kritisk/viktig/f√∂rb√§ttring]
- F√ñRESLAGEN TEXT: "[Konkret text med siffror som kan l√§ggas till]"

Exempel:
SEKTION 3.7: Pricing and Commercial Terms
- PROBLEM: Saknar j√§mf√∂relse med alternativkostnad
- ALLVARLIGHET: viktig
- F√ñRESLAGEN TEXT: "INVESTMENT CONTEXT: Kostnaden per chef (${Math.round(totalInvestment / participants).toLocaleString()} SEK) motsvarar endast 3% av kostnaden f√∂r en felrekrytering (750,000 SEK) och ger avkastning i 3+ √•r."

SEKTION 3.5: Measurement and Impact
- PROBLEM: Saknar kvantifierad ROI-prognos
- ALLVARLIGHET: kritisk
- F√ñRESLAGEN TEXT: "EXPECTED ROI: Konservativt estimat baserat p√• 5% produktivitets√∂kning visar 210 MSEK √•rlig effekt, vilket ger >2000% ROI p√• investeringen."

Generera 5-8 konkreta textf√∂rslag f√∂r sektioner 3.2, 3.5, 3.7 med fokus p√•:
1. ROI-argumentation (siffror, j√§mf√∂relser)
2. Risk-argumentation (cost of inaction)
3. CFO-anpassade formuleringar`;
            };

            const handleCopy = async () => {
                await navigator.clipboard.writeText(generateROIPrompt());
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleRunAI = async () => {
                setStep('loading');
                setIsLoading(true);
                setError(null);
                try {
                    const result = await callClaudeAPI(apiKey, generateROIPrompt());
                    setAiResult(result);
                    const parsed = parseAISuggestions(result);
                    setSuggestions(parsed.length > 0 ? parsed : []);
                    setStep(parsed.length > 0 ? 'review' : 'result');
                } catch (err) {
                    setError(err.message);
                    setStep('input');
                }
                setIsLoading(false);
            };

            const handleApplyAll = () => {
                const accepted = suggestions.filter(s => s.status === 'accepted');
                if (accepted.length === 0 || !onUpdateResponses) return;

                const bySection = {};
                accepted.forEach(s => {
                    if (!bySection[s.sectionId]) bySection[s.sectionId] = [];
                    bySection[s.sectionId].push(s.suggestedText || s.suggestion);
                });

                const newResponses = { ...responses };
                Object.entries(bySection).forEach(([sectionId, texts]) => {
                    const current = newResponses[sectionId] || '';
                    const additions = texts.join('\n\n');
                    newResponses[sectionId] = current + (current ? '\n\n---\nüí∞ ROI/BUSINESS CASE:\n' : '') + additions;
                });

                onUpdateResponses(newResponses);
                onClose();
            };

            const handleReset = () => {
                setAiResult(null);
                setError(null);
                setSuggestions([]);
                setStep('input');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">üí∞ ROI / Effektcase Builder</h2>
                                    <p className="text-green-200 text-sm">
                                        {step === 'input' && (apiKey ? 'ü§ñ Ange parametrar ‚Üí AI genererar ‚Üí Granska ‚Üí Applicera' : 'Kopiera prompt')}
                                        {step === 'loading' && '‚è≥ Bygger business case...'}
                                        {step === 'review' && '‚úÖ Granska och godk√§nn ROI-argument'}
                                        {step === 'result' && 'üìä Business case genererat'}
                                    </p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">√ó</button>
                            </div>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* Step 1: Input Parameters */}
                            {step === 'input' && (
                                <>
                                    <div className="mb-6 p-4 bg-green-50 rounded-xl border border-green-200">
                                        <h3 className="font-semibold text-green-800 mb-3">1Ô∏è‚É£ Anpassa parametrar:</h3>
                                        <div className="grid md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Antal deltagare</label>
                                                <input
                                                    type="number"
                                                    value={participants}
                                                    onChange={(e) => setParticipants(parseInt(e.target.value) || 0)}
                                                    className="w-full p-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Pris per person (SEK)</label>
                                                <input
                                                    type="number"
                                                    value={pricePerPerson}
                                                    onChange={(e) => setPricePerPerson(parseInt(e.target.value) || 0)}
                                                    className="w-full p-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Programl√§ngd (m√•n)</label>
                                                <input
                                                    type="number"
                                                    value={programDuration}
                                                    onChange={(e) => setProgramDuration(parseInt(e.target.value) || 0)}
                                                    className="w-full p-2 border rounded-lg"
                                                />
                                            </div>
                                        </div>
                                        <div className="mt-4 p-3 bg-white rounded-lg border border-green-300">
                                            <p className="text-2xl font-bold text-green-700">
                                                Total investering: {totalInvestment.toLocaleString()} SEK
                                            </p>
                                            <p className="text-sm text-gray-600">
                                                = {Math.round(totalInvestment / participants).toLocaleString()} SEK per chef |
                                                {' '}{Math.round(totalInvestment / participants / programDuration).toLocaleString()} SEK per chef per m√•nad
                                            </p>
                                        </div>
                                    </div>
                                    {error && <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-xl"><p className="text-red-700 text-sm">‚ùå {error}</p></div>}
                                </>
                            )}

                            {/* Loading */}
                            {step === 'loading' && (
                                <div className="text-center py-12">
                                    <div className="animate-spin text-6xl mb-4">üîÑ</div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">Bygger ROI business case...</h3>
                                    <p className="text-gray-500">AI r√§knar p√• produktivitet, turnover och effekter f√∂r {participants} chefer</p>
                                </div>
                            )}

                            {/* Review Step */}
                            {step === 'review' && suggestions.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-bold text-lg text-gray-800">Granska ROI-argument ({suggestions.length})</h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">‚Üê √Ñndra parametrar</button>
                                    </div>
                                    <SuggestionsList suggestions={suggestions} onSuggestionsChange={setSuggestions} onApplyAll={handleApplyAll} rfpSections={rfpSections} />
                                </div>
                            )}

                            {/* Result without structured suggestions */}
                            {step === 'result' && aiResult && (
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="font-bold text-lg text-gray-800">üìä Business Case</h3>
                                        <button onClick={handleReset} className="text-sm text-gray-500 hover:text-gray-700">‚Üê Ny ber√§kning</button>
                                    </div>
                                    <div className="p-4 bg-gray-50 rounded-xl border" style={{maxHeight: '400px', overflowY: 'auto'}}>
                                        <pre className="whitespace-pre-wrap text-sm font-sans">{aiResult}</pre>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="border-t p-4 bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-500">{apiKey ? <span className="text-green-600">ü§ñ AI aktiverad</span> : <span>Kopiera prompt manuellt</span>}</div>
                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">St√§ng</button>
                                {step === 'input' && (
                                    <>
                                        <button onClick={handleCopy} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">üìã Kopiera prompt</button>
                                        {apiKey && <button onClick={handleRunAI} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ü§ñ Generera business case</button>}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [responses, setResponses] = useState(initialResponses);
            const [evaluations, setEvaluations] = useState({});
            const [showImportModal, setShowImportModal] = useState(false);
            const [showDistributeModal, setShowDistributeModal] = useState(false);
            const [showSkillModal, setShowSkillModal] = useState(false);
            const [customSkills, setCustomSkills] = useState([]);

            // ============================================
            // HITL APPROVAL SYSTEM
            // Tracks human review status for each section
            // ============================================
            const [sectionApprovals, setSectionApprovals] = useState(() => {
                try {
                    const stored = localStorage.getItem('doings_section_approvals');
                    return stored ? JSON.parse(stored) : {};
                } catch (e) { return {}; }
            });

            const [sectionComments, setSectionComments] = useState(() => {
                try {
                    const stored = localStorage.getItem('doings_section_comments');
                    return stored ? JSON.parse(stored) : {};
                } catch (e) { return {}; }
            });

            const [showReviewModal, setShowReviewModal] = useState(false);

            // Save approvals to localStorage
            useEffect(() => {
                try { localStorage.setItem('doings_section_approvals', JSON.stringify(sectionApprovals)); } catch (e) {}
            }, [sectionApprovals]);

            useEffect(() => {
                try { localStorage.setItem('doings_section_comments', JSON.stringify(sectionComments)); } catch (e) {}
            }, [sectionComments]);

            // Save responses to localStorage
            useEffect(() => {
                try { localStorage.setItem('doings_responses', JSON.stringify(responses)); } catch (e) {}
            }, [responses]);

            // Approval helper functions
            const approveSection = (sectionId) => {
                setSectionApprovals(prev => ({
                    ...prev,
                    [sectionId]: {
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        approvedBy: 'Human'
                    }
                }));
            };

            const requestChanges = (sectionId, comment) => {
                setSectionApprovals(prev => ({
                    ...prev,
                    [sectionId]: {
                        status: 'changes-requested',
                        requestedAt: new Date().toISOString(),
                        comment: comment
                    }
                }));
            };

            const resetApproval = (sectionId) => {
                setSectionApprovals(prev => {
                    const newApprovals = { ...prev };
                    delete newApprovals[sectionId];
                    return newApprovals;
                });
            };

            const addSectionComment = (sectionId, comment) => {
                setSectionComments(prev => ({
                    ...prev,
                    [sectionId]: [...(prev[sectionId] || []), {
                        text: comment,
                        createdAt: new Date().toISOString()
                    }]
                }));
            };

            // Calculate review status
            const getReviewStatus = () => {
                const sectionsWithContent = rfpSections.filter(s =>
                    responses[s.id]?.trim().length > 50
                );

                const approved = sectionsWithContent.filter(s =>
                    sectionApprovals[s.id]?.status === 'approved'
                );

                const changesRequested = sectionsWithContent.filter(s =>
                    sectionApprovals[s.id]?.status === 'changes-requested'
                );

                const pending = sectionsWithContent.filter(s =>
                    !sectionApprovals[s.id]
                );

                return {
                    total: sectionsWithContent.length,
                    approved: approved.length,
                    changesRequested: changesRequested.length,
                    pending: pending.length,
                    allApproved: sectionsWithContent.length > 0 && approved.length === sectionsWithContent.length,
                    readyForExport: sectionsWithContent.length > 0 && approved.length === sectionsWithContent.length
                };
            };

            const reviewStatus = getReviewStatus();

            // Strategic Analysis Tools
            const [showWeaknessModal, setShowWeaknessModal] = useState(false);
            const [showQuestionsModal, setShowQuestionsModal] = useState(false);
            const [showStakeholderModal, setShowStakeholderModal] = useState(false);
            const [showROIModal, setShowROIModal] = useState(false);

            // AI API Integration
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [apiKey, setApiKey] = useState(() => {
                try { return localStorage.getItem('doings_claude_api_key') || ''; }
                catch (e) { return ''; }
            });

            const saveApiKey = (key) => {
                setApiKey(key);
                try { localStorage.setItem('doings_claude_api_key', key); }
                catch (e) { console.warn('Could not save API key to localStorage'); }
            };

            // Perplexity API Key (for web search research)
            const [perplexityKey, setPerplexityKey] = useState(() => {
                try { return localStorage.getItem('doings_perplexity_api_key') || ''; }
                catch (e) { return ''; }
            });

            const savePerplexityKey = (key) => {
                setPerplexityKey(key);
                try { localStorage.setItem('doings_perplexity_api_key', key); }
                catch (e) { console.warn('Could not save Perplexity key to localStorage'); }
            };

            // ============================================
            // RFP DOCUMENT UPLOAD
            // Stores uploaded RFP file content for analysis
            // ============================================
            const [rfpDocument, setRfpDocument] = useState(() => {
                try {
                    const stored = localStorage.getItem('doings_rfp_document');
                    return stored ? JSON.parse(stored) : null;
                } catch (e) { return null; }
            });
            const [isUploadingRfp, setIsUploadingRfp] = useState(false);
            const [rfpUploadError, setRfpUploadError] = useState(null);

            // Handle RFP file upload
            const handleRfpFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setIsUploadingRfp(true);
                setRfpUploadError(null);

                try {
                    let extractedText = '';
                    const fileName = file.name;
                    const fileType = file.name.split('.').pop().toLowerCase();

                    if (fileType === 'txt' || fileType === 'md') {
                        // Plain text files
                        extractedText = await file.text();
                    } else if (fileType === 'docx') {
                        // Word documents using mammoth.js
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        extractedText = result.value;
                    } else if (fileType === 'pdf') {
                        // PDF files using pdf.js
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        const textParts = [];

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            textParts.push(pageText);
                        }
                        extractedText = textParts.join('\n\n');
                    } else {
                        throw new Error(`Filtypen .${fileType} st√∂ds inte. Anv√§nd .pdf, .docx, .txt eller .md`);
                    }

                    // Create data URL for viewing the original file (works better than blob URL)
                    const fileDataUrl = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });

                    const rfpData = {
                        fileName,
                        fileType,
                        uploadedAt: new Date().toISOString(),
                        content: extractedText,
                        wordCount: extractedText.split(/\s+/).length,
                        charCount: extractedText.length,
                        fileDataUrl: fileDataUrl  // Base64 data URL for viewing
                    };

                    setRfpDocument(rfpData);
                    // Note: We don't save fileDataUrl to localStorage as it's too large
                    try {
                        const storageData = { ...rfpData };
                        delete storageData.fileDataUrl; // Don't save large base64 data
                        localStorage.setItem('doings_rfp_document', JSON.stringify(storageData));
                    } catch (e) {
                        console.warn('Could not save RFP to localStorage (might be too large)');
                    }

                } catch (err) {
                    console.error('RFP upload error:', err);
                    setRfpUploadError(err.message);
                } finally {
                    setIsUploadingRfp(false);
                }
            };

            const clearRfpDocument = () => {
                setRfpDocument(null);
                try { localStorage.removeItem('doings_rfp_document'); } catch (e) {}
            };

            // ============================================
            // CUSTOMER INTELLIGENCE (Fas 1: Research)
            // Stores structured data from external research
            // Used by all analysis agents for context
            // ============================================
            const [showCustomerIntelModal, setShowCustomerIntelModal] = useState(false);
            const [customerIntelligence, setCustomerIntelligence] = useState(() => {
                try {
                    const stored = localStorage.getItem('doings_customer_intelligence');
                    return stored ? JSON.parse(stored) : null;
                } catch (e) { return null; }
            });

            const handleLoadCustomerIntel = (intel) => {
                setCustomerIntelligence(intel);
                // Log for debugging
                if (intel) {
                    console.log('‚úÖ Customer Intelligence loaded:', {
                        sources: intel.sourceCount,
                        stakeholders: intel.keyStakeholders?.length,
                        categories: Object.keys(intel).filter(k => intel[k]?.keyFindings?.length > 0).length
                    });
                }
            };

            // ============================================
            // RESET ALL - CLEAR DATA AND START FRESH
            // Clears all localStorage data EXCEPT API keys
            // ============================================
            const handleResetAll = () => {
                // Clear localStorage (keep API keys)
                try {
                    localStorage.removeItem('doings_rfp_document');
                    localStorage.removeItem('doings_customer_intelligence');
                    localStorage.removeItem('doings_section_approvals');
                    localStorage.removeItem('doings_section_comments');
                    localStorage.removeItem('doings_company_knowledge');
                    localStorage.removeItem('doings_responses');
                    // Note: We keep doings_claude_api_key and doings_perplexity_api_key
                } catch (e) {
                    console.warn('Could not clear localStorage:', e);
                }

                // Reset React state to empty
                setResponses(emptyResponses);
                setEvaluations({});
                setSectionApprovals({});
                setSectionComments({});
                setRfpDocument(null);
                setCustomerIntelligence(null);
                setCustomSkills([]);

                // Close any open modals
                setShowSettingsModal(false);

                console.log('‚úÖ All data cleared. Ready for a fresh start!');
            };

            // ============================================
            // AGENT REGISTRY & ORCHESTRATION SYSTEM
            // Defines all agents, their skills, and workflow
            // ============================================

            /**
             * AGENT DEFINITIONS
             * Each agent has: id, name, icon, role, skills, inputs, outputs
             * Skills = what the agent knows how to do
             * Inputs = what data it needs to operate
             * Outputs = what it produces
             */
            const AGENT_REGISTRY = {
                // === FAS 1: RESEARCH AGENTS ===
                researchAgent: {
                    id: 'research',
                    name: 'Research Agent',
                    icon: 'üî¨',
                    phase: 1,
                    role: 'Samla djup kundinsikt fr√•n 25+ webk√§llor',
                    skills: [
                        'Perplexity API web-s√∂kning',
                        'Multi-s√∂kning (8 fokusomr√•den)',
                        'K√§ll-aggregering & deduplicering',
                        'Stakeholder-identifiering',
                        'Strategisk insikts-extraktion'
                    ],
                    inputs: ['Kundnamn', 'RFP-dokument (valfritt)', 'Kontext'],
                    outputs: ['customerIntelligence', 'citations[]', 'keyStakeholders[]'],
                    status: 'ready', // ready | working | done | needs-input
                    dependsOn: []
                },

                // === FAS 2: ANALYSIS AGENTS ===
                weaknessAgent: {
                    id: 'weakness',
                    name: 'Weakness Detector',
                    icon: 'üî¥',
                    phase: 2,
                    role: 'Hitta svagheter och luckor i f√∂rslaget',
                    skills: [
                        'Krav-gap-analys',
                        'Stakeholder-alignment-check',
                        'Konkurrensperspektiv',
                        'Tonalitetsanalys mot kundkultur',
                        'ROI-argumentation-granskning'
                    ],
                    inputs: ['responses', 'customerIntelligence', 'rfpSections'],
                    outputs: ['weaknesses[]', 'suggestions[]'],
                    status: 'waiting',
                    dependsOn: ['research', 'doings']
                },

                stakeholderAgent: {
                    id: 'stakeholder',
                    name: 'Stakeholder Mapper',
                    icon: 'üë•',
                    phase: 2,
                    role: 'Mappa f√∂rslaget mot k√§nda beslutsfattare',
                    skills: [
                        'Beslutsfattar-profiling',
                        'Anpassningsf√∂rslag per stakeholder',
                        'Win-theme-identifiering',
                        'Maktbalans-analys',
                        'Kommunikationsstil-anpassning'
                    ],
                    inputs: ['responses', 'customerIntelligence.keyStakeholders'],
                    outputs: ['stakeholderMapping', 'adjustments[]'],
                    status: 'waiting',
                    dependsOn: ['research']
                },

                questionsAgent: {
                    id: 'questions',
                    name: 'Critical Questions',
                    icon: '‚ùì',
                    phase: 2,
                    role: 'Identifiera obesvarade fr√•gor och blindspots',
                    skills: [
                        'Gap-identifiering',
                        'Antagande-utmaning',
                        'Risk-flaggning',
                        'Klarifikations-prioritering',
                        'Blindspot-detektion'
                    ],
                    inputs: ['responses', 'customerIntelligence.blindspots', 'rfpSections'],
                    outputs: ['criticalQuestions[]', 'assumptions[]'],
                    status: 'waiting',
                    dependsOn: ['research']
                },

                roiAgent: {
                    id: 'roi',
                    name: 'ROI & Business Case',
                    icon: 'üí∞',
                    phase: 2,
                    role: 'Bygga √∂vertygande business case och ROI-argument',
                    skills: [
                        'ROI-kalkylering',
                        'CFO-anpassad argumentation',
                        'Benchmark-j√§mf√∂relser',
                        'Payback-period-analys',
                        'Risk-reward-balansering'
                    ],
                    inputs: ['responses', 'customerIntelligence.budgetSignals', 'doingsKnowledge.pricing'],
                    outputs: ['businessCase', 'roiArguments[]'],
                    status: 'waiting',
                    dependsOn: ['research', 'doings']
                },

                // === FAS 0: DOINGS AGENT (Company Knowledge - BUILT-IN) ===
                doingsAgent: {
                    id: 'doings',
                    name: 'Doings Expert',
                    icon: 'üéØ',
                    phase: 0, // Always available
                    role: 'F√∂rmedla Doings v√§rde, metoder och erbjudande',
                    skills: [
                        'Learning by Doings-metodik',
                        '5 Capabilities Framework',
                        'RFP Sektion-guide (3.1-3.8)',
                        'Priss√§ttning & paket',
                        'Brand Voice & Key Phrases'
                    ],
                    inputs: [],  // No external inputs needed - built into DOINGS_RFP_GUIDE
                    outputs: ['valueProposition', 'methodology', 'differentiators[]'],
                    status: 'ready',  // Always ready - built-in knowledge
                    builtIn: true,
                    dependsOn: []
                },

                // === FAS 3: WRITING AGENTS ===
                writerAgent: {
                    id: 'writer',
                    name: 'Response Writer',
                    icon: '‚úçÔ∏è',
                    phase: 3,
                    role: 'Skriva och f√∂rb√§ttra RFP-svar',
                    skills: [
                        'Aff√§rsspr√•k-anpassning',
                        'Kundton-matchning',
                        'Krav-adressering',
                        'Value proposition-integrering',
                        'Storytelling & narrativ'
                    ],
                    inputs: ['rfpSections', 'customerIntelligence', 'doingsKnowledge', 'analysisResults'],
                    outputs: ['responses{}'],
                    status: 'waiting',
                    dependsOn: ['weakness', 'stakeholder', 'doings']
                },

                // === ORCHESTRATOR ===
                orchestrator: {
                    id: 'orchestrator',
                    name: 'Workflow Orchestrator',
                    icon: 'üé≠',
                    phase: 0,
                    role: 'Koordinera alla agenter och f√∂resl√• n√§sta steg',
                    skills: [
                        'Fas-progression-hantering',
                        'Dependency-resolution',
                        'Status-tracking',
                        'Next-step-recommendation',
                        'Quality-gate-enforcement'
                    ],
                    inputs: ['allAgentStatus', 'customerIntelligence', 'responses'],
                    outputs: ['workflowStatus', 'nextStepRecommendation'],
                    status: 'ready',
                    dependsOn: []
                }
            };

            // Doings Knowledge Base - What Doings does and offers
            const [doingsKnowledge, setDoingsKnowledge] = useState(() => {
                try {
                    const stored = localStorage.getItem('doings_company_knowledge');
                    return stored ? JSON.parse(stored) : {
                        companyName: 'Doings',
                        tagline: 'Vi f√•r ledare att v√§xa',
                        methodology: {
                            name: 'ACTION-metoden',
                            pillars: ['Awareness', 'Clarity', 'Trust', 'Impact', 'Ownership', 'Next-level'],
                            description: 'Bepr√∂vad metodik f√∂r ledarskapsutveckling'
                        },
                        offerings: [
                            { name: 'Ledarskapsutbildning', description: 'Skr√§ddarsydda program f√∂r alla ledarniv√•er' },
                            { name: 'Team-facilitering', description: 'Workshops och teamutveckling' },
                            { name: 'Executive Coaching', description: '1:1 coaching f√∂r seniora ledare' },
                            { name: 'Kultur-transformation', description: 'L√•ngsiktiga f√∂r√§ndringsprogram' }
                        ],
                        differentiators: [
                            'Erfarenhet fr√•n 500+ organisationer',
                            'Kombinerar teori med praktik',
                            'M√§tbar ROI och uppf√∂ljning',
                            'Certifierade facilitatorer',
                            'Nordisk approach'
                        ],
                        certifications: [],
                        references: [],
                        pricing: {},
                        loaded: false
                    };
                } catch (e) { return { loaded: false }; }
            });

            // Save Doings knowledge to localStorage
            useEffect(() => {
                if (doingsKnowledge?.loaded) {
                    try { localStorage.setItem('doings_company_knowledge', JSON.stringify(doingsKnowledge)); } catch (e) {}
                }
            }, [doingsKnowledge]);

            // State for "Ready to Generate" modal
            const [showReadyToGenerateModal, setShowReadyToGenerateModal] = useState(false);
            const [isGeneratingAll, setIsGeneratingAll] = useState(false);
            const [generationProgress, setGenerationProgress] = useState({ current: 0, total: 0, section: '' });

            // State for showing/hiding original RFP source text
            const [showRfpSource, setShowRfpSource] = useState(false);

            // ============================================
            // RFP REQUIREMENT ANALYSIS & AGENT MATCHING
            // Maps each RFP section to the best agent(s)
            // ============================================

            const getRfpRequirementAnalysis = () => {
                // Map sections to agents based on content type
                const sectionAgentMapping = {
                    '3.1': { // Company Information
                        primaryAgent: 'doings',
                        supportAgents: [],
                        focus: 'F√∂retagsfakta, certifikat, referenser',
                        keyInsights: ['Doings metodik', 'Certifieringar', 'Referenscase']
                    },
                    '3.2': { // Programme Design
                        primaryAgent: 'writer',
                        supportAgents: ['stakeholder', 'doings'],
                        focus: 'Programdesign anpassad till kundens strategi',
                        keyInsights: ['Kundstrategi', 'Coach-Challenger-Connector', 'ACTION-metoden']
                    },
                    '3.3': { // Content and Delivery
                        primaryAgent: 'writer',
                        supportAgents: ['doings'],
                        focus: 'Moduler, format, tidplan',
                        keyInsights: ['Leveransformat', 'Tids√•tagande', 'Niv√•anpassning']
                    },
                    '3.4': { // Trainer Qualifications
                        primaryAgent: 'doings',
                        supportAgents: [],
                        focus: 'Facilitatorprofiler och certifikat',
                        keyInsights: ['ICF-certifiering', 'Erfarenhet', 'Spr√•kkompetens']
                    },
                    '3.5': { // Measurement and Impact
                        primaryAgent: 'roi',
                        supportAgents: ['writer'],
                        focus: 'ROI, m√§tmetoder, beteendef√∂r√§ndring',
                        keyInsights: ['M√§tmetoder', 'ROI-exempel', 'Impact-tracking']
                    },
                    '3.6': { // Programme Delivery & Governance
                        primaryAgent: 'writer',
                        supportAgents: ['doings'],
                        focus: 'Projektledning, KAM, support',
                        keyInsights: ['Governance-modell', 'Riskhantering', 'Uppf√∂ljning']
                    },
                    '3.7': { // Pricing
                        primaryAgent: 'roi',
                        supportAgents: ['doings'],
                        focus: 'Priss√§ttning, villkor, rabatter',
                        keyInsights: ['Prismodell', 'Volymrabatter', 'Betalningsvillkor']
                    },
                    '3.8': { // Compliance
                        primaryAgent: 'doings',
                        supportAgents: [],
                        focus: 'GDPR, datahantering, IP-r√§ttigheter',
                        keyInsights: ['GDPR-compliance', 'DPA', 'Datas√§kerhet']
                    }
                };

                // Build full analysis
                const analysis = rfpSections.map(section => {
                    const mapping = sectionAgentMapping[section.id] || { primaryAgent: 'writer', supportAgents: [] };
                    const primaryAgentInfo = AGENT_REGISTRY[mapping.primaryAgent + 'Agent'] || AGENT_REGISTRY.writerAgent;

                    return {
                        sectionId: section.id,
                        sectionTitle: section.title,
                        requirements: section.requirements,
                        requirementCount: section.requirements.length,
                        weight: section.weight,
                        primaryAgent: {
                            id: mapping.primaryAgent,
                            name: primaryAgentInfo?.name || 'Writer',
                            icon: primaryAgentInfo?.icon || '‚úçÔ∏è'
                        },
                        supportAgents: mapping.supportAgents,
                        focus: mapping.focus,
                        keyInsights: mapping.keyInsights,
                        hasExistingResponse: (responses[section.id]?.trim().length || 0) > 50,
                        existingResponseLength: responses[section.id]?.length || 0
                    };
                });

                const totalRequirements = analysis.reduce((sum, s) => sum + s.requirementCount, 0);
                const sectionsWithResponses = analysis.filter(s => s.hasExistingResponse).length;

                return {
                    sections: analysis,
                    totalRequirements,
                    totalSections: analysis.length,
                    sectionsWithResponses,
                    readyToGenerate: true,
                    missingPrereqs: []
                };
            };

            // Calculate workflow status and next step recommendation
            const getWorkflowStatus = () => {
                const hasRfp = !!rfpDocument?.content;
                const hasCustomerIntel = !!customerIntelligence;
                // DOINGS_RFP_GUIDE is now BUILT-IN, so Doings knowledge is always available!
                // Additional custom skills can enhance, but are not required
                const hasDoingsKnowledge = true; // Built-in via DOINGS_RFP_GUIDE
                const hasExtraSkills = doingsKnowledge?.loaded || customSkills.length > 0;
                const hasResponses = Object.values(responses).some(r => r?.trim().length > 50);
                const allPrereqsMet = hasRfp && hasCustomerIntel; // Doings is always ready

                // Determine current phase and next step
                let currentPhase = 0;
                let nextStep = null;
                let readyAgents = [];
                let waitingAgents = [];

                if (!hasRfp) {
                    nextStep = { action: 'upload-rfp', label: 'Ladda upp RFP-dokument', icon: 'üìÑ', priority: 'high' };
                } else if (!hasCustomerIntel) {
                    currentPhase = 1;
                    nextStep = { action: 'load-intel', label: 'Generera kundinsikt med Research Agent', icon: 'üî¨', priority: 'high' };
                } else if (!hasResponses && allPrereqsMet) {
                    // All prerequisites met - Doings Expert + Research done = Ready to generate!
                    currentPhase = 2;
                    nextStep = {
                        action: 'ready-to-generate',
                        label: 'üöÄ Alla agenter redo - Generera RFP-svar!',
                        icon: '‚ú®',
                        priority: 'high',
                        description: 'Doings Expert + Kundinsikt laddad. Redo att besvara alla sektioner.'
                    };
                } else if (hasResponses) {
                    // Check review status - reviewStatus is calculated separately
                    const sectionsWithContent = rfpSections.filter(s => responses[s.id]?.trim().length > 50);
                    const approvedCount = sectionsWithContent.filter(s => sectionApprovals[s.id]?.status === 'approved').length;
                    const allApproved = sectionsWithContent.length > 0 && approvedCount === sectionsWithContent.length;

                    if (allApproved) {
                        currentPhase = 4;
                        nextStep = { action: 'export', label: 'üì§ Exportera f√∂rslaget', icon: 'üéâ', priority: 'low' };
                    } else if (approvedCount > 0) {
                        currentPhase = 4;
                        nextStep = { action: 'review', label: `üë§ Granska (${approvedCount}/${sectionsWithContent.length})`, icon: 'üë§', priority: 'high' };
                    } else {
                        currentPhase = 3;
                        nextStep = { action: 'review', label: 'üë§ Granska & godk√§nn svar', icon: 'üë§', priority: 'high' };
                    }
                } else {
                    currentPhase = 2;
                    nextStep = { action: 'start-writing', label: 'B√∂rja skriva svar', icon: '‚úçÔ∏è', priority: 'medium' };
                }

                // Determine agent readiness
                Object.values(AGENT_REGISTRY).forEach(agent => {
                    if (agent.id === 'orchestrator') return;

                    const depsReady = agent.dependsOn.every(dep => {
                        if (dep === 'research') return hasCustomerIntel;
                        if (dep === 'doings') return hasDoingsKnowledge;
                        return true;
                    });

                    if (depsReady) {
                        readyAgents.push(agent);
                    } else {
                        waitingAgents.push(agent);
                    }
                });

                return {
                    currentPhase,
                    nextStep,
                    readyAgents,
                    waitingAgents,
                    hasRfp,
                    hasCustomerIntel,
                    hasDoingsKnowledge, // Always true (built-in)
                    hasExtraSkills,     // Additional user-uploaded skills
                    hasResponses,
                    allPrereqsMet,
                    totalAgents: Object.keys(AGENT_REGISTRY).length - 1, // Exclude orchestrator
                    // Progress = USER actions only (Doings is built-in, not counted)
                    // 0% start ‚Üí 100% when responses generated
                    completionPercent: Math.round(
                        (hasRfp ? 20 : 0) +           // Step 1: Upload RFP (20%)
                        (hasCustomerIntel ? 30 : 0) + // Step 2: Customer intel (30%)
                        (hasResponses ? 50 : 0)       // Step 3: Generate responses (50%)
                    )
                };
            };

            // ============================================
            // GENERATE ALL RESPONSES FUNCTION
            // Uses Claude API to generate responses for each section
            // ============================================
            const generateAllResponses = async () => {
                if (!apiKey) {
                    alert('‚ùå Claude API-nyckel saknas. G√• till Inst√§llningar.');
                    return;
                }

                setIsGeneratingAll(true);
                const sectionsToGenerate = rfpSections.filter(s =>
                    !responses[s.id] || responses[s.id].trim().length < 50
                );

                setGenerationProgress({ current: 0, total: sectionsToGenerate.length, section: '' });

                const newResponses = { ...responses };

                for (let i = 0; i < sectionsToGenerate.length; i++) {
                    const section = sectionsToGenerate[i];
                    setGenerationProgress({
                        current: i + 1,
                        total: sectionsToGenerate.length,
                        section: `${section.id} ${section.title}`
                    });

                    try {
                        // Build context-rich prompt
                        const prompt = buildSectionPrompt(section);
                        const response = await callClaudeAPI(apiKey, prompt);
                        newResponses[section.id] = response;

                        // Update state progressively
                        setResponses({ ...newResponses });

                        // Small delay to avoid rate limiting
                        if (i < sectionsToGenerate.length - 1) {
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    } catch (err) {
                        console.error(`Error generating ${section.id}:`, err);
                        newResponses[section.id] = `[GENERERING MISSLYCKADES: ${err.message}]\n\nF√∂rs√∂k igen eller skriv manuellt.`;
                    }
                }

                setIsGeneratingAll(false);
                setShowReadyToGenerateModal(false);
                setGenerationProgress({ current: 0, total: 0, section: '' });
            };

            // Build a rich prompt for a specific section using Doings Expert Skill
            const buildSectionPrompt = (section) => {
                // Get customer intelligence context
                const customerContext = customerIntelligence ? `
## KUNDINSIKT (${customerIntelligence.sourceCount || 0} k√§llor)

### Kundens strategiska prioriteringar:
${customerIntelligence.strategicPriorities?.keyFindings?.slice(0, 5).join('\n- ') || 'Ej tillg√§ngligt'}

### Kundens utmaningar:
${customerIntelligence.currentChallenges?.keyFindings?.slice(0, 3).join('\n- ') || 'Ej tillg√§ngligt'}

### Identifierade beslutsfattare:
${customerIntelligence.keyStakeholders?.map(s => `- ${s.name} (${s.role})`).join('\n') || 'Ej tillg√§ngligt'}

### Kundens kultur:
${customerIntelligence.companyCulture?.keyFindings?.slice(0, 3).join('\n- ') || 'Ej tillg√§ngligt'}
` : '';

                // Get section-specific guidance from global Doings Expert Skill
                const sectionGuide = DOINGS_RFP_GUIDE.sections[section.id] || {};

                const doingsExpertContext = `
## DOINGS EXPERT AGENT - SEKTION ${section.id} GUIDE

### Brand Voice
- Warm but professional - Never stiff or corporate
- Action-oriented - Focus on "doing", not just knowing
- Results-driven - Emphasize behavioral change and business impact
- Co-creative - Position as partner, not vendor

### Key Phrases to Use
- "Learning by Doings"
- "People Experts doing greater business"
- "From words to action"
- "Sustainable change"

### Core Methodology: MAKE IT HAPPEN ‚Üí MAKE THE CHANGE ‚Üí MAKE IT LAST

### The 5 Capabilities Framework
1. Commit to the Journey - Vision, values, self-leadership
2. Accelerate Development - Change management, growth mindset
3. Create Psychological Safety - Trust, inclusion, communication
4. Build Engagement - Motivation, feedback, coaching
5. Work Smarter - Prioritization, delegation, sustainable performance

${sectionGuide.positioning ? `### Positioning for this section:\n${sectionGuide.positioning}` : ''}
${sectionGuide.differentiators ? `### Differentiators to highlight:\n${sectionGuide.differentiators.map(d => `- ${d}`).join('\n')}` : ''}
${sectionGuide.methodology ? `### Methodology to describe: ${sectionGuide.methodology}` : ''}
${sectionGuide.keyMessages ? `### Key messages:\n${sectionGuide.keyMessages.map(m => `- ${m}`).join('\n')}` : ''}
${sectionGuide.levels ? `### Programme levels:\n- First-Line: ${sectionGuide.levels.firstLine.focus}, ${sectionGuide.levels.firstLine.duration}\n- Mid-Level: ${sectionGuide.levels.midLevel.focus}, ${sectionGuide.levels.midLevel.duration}\n- VP/Executive: ${sectionGuide.levels.vpExecutive.focus}, ${sectionGuide.levels.vpExecutive.duration}` : ''}
${sectionGuide.framework ? `### Measurement framework:\n${sectionGuide.framework.map(f => `- ${f.level}: ${f.metric} (${f.method})`).join('\n')}` : ''}
${sectionGuide.pricing ? `### Pricing guidance:\n- First-Line: ${sectionGuide.pricing.firstLine}\n- Mid-Level: ${sectionGuide.pricing.midLevel}\n- VP/Executive: ${sectionGuide.pricing.vpExecutive}` : ''}
${sectionGuide.volumeDiscounts ? `### Volume discounts:\n${sectionGuide.volumeDiscounts.map(d => `- ${d}`).join('\n')}` : ''}
${sectionGuide.commitment ? `### Commitment statement:\n"${sectionGuide.commitment}"` : ''}
`;

                // Get custom skills if loaded
                const customSkillsContext = customSkills.length > 0 ? `
## ADDITIONAL LOADED SKILLS
${customSkills.map(s => `### ${s.name}\n${s.content?.substring(0, 800) || ''}`).join('\n\n')}
` : '';

                return `You are the Doings Expert Agent - specialist in writing persuasive RFP responses for leadership development.

Task:
Write a professional, persuasive response for section ${section.id} "${section.title}" in an RFP for Elisa Corporation.

Section Requirements (all must be addressed):
${section.requirements.map((r, i) => `${i + 1}. ${r}`).join('\n')}

Weight: This section weighs ${section.weight}% of the total assessment.
Evaluation criterion: ${section.evaluationCriteria}

${customerContext}

${doingsExpertContext}

${customSkillsContext}

Instructions:
1. Address each requirement explicitly and clearly
2. Use customer intelligence to demonstrate understanding of Elisa's situation
3. Use the Doings Expert guide for section ${section.id} specifically
4. Integrate "Learning by Doings" methodology naturally
5. Be concrete with numbers, examples and references
6. Keep professional but warm tone (Doings brand voice)
7. Avoid generic consultant jargon and passive voice
8. Length: 300-600 words

Format:
Write the response directly. Use short paragraphs. Be concrete, not vague.

Important formatting rules:
- Write in English only
- Do not use emojis
- Do not use all caps for entire words (only first letter capitalized is ok)
- Do not use markdown like ** or ##
- Headings can use Title Case followed by colon (e.g., "Heading:")
- Lists with dashes (-) are ok

Write the response now (no markdown):`;
            };

            // Get workflow status
            const workflowStatus = getWorkflowStatus();

            const addCustomSkill = (skill) => {
                setCustomSkills(prev => [...prev, skill]);
                // Mark Doings knowledge as loaded if we add skills
                if (!doingsKnowledge?.loaded) {
                    setDoingsKnowledge(prev => ({ ...prev, loaded: true }));
                }
            };

            useEffect(() => {
                const newEvaluations = {};
                rfpSections.forEach(section => {
                    newEvaluations[section.id] = evaluateResponse(section.id, responses[section.id] || '', section.requirements);
                });
                setEvaluations(newEvaluations);
            }, [responses]);

            const handleResponseChange = (sectionId, newResponse) => {
                setResponses(prev => ({ ...prev, [sectionId]: newResponse }));
            };

            const handleApplyDistributed = (distributedSections) => {
                setResponses(prev => {
                    const newResponses = { ...prev };
                    Object.entries(distributedSections).forEach(([id, content]) => {
                        if (content) {
                            newResponses[id] = content;
                        }
                    });
                    return newResponses;
                });
            };

            const handleApplyExtracted = (extracted) => {
                const newResponses = applyExtractedData(responses, extracted);
                setResponses(newResponses);
            };

            const handleExport = () => {
                const md = exportToMarkdown(responses, evaluations);
                downloadMarkdown(md, `Elisa_RFP_Export_${new Date().toISOString().split('T')[0]}.md`);
            };

            const overallScore = Object.values(evaluations).reduce((sum, e) => sum + (e.score || 0), 0) / rfpSections.length;
            const totalGaps = Object.values(evaluations).reduce((sum, e) => sum + (e.gaps?.length || 0), 0);
            const criticalSections = Object.entries(evaluations).filter(([_, e]) => e.hasCriticalGaps).length;

            return (
                <div className="min-h-screen bg-gray-100">
                    <div className="gradient-bg text-white no-print">
                        <div className="max-w-6xl mx-auto px-4 py-6">
                            <div className="flex items-center justify-between flex-wrap gap-4">
                                <div>
                                    <h1 className="text-2xl font-bold">Elisa RFP Evaluator</h1>
                                    <p className="text-teal-200 text-sm">Interactive tool to optimise your RFP response</p>
                                </div>
                                <div className="flex items-center gap-3 flex-wrap">
                                    {/* Customer Intelligence Button - Fas 1 */}
                                    <button onClick={() => setShowCustomerIntelModal(true)}
                                            className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ${
                                                customerIntelligence
                                                    ? 'bg-green-500 text-white hover:bg-green-400'
                                                    : 'bg-indigo-600 text-white hover:bg-indigo-500 animate-pulse'
                                            }`}
                                            title={customerIntelligence
                                                ? `Kundinsikt laddad (${customerIntelligence.sourceCount} k√§llor)`
                                                : 'Ladda kundinsikt fr√•n research - G√ñR DETTA F√ñRST!'
                                            }>
                                        üî¨ {customerIntelligence ? `Intel ‚úì (${customerIntelligence.sourceCount})` : 'Kundinsikt'}
                                    </button>
                                    <button onClick={() => setShowSkillModal(true)}
                                            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                workflowStatus.hasDoingsKnowledge
                                                    ? 'bg-green-500 text-white hover:bg-green-400'
                                                    : workflowStatus.hasCustomerIntel
                                                        ? 'bg-indigo-600 text-white hover:bg-indigo-500 animate-pulse'
                                                        : 'bg-indigo-600 text-white hover:bg-indigo-500'
                                            }`}
                                            title={`${workflowStatus.readyAgents.length} agenter redo, ${customSkills.length} kunskapsdokument`}>
                                        ü§ñ Agenter ({workflowStatus.readyAgents.length}/{workflowStatus.totalAgents})
                                    </button>
                                    <button onClick={() => setShowImportModal(true)}
                                            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                workflowStatus.hasDoingsKnowledge
                                                    ? 'bg-green-500 text-white hover:bg-green-400'
                                                    : 'bg-teal-500 text-white hover:bg-teal-400'
                                            }`}
                                            title="Klistra in TEXT med Doings-info: priser, org.nr, namn, certifikat">
                                        üéØ {workflowStatus.hasDoingsKnowledge ? 'Doings ‚úì' : 'Doings-info'}
                                    </button>
                                    <button onClick={() => setShowDistributeModal(true)}
                                            className="bg-orange-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-400 transition-colors"
                                            title="Klistra in AI-genererat svar med 3.1-3.8 och f√∂rdela automatiskt">
                                        üéØ F√∂rdela AI-svar
                                    </button>

                                    {/* HITL Review Button */}
                                    {reviewStatus.total > 0 && (
                                        <button onClick={() => setShowReviewModal(true)}
                                                className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ${
                                                    reviewStatus.allApproved
                                                        ? 'bg-green-500 text-white hover:bg-green-400'
                                                        : reviewStatus.changesRequested > 0
                                                            ? 'bg-red-500 text-white hover:bg-red-400 animate-pulse'
                                                            : 'bg-purple-600 text-white hover:bg-purple-500 animate-pulse'
                                                }`}
                                                title={`${reviewStatus.approved}/${reviewStatus.total} godk√§nda`}>
                                            üë§ Granska ({reviewStatus.approved}/{reviewStatus.total})
                                        </button>
                                    )}

                                    <label className="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-400 transition-colors cursor-pointer"
                                           title="Ladda .docx med sektioner 3.1-3.8 formaterade">
                                        üìÑ Word ‚Üí Sektioner
                                        <input
                                            type="file"
                                            accept=".docx"
                                            className="hidden"
                                            onChange={async (e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    try {
                                                        const text = await importWordDocument(file);
                                                        const distributed = localDistributeText(text);
                                                        const foundCount = Object.values(distributed).filter(v => v).length;
                                                        if (foundCount > 0) {
                                                            setResponses(prev => {
                                                                const newResponses = { ...prev };
                                                                Object.entries(distributed).forEach(([id, content]) => {
                                                                    if (content) newResponses[id] = content;
                                                                });
                                                                return newResponses;
                                                            });
                                                            alert(`‚úÖ Word-dokument importerat!\n\nHittade ${foundCount} sektioner.`);
                                                        } else {
                                                            alert('‚ö†Ô∏è Kunde inte hitta sektioner (3.1, 3.2 etc) i dokumentet.');
                                                        }
                                                    } catch (err) {
                                                        alert('‚ùå Kunde inte l√§sa Word-dokumentet: ' + err.message);
                                                    }
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                    </label>
                                    <div className="relative group">
                                        <button className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                            reviewStatus.allApproved
                                                ? 'bg-green-500 text-white hover:bg-green-400'
                                                : 'bg-white text-slate-800 hover:bg-gray-100'
                                        }`}>
                                            üì§ Export {reviewStatus.allApproved ? '‚úì' : ''} ‚ñæ
                                        </button>
                                        <div className="absolute right-0 mt-1 w-64 bg-white rounded-lg shadow-xl border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                                            {/* Export Gate Warning */}
                                            {!reviewStatus.allApproved && reviewStatus.total > 0 && (
                                                <div className="px-4 py-3 bg-amber-50 border-b border-amber-200 rounded-t-lg">
                                                    <p className="text-xs text-amber-700 font-medium">‚ö†Ô∏è Inte alla sektioner godk√§nda</p>
                                                    <p className="text-xs text-amber-600">
                                                        {reviewStatus.approved}/{reviewStatus.total} godk√§nda
                                                    </p>
                                                    <button
                                                        onClick={() => setShowReviewModal(true)}
                                                        className="mt-2 text-xs text-amber-700 underline hover:text-amber-900"
                                                    >
                                                        ‚Üí √ñppna granskning
                                                    </button>
                                                </div>
                                            )}

                                            {/* Approved Export */}
                                            {reviewStatus.allApproved && (
                                                <div className="px-4 py-2 bg-green-50 border-b border-green-200 rounded-t-lg">
                                                    <p className="text-xs text-green-700 font-medium">‚úÖ Alla sektioner godk√§nda!</p>
                                                </div>
                                            )}

                                            <button onClick={() => {
                                                        if (!reviewStatus.allApproved && reviewStatus.total > 0) {
                                                            if (!confirm('‚ö†Ô∏è Inte alla sektioner √§r godk√§nda av HITL.\n\nVill du exportera √§nd√•?')) return;
                                                        }
                                                        exportToWord(responses, evaluations);
                                                    }}
                                                    className={`w-full text-left px-4 py-2 text-sm hover:bg-gray-100 font-medium ${
                                                        reviewStatus.allApproved ? 'text-green-700' : 'text-gray-700'
                                                    }`}>
                                                üìÑ Word (.doc) {reviewStatus.allApproved && '‚úì'}
                                            </button>
                                            <button onClick={() => {
                                                        if (!reviewStatus.allApproved && reviewStatus.total > 0) {
                                                            if (!confirm('‚ö†Ô∏è Inte alla sektioner √§r godk√§nda.\n\nVill du exportera √§nd√•?')) return;
                                                        }
                                                        exportToExcel(responses, evaluations);
                                                    }}
                                                    className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                üìä Excel (.xlsx)
                                            </button>
                                            <button onClick={() => {
                                                        if (!reviewStatus.allApproved && reviewStatus.total > 0) {
                                                            if (!confirm('‚ö†Ô∏è Inte alla sektioner √§r godk√§nda.\n\nVill du exportera √§nd√•?')) return;
                                                        }
                                                        handleExport();
                                                    }}
                                                    className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                üìù Markdown (.md)
                                            </button>
                                            <button onClick={() => {
                                                        if (!reviewStatus.allApproved && reviewStatus.total > 0) {
                                                            if (!confirm('‚ö†Ô∏è Inte alla sektioner √§r godk√§nda.\n\nVill du exportera √§nd√•?')) return;
                                                        }
                                                        exportToCSV(responses, evaluations);
                                                    }}
                                                    className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-lg">
                                                üìã CSV (.csv)
                                            </button>
                                        </div>
                                    </div>
                                    <button onClick={() => setShowSettingsModal(true)}
                                            className={`px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ${
                                                (apiKey && perplexityKey)
                                                    ? 'bg-green-500 text-white hover:bg-green-400'
                                                    : (apiKey || perplexityKey)
                                                        ? 'bg-yellow-500 text-white hover:bg-yellow-400'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                            title="Konfigurera API-nycklar">
                                        ‚öôÔ∏è <span className="text-xs">
                                            {apiKey && perplexityKey ? 'Alla API' : apiKey ? 'Claude' : perplexityKey ? 'Perplexity' : 'API'}
                                        </span>
                                    </button>
                                    <div className="text-right">
                                        <p className="text-sm text-teal-200">Deadline</p>
                                        <p className="font-semibold">17 February 2026</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Workflow Status Bar - Shows next step and agent readiness */}
                    <div className="bg-gradient-to-r from-slate-900 to-slate-800 border-b border-slate-700">
                        <div className="max-w-6xl mx-auto px-4 py-3">
                            <div className="flex items-center justify-between flex-wrap gap-4">
                                {/* Progress Indicator */}
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        <div className="w-32 h-2 bg-slate-700 rounded-full overflow-hidden">
                                            <div
                                                className="h-full bg-gradient-to-r from-teal-500 to-green-500 transition-all duration-500"
                                                style={{ width: `${workflowStatus.completionPercent}%` }}
                                            />
                                        </div>
                                        <span className="text-xs text-slate-400">{workflowStatus.completionPercent}%</span>
                                    </div>

                                    {/* Phase Indicators */}
                                    <div className="hidden sm:flex items-center gap-1">
                                        {[
                                            { phase: 1, label: 'Research', icon: 'üî¨' },
                                            { phase: 2, label: 'Analys', icon: 'üî¥' },
                                            { phase: 3, label: 'Skrivande', icon: '‚úçÔ∏è' }
                                        ].map((p, i) => (
                                            <div
                                                key={p.phase}
                                                className={`flex items-center gap-1 px-2 py-1 rounded text-xs ${
                                                    workflowStatus.currentPhase >= p.phase
                                                        ? 'bg-teal-500/20 text-teal-300'
                                                        : 'bg-slate-700/50 text-slate-500'
                                                }`}
                                            >
                                                <span>{p.icon}</span>
                                                <span className="hidden md:inline">{p.label}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Next Step Suggestion */}
                                {workflowStatus.nextStep && (
                                    <button
                                        onClick={() => {
                                            if (workflowStatus.nextStep.action === 'load-intel') setShowCustomerIntelModal(true);
                                            else if (workflowStatus.nextStep.action === 'sync-knowledge') setShowSkillModal(true);
                                            else if (workflowStatus.nextStep.action === 'upload-rfp') {/* Already shown */}
                                            else if (workflowStatus.nextStep.action === 'run-analysis') setShowWeaknessModal(true);
                                            else if (workflowStatus.nextStep.action === 'ready-to-generate') setShowReadyToGenerateModal(true);
                                            else if (workflowStatus.nextStep.action === 'review') setShowReviewModal(true);
                                            else if (workflowStatus.nextStep.action === 'export') exportToWord(responses, evaluations);
                                        }}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                            workflowStatus.nextStep.action === 'ready-to-generate'
                                                ? 'bg-gradient-to-r from-green-500 to-teal-500 text-white hover:from-green-400 hover:to-teal-400 animate-pulse shadow-lg'
                                                : workflowStatus.nextStep.action === 'review'
                                                    ? 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white hover:from-purple-400 hover:to-indigo-400 animate-pulse shadow-lg'
                                                    : workflowStatus.nextStep.action === 'export'
                                                        ? 'bg-gradient-to-r from-green-400 to-emerald-400 text-white hover:from-green-300 hover:to-emerald-300 shadow-lg'
                                                        : workflowStatus.nextStep.priority === 'high'
                                                            ? 'bg-teal-500 text-white hover:bg-teal-400 animate-pulse'
                                                            : 'bg-slate-700 text-slate-200 hover:bg-slate-600'
                                        }`}
                                    >
                                        <span>{workflowStatus.nextStep.icon}</span>
                                        <span>N√§sta steg: {workflowStatus.nextStep.label}</span>
                                        <span className="text-teal-300">‚Üí</span>
                                    </button>
                                )}

                                {/* Agent Status Summary */}
                                <div className="hidden lg:flex items-center gap-3 text-xs text-slate-400">
                                    <span className="flex items-center gap-1">
                                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                        {workflowStatus.readyAgents.length} redo
                                    </span>
                                    <span className="flex items-center gap-1">
                                        <span className="w-2 h-2 bg-amber-500 rounded-full"></span>
                                        {workflowStatus.waitingAgents.length} v√§ntar
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto px-4 mt-4">
                        {/* RFP Source Document Section */}
                        <div className="bg-gradient-to-r from-slate-800 to-slate-700 rounded-xl shadow-lg p-4 mb-4 text-white">
                            {rfpDocument ? (
                                /* RFP Uploaded - Show document info */
                                <>
                                    <div className="flex items-center justify-between flex-wrap gap-4">
                                        <div className="flex items-center gap-4">
                                            <div className="bg-green-500/20 rounded-lg p-3">
                                                <span className="text-3xl">üìÑ</span>
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-400 uppercase tracking-wide">Uppladdad RFP</p>
                                                <h3 className="font-bold text-lg">{rfpDocument.fileName}</h3>
                                                <p className="text-sm text-slate-300">
                                                    {(rfpDocument.wordCount || 0).toLocaleString()} ord ‚Ä¢
                                                    Uppladdad {new Date(rfpDocument.uploadedAt).toLocaleDateString('sv-SE')}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right mr-4">
                                                <p className="text-xs text-slate-400">Status</p>
                                                <p className="text-green-400 font-medium flex items-center gap-1">
                                                    <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                                    RFP Inl√§st ‚úì
                                                </p>
                                            </div>
                                            <button
                                                onClick={clearRfpDocument}
                                                className="bg-red-500/20 hover:bg-red-500/30 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 text-red-300"
                                            >
                                                üóëÔ∏è Ta bort
                                            </button>
                                        </div>
                                    </div>
                                    <div className="mt-3 pt-3 border-t border-white/10">
                                        <details className="text-sm">
                                            <summary className="cursor-pointer text-slate-400 hover:text-white">
                                                Visa extraherad text ({(rfpDocument.charCount || 0).toLocaleString()} tecken)
                                            </summary>
                                            <pre className="mt-2 p-3 bg-black/30 rounded-lg text-xs text-slate-300 max-h-48 overflow-auto whitespace-pre-wrap">
                                                {rfpDocument.content.substring(0, 3000)}
                                                {rfpDocument.content.length > 3000 && '...\n\n[Visar f√∂rsta 3000 tecken]'}
                                            </pre>
                                        </details>
                                    </div>
                                </>
                            ) : (
                                /* No RFP - Show upload interface as clickable drop zone */
                                <label htmlFor="rfp-file-upload-main" className="block cursor-pointer">
                                    <input
                                        type="file"
                                        accept=".pdf,.docx,.txt,.md"
                                        onChange={handleRfpFileUpload}
                                        className="hidden"
                                        id="rfp-file-upload-main"
                                        disabled={isUploadingRfp}
                                    />
                                    <div className={`border-2 border-dashed rounded-xl p-6 text-center transition-all ${
                                        isUploadingRfp
                                            ? 'border-gray-500 bg-gray-500/10'
                                            : 'border-teal-400/50 hover:border-teal-400 hover:bg-teal-500/10'
                                    }`}>
                                        <div className="text-5xl mb-3">
                                            {isUploadingRfp ? '‚è≥' : 'üìÑ'}
                                        </div>
                                        <h3 className="font-bold text-lg mb-1">
                                            {isUploadingRfp ? 'Laddar upp...' : 'Klicka h√§r f√∂r att ladda upp RFP'}
                                        </h3>
                                        <p className="text-sm text-slate-300 mb-3">
                                            PDF, Word (.docx) eller text (.txt)
                                        </p>
                                        <div className={`inline-block px-6 py-3 rounded-lg font-medium ${
                                            isUploadingRfp
                                                ? 'bg-gray-500'
                                                : 'bg-teal-600 hover:bg-teal-500'
                                        }`}>
                                            {isUploadingRfp ? '‚è≥ Bearbetar...' : 'üì§ V√§lj RFP-fil'}
                                        </div>
                                    </div>
                                    {rfpUploadError && (
                                        <div className="mt-3 p-3 bg-red-500/20 rounded-lg text-red-200 text-sm">
                                            ‚ùå {rfpUploadError}
                                        </div>
                                    )}
                                    <div className="mt-3 text-center">
                                        <span className="text-slate-400 text-xs">üí° RFP-texten anv√§nds som kontext f√∂r kundinsikt-s√∂kningen</span>
                                    </div>
                                </label>
                            )}
                        </div>

                        {/* Strategic Analysis Toolkit - Only shows AFTER responses are generated */}
                        {workflowStatus.hasResponses ? (
                            <div className="space-y-4 mb-4">
                                {/* Analysis Activation Banner - Explains the score and offers improvements */}
                                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-5 text-white">
                                    <div className="flex items-start justify-between flex-wrap gap-4">
                                        <div className="flex items-start gap-4">
                                            <div className="bg-white/20 rounded-xl p-3">
                                                <span className="text-3xl">üìä</span>
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-lg mb-1">
                                                    Svar genererade! Nuvarande score: {Math.round(overallScore)}%
                                                </h3>
                                                <p className="text-indigo-200 text-sm mb-3">
                                                    {overallScore >= 70
                                                        ? '‚úÖ Bra utg√•ngspunkt! Analysagenterna kan hitta ytterligare f√∂rb√§ttringar.'
                                                        : overallScore >= 50
                                                        ? '‚ö†Ô∏è Vissa luckor identifierade. L√•t agenterna analysera och f√∂resl√• f√∂rb√§ttringar.'
                                                        : 'üî¥ Flera kritiska omr√•den beh√∂ver √•tg√§rdas. Rekommenderar full analys.'}
                                                </p>
                                                <p className="text-xs text-indigo-300">
                                                    üí° Klicka p√• en analysagent nedan f√∂r att f√• specifika f√∂rb√§ttringsf√∂rslag du kan acceptera eller avvisa.
                                                </p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-5xl font-bold">{Math.round(overallScore)}%</p>
                                            <p className="text-xs text-indigo-300">Totalpo√§ng</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Analysis Agents Toolbar */}
                                <div className="bg-gradient-to-r from-amber-600 to-red-600 rounded-xl shadow-lg p-4 text-white">
                                    <div className="flex items-center justify-between flex-wrap gap-4">
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl">üéØ</span>
                                            <div>
                                                <p className="text-xs text-amber-200 uppercase tracking-wide">Strategic Analysis Toolkit</p>
                                                <p className="text-sm">V√§lj agent f√∂r att analysera och f√∂rb√§ttra dina svar</p>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            <button onClick={() => setShowWeaknessModal(true)}
                                                    className="bg-red-700 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md"
                                                    title="Hitta svagheter och luckor som evaluatorer kommer se">
                                                üî¥ Svaghetsdetektor
                                            </button>
                                            <button onClick={() => setShowQuestionsModal(true)}
                                                    className="bg-amber-700 hover:bg-amber-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md"
                                                    title="Vilka fr√•gor M√ÖSTE vi f√• svar p√• innan submission?">
                                                ‚ùì Kritiska Fr√•gor
                                            </button>
                                            <button onClick={() => setShowStakeholderModal(true)}
                                                    className="bg-purple-700 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md"
                                                    title="Kartl√§gg beslutsfattare och deras prioriteringar">
                                                üë• Stakeholders
                                            </button>
                                            <button onClick={() => setShowROIModal(true)}
                                                    className="bg-green-700 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md"
                                                    title="Bygg √∂vertygande business case med ROI">
                                                üí∞ ROI/Effektcase
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            /* Pre-generation state - Show that agents are waiting */
                            <div className="bg-gradient-to-r from-slate-600 to-slate-700 rounded-xl shadow-lg p-4 mb-4 text-white opacity-75">
                                <div className="flex items-center justify-between flex-wrap gap-4">
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">‚è≥</span>
                                        <div>
                                            <p className="text-xs text-slate-400 uppercase tracking-wide">Strategic Analysis Toolkit</p>
                                            <p className="text-sm">V√§ntar p√• genererade svar... Dessa agenter aktiveras efter att RFP-svar skapats.</p>
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap gap-2 opacity-50">
                                        <span className="px-3 py-2 rounded-lg text-sm bg-slate-600">üî¥ Svaghetsdetektor</span>
                                        <span className="px-3 py-2 rounded-lg text-sm bg-slate-600">‚ùì Kritiska Fr√•gor</span>
                                        <span className="px-3 py-2 rounded-lg text-sm bg-slate-600">üë• Stakeholders</span>
                                        <span className="px-3 py-2 rounded-lg text-sm bg-slate-600">üí∞ ROI</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Score Dashboard - Different view based on whether responses exist */}
                        {workflowStatus.hasResponses ? (
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                    <div className="text-center">
                                        <ScoreRing score={Math.round(overallScore)} size={100} />
                                        <p className="mt-2 font-medium text-gray-700">Total Score</p>
                                    </div>
                                    <div className="flex flex-col justify-center">
                                        <p className="text-4xl font-bold text-gray-900">{totalGaps}</p>
                                        <p className="text-sm text-gray-500">Identifierade luckor</p>
                                    </div>
                                    <div className="flex flex-col justify-center">
                                        <p className="text-4xl font-bold text-red-600">{criticalSections}</p>
                                        <p className="text-sm text-gray-500">Kritiska sektioner</p>
                                    </div>
                                    <div className="flex flex-col justify-center">
                                        <p className={`text-lg font-semibold ${overallScore >= 70 ? 'text-green-600' : overallScore >= 50 ? 'text-yellow-600' : 'text-red-600'}`}>
                                            {overallScore >= 70 ? 'üü¢ Konkurrenskraftigt' : overallScore >= 50 ? 'üü° Beh√∂ver arbete' : 'üî¥ Ej redo'}
                                        </p>
                                        <p className="text-sm text-gray-500">Bed√∂mning</p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            /* No responses yet - Show generation prompt */
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-dashed border-amber-300">
                                <div className="text-center py-4">
                                    <div className="inline-flex items-center gap-3 px-6 py-3 bg-amber-50 rounded-xl mb-4">
                                        <span className="text-4xl">0%</span>
                                        <div className="text-left">
                                            <p className="font-medium text-amber-800">Inga svar genererade √§nnu</p>
                                            <p className="text-sm text-amber-600">
                                                {workflowStatus.allPrereqsMet
                                                    ? '‚úì Alla f√∂ruts√§ttningar klara - redo att generera!'
                                                    : '‚è≥ Ladda RFP och kundinsikt f√∂rst'
                                                }
                                            </p>
                                        </div>
                                    </div>
                                    {workflowStatus.allPrereqsMet && (
                                        <button
                                            onClick={() => setShowReadyToGenerateModal(true)}
                                            className="px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-xl font-medium hover:from-green-700 hover:to-teal-700 shadow-lg flex items-center gap-2 mx-auto"
                                        >
                                            <span className="text-xl">üöÄ</span>
                                            Generera alla RFP-svar
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Critical sections warning - only show when responses exist */}
                    {workflowStatus.hasResponses && criticalSections > 0 && (
                        <div className="max-w-6xl mx-auto px-4 mb-6 no-print">
                            <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                                <h3 className="font-semibold text-red-800 mb-2">‚ö†Ô∏è Prioriterade √•tg√§rder</h3>
                                <ul className="text-sm text-red-700 space-y-1">
                                    {Object.entries(evaluations)
                                        .filter(([_, e]) => e.hasCriticalGaps)
                                        .map(([id, _]) => {
                                            const section = rfpSections.find(s => s.id === id);
                                            return <li key={id}>‚Ä¢ Sektion {id} ({section?.title}): Saknar grundl√§ggande information</li>;
                                        })}
                                </ul>
                                <p className="text-sm text-red-600 mt-3">
                                    üí° <strong>Tips:</strong> Anv√§nd f√∂rb√§ttringsagenterna p√• varje sektion f√∂r att fylla luckor automatiskt!
                                </p>
                            </div>
                        </div>
                    )}

                    <div className="max-w-6xl mx-auto px-4 pb-8">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-4">
                                <h2 className="text-lg font-semibold text-gray-700">
                                    RFP-sektioner ({rfpSections.length} st)
                                </h2>
                                {rfpDocument?.content && (
                                    <button
                                        onClick={() => setShowRfpSource(!showRfpSource)}
                                        className={`text-sm px-3 py-1.5 rounded-lg flex items-center gap-2 transition-colors ${
                                            showRfpSource
                                                ? 'bg-indigo-100 text-indigo-700 border border-indigo-300'
                                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                        }`}
                                    >
                                        <span>{showRfpSource ? 'üìñ' : 'üìÑ'}</span>
                                        {showRfpSource ? 'D√∂lj RFP-k√§lla' : 'Visa RFP-k√§lla'}
                                    </button>
                                )}
                            </div>
                            {!workflowStatus.hasResponses && (
                                <span className="text-sm text-amber-600 bg-amber-50 px-3 py-1 rounded-full">
                                    ‚è≥ V√§ntar p√• generering
                                </span>
                            )}
                        </div>

                        {/* Collapsible RFP Source Panel */}
                        {showRfpSource && rfpDocument?.content && (
                            <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-xl overflow-hidden">
                                <div className="bg-indigo-100 px-4 py-3 border-b border-indigo-200">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <span className="text-xl">üìÑ</span>
                                            <div>
                                                <h3 className="font-medium text-indigo-800">{rfpDocument.fileName}</h3>
                                                <p className="text-xs text-indigo-600">
                                                    {rfpDocument.wordCount?.toLocaleString()} ord ‚Ä¢ Uppladdad {new Date(rfpDocument.uploadedAt).toLocaleDateString('sv-SE')}
                                                </p>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => setShowRfpSource(false)}
                                            className="text-indigo-500 hover:text-indigo-700 text-xl"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                </div>
                                <div className="p-4 max-h-96 overflow-y-auto">
                                    <pre className="text-sm text-gray-700 whitespace-pre-wrap font-sans leading-relaxed">
                                        {rfpDocument.content}
                                    </pre>
                                </div>
                                <div className="bg-indigo-100 px-4 py-2 text-xs text-indigo-600 border-t border-indigo-200">
                                    üí° Tips: Anv√§nd denna text som referens n√§r du granskar de genererade svaren
                                </div>
                            </div>
                        )}

                        {rfpSections.map(section => (
                            <SectionCard
                                key={section.id}
                                section={section}
                                response={responses[section.id] || ''}
                                onResponseChange={handleResponseChange}
                                evaluation={evaluations[section.id] || { score: 0, checks: [], gaps: [], hasCriticalGaps: true, summary: 'Loading...' }}
                                apiKey={apiKey}
                                customerIntelligence={customerIntelligence}
                                doingsKnowledge={doingsKnowledge}
                            />
                        ))}
                    </div>

                    <div className="bg-slate-800 text-white py-6 no-print">
                        <div className="max-w-6xl mx-auto px-4 text-center">
                            <p className="text-sm text-gray-400">
                                Doings √ó Elisa RFP 2026 ‚Ä¢ Edit responses above and watch the evaluation update in real-time
                            </p>
                        </div>
                    </div>

                    <TextImportModal
                        isOpen={showImportModal}
                        onClose={() => setShowImportModal(false)}
                        onApply={handleApplyExtracted}
                    />

                    <DistributeModal
                        isOpen={showDistributeModal}
                        onClose={() => setShowDistributeModal(false)}
                        onApplyDistributed={handleApplyDistributed}
                    />

                    <SkillUploadModal
                        isOpen={showSkillModal}
                        onClose={() => setShowSkillModal(false)}
                        onAddSkill={addCustomSkill}
                        skills={customSkills}
                        workflowStatus={workflowStatus}
                        customerIntelligence={customerIntelligence}
                        doingsKnowledge={doingsKnowledge}
                    />

                    {/* ============================================
                        READY TO GENERATE MODAL
                        Shows RFP analysis and asks user to confirm
                        before generating all responses with AI
                    ============================================ */}
                    <ReadyToGenerateModal
                        isOpen={showReadyToGenerateModal}
                        onClose={() => setShowReadyToGenerateModal(false)}
                        onGenerate={generateAllResponses}
                        isGenerating={isGeneratingAll}
                        generationProgress={generationProgress}
                        rfpAnalysis={getRfpRequirementAnalysis()}
                        customerIntelligence={customerIntelligence}
                        doingsKnowledge={doingsKnowledge}
                        customSkills={customSkills}
                    />

                    {/* ============================================
                        HITL REVIEW MODAL
                        Human-in-the-Loop review and approval of all sections
                        Must approve all before export is allowed
                    ============================================ */}
                    <HITLReviewModal
                        isOpen={showReviewModal}
                        onClose={() => setShowReviewModal(false)}
                        responses={responses}
                        sectionApprovals={sectionApprovals}
                        sectionComments={sectionComments}
                        onApprove={approveSection}
                        onRequestChanges={requestChanges}
                        onResetApproval={resetApproval}
                        onAddComment={addSectionComment}
                        reviewStatus={reviewStatus}
                        onExport={() => { setShowReviewModal(false); exportToWord(responses, evaluations); }}
                    />

                    {/* ============================================
                        CUSTOMER INTEL LOADER MODAL (Fas 1)
                        Generate (via Perplexity web search) or import
                        customer intelligence for all analysis agents
                    ============================================ */}
                    <CustomerIntelLoaderModal
                        isOpen={showCustomerIntelModal}
                        onClose={() => setShowCustomerIntelModal(false)}
                        onLoad={handleLoadCustomerIntel}
                        existingIntel={customerIntelligence}
                        perplexityKey={perplexityKey}
                        apiKey={apiKey}
                        onOpenSettings={() => setShowSettingsModal(true)}
                        rfpDocument={rfpDocument}
                        onUploadRfp={handleRfpFileUpload}
                        onClearRfp={clearRfpDocument}
                        onOpenAgentHub={() => setShowSkillModal(true)}
                    />

                    {/* ============================================
                        STRATEGIC ANALYSIS MODALS (Fas 2)
                        All agents receive customerIntelligence for
                        enhanced, context-aware analysis
                    ============================================ */}
                    <WeaknessAnalysisModal
                        isOpen={showWeaknessModal}
                        onClose={() => setShowWeaknessModal(false)}
                        responses={responses}
                        evaluations={evaluations}
                        apiKey={apiKey}
                        onUpdateResponses={setResponses}
                        customerIntelligence={customerIntelligence}
                    />

                    <CriticalQuestionsModal
                        isOpen={showQuestionsModal}
                        onClose={() => setShowQuestionsModal(false)}
                        responses={responses}
                        evaluations={evaluations}
                        apiKey={apiKey}
                        onUpdateResponses={setResponses}
                        customerIntelligence={customerIntelligence}
                    />

                    <StakeholderMappingModal
                        isOpen={showStakeholderModal}
                        onClose={() => setShowStakeholderModal(false)}
                        responses={responses}
                        apiKey={apiKey}
                        onUpdateResponses={setResponses}
                        customerIntelligence={customerIntelligence}
                    />

                    <ROICalculatorModal
                        isOpen={showROIModal}
                        onClose={() => setShowROIModal(false)}
                        responses={responses}
                        apiKey={apiKey}
                        onUpdateResponses={setResponses}
                        customerIntelligence={customerIntelligence}
                    />

                    <SettingsModal
                        isOpen={showSettingsModal}
                        onClose={() => setShowSettingsModal(false)}
                        apiKey={apiKey}
                        onSaveApiKey={saveApiKey}
                        perplexityKey={perplexityKey}
                        onSavePerplexityKey={savePerplexityKey}
                        onResetAll={handleResetAll}
                    />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('app')).render(<App />);
    </script>
</body>
</html>
